<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>DevOps | 故梦</title><meta name="keywords" content="DevOps,运维"><meta name="author" content="故梦,1187390456@qq.com"><meta name="copyright" content="故梦"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="DevOps"><meta name="application-name" content="DevOps"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="DevOps"><meta property="og:url" content="http://blog.itxcm.cn/posts/Infinity.html"><meta property="og:site_name" content="故梦"><meta property="og:description" content="DevOps"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://img.itxcm.cn/coverImage/1-2k/01/1K-2K%20(219).jpg"><meta property="article:author" content="故梦"><meta property="article:tag" content="生活日常 程序员 后端"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://img.itxcm.cn/coverImage/1-2k/01/1K-2K%20(219).jpg"><link rel="shortcut icon" href="https://img.itxcm.cn/iconfont/favicon1.ico"><link rel="canonical" href="http://blog.itxcm.cn/posts/Infinity"><link rel="preconnect" href="//npm.elemecdn.com"><link rel="preconnect" href="//npm.onmicrosoft.cn"><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google-site-verification" content="xxx"><meta name="baidu-site-verification" content="code-xxx"><meta name="msvalidate.01" content="xxx"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#000000"><link rel="mask-icon" href="/img/siteicon/safari-pinned-tab.svg" color="#5bbad5"><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" sizes="180x180" href="/img/siteicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/favicon-16x16.png"><link rel="bookmark" href="/img/siteicon/apple-icon-180.png"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-2732.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2732-2048.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2388.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2388-1668.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1536-2048.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-1536.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2224.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2224-1668.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1620-2160.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2160-1620.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1290-2796.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2796-1290.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1179-2556.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2556-1179.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1284-2778.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2778-1284.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1170-2532.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2532-1170.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1125-2436.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2436-1125.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2688.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2688-1242.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-828-1792.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1792-828.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2208.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2208-1242.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-750-1334.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1334-750.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-640-1136.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1136-640.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.14/dist/fancybox/fancybox.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload='this.media="all"'><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?f3e16c536fb17ac33cbb892598601b96";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: {"mode":"both","api":"https://img2color-go.vercel.app/api?img=","cover_change":true},
  authorStatus: undefined,
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#3b70fc","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"DevOps",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-07-20 11:58:35",postMainColor:""}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://img.itxcm.cn/avatar/avatar.jpg"><div class="loading-image-dot"></div><div id="loading-percentage">0%</div></div></div><script>if (GLOBAL_CONFIG.preloader.source == "2" || GLOBAL_CONFIG.preloader.source == "3") {
  const loadingPercentage = document.getElementById("loading-percentage");
  let loadingPercentageTimer = setInterval(function() {
    var progressBar = document.querySelector(".pace-progress");
    if (!progressBar) return
    var currentValue = progressBar.getAttribute("data-progress-text");
    if (currentValue !== loadingPercentage.textContent) {
      loadingPercentage.textContent = currentValue;
      if (currentValue === "100%") {
        clearInterval(loadingPercentageTimer);
      }
    }
  }, 100);
}

const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/progress_bar/progress_bar.css"><script async src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div id="web_box"><div id="web_container"><div id="menu-mask"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">个人</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.itxcm.cn/" title="博客" target="_blank"><img class="back-menu-item-icon" src="https://img.itxcm.cn/iconfont/favicon.ico" alt="博客"><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">云服务</div><div class="back-menu-list"><a class="back-menu-item" href="https://www.dogecloud.com" title="多吉云" target="_blank"><img class="back-menu-item-icon" src="https://img.itxcm.cn/iconfont/dogecloud.ico" alt="多吉云"><span class="back-menu-item-text">多吉云</span></a><a class="back-menu-item" href="https://cloud.tencent.com" title="腾讯云" target="_blank"><img class="back-menu-item-icon" src="https://img.itxcm.cn/iconfont/tencentcloud.ico" alt="腾讯云"><span class="back-menu-item-text">腾讯云</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">聊天托管服务</div><div class="back-menu-list"><a class="back-menu-item" href="https://app.crisp.chat" title="crisp" target="_blank"><img class="back-menu-item-icon" src="https://img.itxcm.cn/iconfont/chat1.ico" alt="crisp"><span class="back-menu-item-text">crisp</span></a><a class="back-menu-item" href="https://www.tidio.com" title="tidio" target="_blank"><img class="back-menu-item-icon" src="https://img.itxcm.cn/iconfont/chat2.ico" alt="tidio"><span class="back-menu-item-text">tidio</span></a><a class="back-menu-item" href="https://app.chatra.io" title="chatra" target="_blank"><img class="back-menu-item-icon" src="https://img.itxcm.cn/iconfont/chat3.ico" alt="chatra"><span class="back-menu-item-text">chatra</span></a><a class="back-menu-item" href="http://dashboard.daovoice.io/" title="daovoice" target="_blank"><img class="back-menu-item-icon" src="https://img.itxcm.cn/iconfont/chat3.ico" alt="daovoice"><span class="back-menu-item-text">daovoice</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">评论数据托管服务</div><div class="back-menu-list"><a class="back-menu-item" href="https://console.leancloud.app" title="leancloud" target="_blank"><img class="back-menu-item-icon" src="https://img.itxcm.cn/iconfont/leancloud.ico" alt="leancloud"><span class="back-menu-item-text">leancloud</span></a><a class="back-menu-item" href="https://cloud.mongodb.com" title="mongodb" target="_blank"><img class="back-menu-item-icon" src="https://img.itxcm.cn/iconfont/mongodb.ico" alt="mongodb"><span class="back-menu-item-text">mongodb</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">实用工具</div><div class="back-menu-list"><a class="back-menu-item" href="https://vercel.com" title="Vercel" target="_blank"><img class="back-menu-item-icon" src="https://img.itxcm.cn/iconfont/vercel.ico" alt="Vercel"><span class="back-menu-item-text">Vercel</span></a><a class="back-menu-item" href="https://summary.zhheo.com" title="TianliGPT" target="_blank"><img class="back-menu-item-icon" src="https://img.itxcm.cn/iconfont/tianliGPT.ico" alt="TianliGPT"><span class="back-menu-item-text">TianliGPT</span></a><a class="back-menu-item" href="https://tongji.baidu.com" title="Baidu statistics" target="_blank"><img class="back-menu-item-icon" src="https://img.itxcm.cn/iconfont/statistics.ico" alt="Baidu statistics"><span class="back-menu-item-text">Baidu statistics</span></a><a class="back-menu-item" href="https://sakuracat.link" title="Sakuracat" target="_blank"><img class="back-menu-item-icon" src="https://img.itxcm.cn/iconfont/sakuraCat.ico" alt="Sakuracat"><span class="back-menu-item-text">Sakuracat</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">故梦</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child" style="left:-31px"><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i> <span>分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i> <span>标签</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span>友链</span></a><ul class="menus_item_child" style="left:-31px"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i> <span>友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i> <span>留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child" style="left:-79px"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=8896993428&amp;server=tencent"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i> <span>音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size:.9em"></i> <span>追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i> <span>相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child" style="left:-127px"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i> <span>关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i> <span>闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size:.9em"></i> <span>我的装备</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i> <span>随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button only-home" id="travellings_button" title="随机前往一个开往项目网站"><a class="site-page" onclick="anzhiyu.totraveling()" title="随机前往一个开往项目网站" href="javascript:void(0);" rel="external nofollow" data-pjax-state="external"><i class="anzhiyufont anzhiyu-icon-train"></i></a></div><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i> <span>搜索</span></a></div><input id="center-console" type="checkbox"><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole()"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://img.itxcm.cn/reword/wechat.jpg" target="_blank"><img class="post-qr-code-img" alt="wechat" src="https://img.itxcm.cn/reword/wechat.jpg"></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="https://img.itxcm.cn/reword/apply.jpg" target="_blank"><img class="post-qr-code-img" alt="alipay" src="https://img.itxcm.cn/reword/apply.jpg"></a><div class="post-qr-code-desc">alipay</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"><span>最新评论</span></span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/C/" style="font-size:1.05rem">C#<sup>1</sup></a><a href="/tags/DevOps/" style="font-size:1.05rem">DevOps<sup>1</sup></a><a href="/tags/Hexo/" style="font-size:1.05rem">Hexo<sup>1</sup></a><a href="/tags/Plugins/" style="font-size:1.05rem">Plugins<sup>1</sup></a><a href="/tags/Unity%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size:1.05rem">Unity面试题<sup>4</sup></a><a href="/tags/%E4%BD%9C%E5%93%81%E9%9B%86/" style="font-size:1.05rem">作品集<sup>1</sup></a><a href="/tags/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/" style="font-size:1.05rem">排序算法<sup>1</sup></a><a href="/tags/%E6%97%A5%E5%B8%B8/" style="font-size:1.05rem">日常<sup>1</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size:1.05rem">算法<sup>1</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size:1.05rem">设计模式<sup>1</sup></a><a href="/tags/%E8%BF%90%E7%BB%B4/" style="font-size:1.05rem">运维<sup>1</sup></a></div></div><hr></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">七月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/09/"><span class="card-archive-list-date">九月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/08/"><span class="card-archive-list-date">八月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">3</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/07/"><span class="card-archive-list-date">七月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li></ul></div><hr></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" onclick="anzhiyu.switchDarkMode()" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item on" id="consoleCommentBarrage" onclick="anzhiyu.switchCommentBarrage()" title="热评开关"><a class="commentBarrage"><i class="anzhiyufont anzhiyu-icon-message"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%BF%90%E7%BB%B4/">运维</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/DevOps/" tabindex="-1"><span><i class="anzhiyufont anzhiyu-icon-hashtag"></i> DevOps</span></a><a class="article-meta__tags" href="/tags/%E8%BF%90%E7%BB%B4/" tabindex="-1"><span><i class="anzhiyufont anzhiyu-icon-hashtag"></i> 运维</span></a></span></div></div><h1 class="post-title">DevOps</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-09-16T13:23:44.000Z" title="发表于 2023-09-16 13:23:44">2023-09-16</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-20T11:58:35.188Z" title="更新于 2024-07-20 11:58:35">2024-07-20</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">12k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>48分钟</span></span><span class="post-meta-separator"></span><span data-flag-title="DevOps"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="twikoo_visitors" title="访问量"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator"></span><span class="post-meta-position" title="作者IP属地为武汉"><i class="anzhiyufont anzhiyu-icon-location-dot"></i> 武汉</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/posts/Infinity.html#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s58 18 88 18 58-18 88-18 58 18 88 18v44h-352Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://img.itxcm.cn/coverImage/1-2k/01/1K-2K%20(219).jpg"></div></header><main class="layout" id="content-inner"><div id="post"><div class="post-ai-description"><div class="ai-title"><i class="anzhiyufont anzhiyu-icon-bilibili"></i><div class="ai-title-text">AI-摘要</div><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i><div id="ai-tag">Tianli GPT</div></div><div class="ai-explanation">AI初始化中...</div><div class="ai-btn-box"><div class="ai-btn-item">介绍自己</div><div class="ai-btn-item">生成本文简介</div><div class="ai-btn-item">推荐相关文章</div><div class="ai-btn-item">前往主页</div><div class="ai-btn-item" id="go-tianli-blog">前往tianli博客</div></div><script data-pjax>(function(){
  // 当前随机到的ai摘要到index
  let lastAiRandomIndex = -1;
  let animationRunning = true; // 标志变量，控制动画函数的运行
  // 当前gpt模式
  let mode = "tianli"
  // 刷新点击次数
  let refreshNum = 0
  // 记录上一次传递给aiAbstract的参数
  let prevParam;
  const aiTitleRefreshIcon = document.querySelector(".ai-title .anzhiyufont.anzhiyu-icon-arrow-rotate-right")
  const explanation = document.querySelector(".ai-explanation");
  const post_ai = document.querySelector(".post-ai-description");
  let ai_str = "";
  let ai_str_length = "";
  let delay_init = 600;
  let i = 0;
  let j = 0;
  let sto = [];
  let elapsed = 0;
  const animate = timestamp => {
    if (!animationRunning) {
      return; // 动画函数停止运行
    }
    if (!animate.start) animate.start = timestamp;
    elapsed = timestamp - animate.start;
    if (elapsed >= 20) {
      animate.start = timestamp;
      if (i < ai_str_length - 1) {
        let char = ai_str.charAt(i + 1);
        let delay = /[,.，。!?！？]/.test(char) ? 150 : 20;
        if (explanation.firstElementChild) {
          explanation.removeChild(explanation.firstElementChild);
        }
        explanation.innerHTML += char;
        let div = document.createElement("div");
        div.className = "ai-cursor";
        explanation.appendChild(div);
        i++;
        if (delay === 150) {
          document.querySelector(".ai-explanation .ai-cursor").style.opacity = "0";
        }
        if (i === ai_str_length - 1) {
          observer.disconnect(); // 暂停监听
          explanation.removeChild(explanation.firstElementChild);
        }
        sto[0] = setTimeout(() => {
          requestAnimationFrame(animate);
        }, delay);
      }
    } else {
      requestAnimationFrame(animate);
    }
  };
  const observer = new IntersectionObserver(
    entries => {
      let isVisible = entries[0].isIntersecting;
      animationRunning = isVisible; // 标志变量更新
      if (animationRunning) {
        delay_init = i === 0 ? 200 : 20;
        sto[1] = setTimeout(() => {
          if (j) {
            i = 0;
            j = 0;
          }
          if (i === 0) {
            explanation.innerHTML = ai_str.charAt(0);
          }
          requestAnimationFrame(animate);
        }, delay_init);
      }
    },
    { threshold: 0 }
  );
  function clearSTO() {
    if (sto.length) {
      sto.forEach(item => {
        if (item) {
          clearTimeout(item);
        }
      });
    }
  }
  function startAI(str, df = true) {
    i = 0; //重置计数器
    j = 1;
    clearSTO();
    animationRunning = false;
    elapsed = 0;
    observer.disconnect(); // 暂停上一次监听
    explanation.innerHTML = df ? "生成中. . ." : "请等待. . .";
    ai_str = str;
    ai_str_length = ai_str.length;
    observer.observe(post_ai); //启动新监听
  }

  async function aiAbstract(num = 1000) {
    i = 0; //重置计数器
    j = 1;
    clearSTO();
    animationRunning = false;
    elapsed = 0;
    observer.disconnect(); // 暂停上一次监听
    if (mode === "tianli") {
      num = Math.max(10, Math.min(2000, num));
      const options = {
        key: "a6d07db51409480807e4",
        Referer: "https://blog.itxcm.cn"
      };
      const truncateDescription = ("DevOps" + "DevOps 介绍, Code 阶段工具, Docker 安装, Git 安装, GitLab 安装, Build 阶段工具, Operate 阶段工具, Docker 安装, Docker-Compose 安装, Integrate 工具, Jenkins 介绍, Jenkins 安装, Jenkins 入门配置, 构建任务, 配置源码拉取地址, 配置 Maven 构建代码, 配置 Publish 发布amp远程操作, CI、CD 入门操作, 持续集成, 持续交付、部署, 集成 Sonar Qube, Sonar Qube 介绍, Sonar Qube 环境搭建, Sonar Qube 安装, 安装中文插件, Sonar Qube 基本使用, Maven 实现代码检测, Sonar-scanner 实现代码检测, Jenkins 集成 Sonar Qube, Jenkins 安装插件, Jenkins 配置 Sonar Qube, 配置 Sonar-scanner, 构建任务, 集成 Harbor, Harbor 介绍, Harbor 安装, Harbor 使用方式, 添加用户构建项目, 发布镜像到 Harbor, 从 Harbor 拉取镜像 ls, Jenkins 容器使用宿主机 Docker, 添加构建操作, 编写部署脚本, 配置构建后操作, Jenkins 流水线, Jenkins 流水线任务介绍, Jenkins 流水线任务, 构建 Jenkins 流水线任务, Groovy 脚本, Jenkinsfile 实现, Jenkins 流水线任务实现, 参数化构建, 拉取 Git 代码, 构建代码, 代码质量检测, 制作自定义镜像并发布, Jenkins 流水线整合钉钉, Kubernetes 介绍, Kubernetes 架构, Kubernetes 安装, Kubernetes 操作, Namespace, Pod, Deployment, Service, Ingress, Jenkins 集成 Kubernetes, 准备部署的 yml 文件, Harbor 私服配置, 测试使用效果, Jenkins 远程调用, 基于 GitLab 的 WebHooks, WebHooks 通知, 修改配置, 滚动更新, 注意点转载来自不想当短发少女了介绍软件开发最开始是由两个团队组成开发计划由开发团队从头开始设计和整体系统的构建需要系统不停的迭代更新运维团队将开发团队的进行测试后部署上线希望系统稳定安全运行这看似两个目标不同的团队需要协同完成一个软件的开发在开发团队指定好计划并完成后需要提供到运维团队运维团队向开发团队反馈需要修复的以及一些需要返工的任务这时开发团队需要经常等待运维团队的反馈这无疑延长了事件并推迟了整个软件开发的周期会有一种方式在开发团队等待的时候让开发团队转移到下一个项目中等待运维团队为之前的代码提供反馈可是这样就意味着一个完整的项目需要一个更长的周期才可以开发出最终代码基于现在的互联网现状更推崇敏捷式开发这样就导致项目的迭代速度更快但是由于开发团队与运维团队的沟通问题会导致新版本上线的时间成本很高这又违背的敏捷式开发的最初的目的那么如果让开发团队和运维团队整合到成一个团队协同应对一套软件呢这就被称为字面意思是的缩写也就是开发运维虽然字面意思只涉及到了开发团队和运维团队其实测试团队也是参与其中的网上可以查看到的符号类似于一个无穷大的符号这表明是一个不断提高效率并且持续不断工作的过程的方式可以让公司能够更快地应对更新和市场发展变化开发可以快速交付部署也更加稳定核心就在于简化和团队之间的流程使整体软件开发过程更快速整体的软件开发流程包括开发团队根据客户的目标制定开发计划根据开始编码过程需要将不同版本的代码存储在一个库中编码完成后需要将代码构建并且运行成功构建项目后需要测试代码是否存在或错误代码经过手动测试和自动化测试后认定代码已经准备好部署并且交给运维团队运维团队将代码部署到生产环境中项目部署上线后需要持续的监控产品然后将监控阶段收到的反馈发送回阶段整体反复的流程就是的核心即持续集成持续部署为了保证整体流程可以高效的完成各个阶段都有比较常见的工具如下图软件开发过程涉及工具最终可以给下一个定义强调的是高效组织团队之间如何通过自动化的工具协作和沟通来完成软件的生命周期管理从而更快更频繁地交付更稳定的软件自动化的工具协作和沟通来完成软件的生命周期管理阶段工具在阶段我们需要将不同版本的代码存储到一个仓库中常见的版本控制工具就是或者这里我们采用作为版本控制工具作为远程仓库安装参考安装方案参考方案安装安装地址安装单独准备服务器采用安装查看镜像拉取镜像准备文件启动容器需要稍等一小会访问首页首页查看用户初始密码初始密码登录用户登录成功后跳转页面第一次登录后需要修改密码修改密码搞定后即可像一样使用阶段工具构建项目的工具一般有两种选择一个是一个是这里我们选择作为项目的编译工具具体安装流程不做阐述但是需要确保配置好仓库私服以及编译版本阶段工具部署过程会采用进行部署暂时只安装即可后续还需安装安装准备测试环境生产环境下载依赖组件设置下载的镜像源为阿里云安装服务安装成功后启动并设置开机自启启动服务设置开机自动启动测试安装成功效果安装下载将下载好的文件移动到操作系统设置文件权限并移动到目录中设置文件权限移动到目录下并重命名为测试安装成功效果工具持续集成持续部署的工具很多其中是一个开源的持续集成平台涉及到将编写完毕的代码发布到测试环境和生产环境的任务并且还涉及到了构建项目等任务需要大量的插件保证工作安装成本较高下面会基于搭建介绍是一个开源软件项目是基于开发的一种持续集成工具应用广泛大多数互联网公司都采用配合作为实现的核心工具最强大的就在于插件官方提供了大量的插件库来自动化过程中的各种琐碎功能最主要的工作就是将上可以构建的工程代码拉取并且进行构建再根据流程可以选择发布到测试环境或是生产环境一般是上的代码经过大量的测试后确定发行版本再发布到生产环境可以理解为过程即是通过将代码拉取构建制作镜像交给测试人员测试持续集成让软件代码可以持续的集成到主干上并自动构建和测试过程即是通过将打好标签的发行版本代码拉取构建制作镜像交给运维人员部署持续交付让经过持续集成的代码可以进行手动部署持续部署让可以持续交付的代码随时随地的自动化部署安装拉取镜像编写首次启动会因为数据卷目录没有权限导致启动失败设置目录写权限错误日志重新启动容器后由于需要下载大量内容但是由于默认下载地址下载速度较慢需要重新设置下载地址为国内镜像站修改数据卷中的文件将下载地址替换为清华大学的插件源也可以再次重启容器访问需要稍微等会首页查看密码登录并登录下载插件登录并下载插件选择需要安装的插件选择需要安装的插件下载完毕设置信息进入首页可能会出现下载失败的插件入门配置由于需要从拉取代码需要本地构建甚至需要直接发布自定义镜像到仓库所以需要配置大量内容构建任务准备好仓库中的项目并且通过配置项目的实现当前项目的基本流程构建工程发布到均可查看项目点击左侧导航新建任务新建任务选择自由风格构建任务构建任务配置源码拉取地址需要将上存放的源码存储到服务所在磁盘的本地配置任务源码拉取的地址源码管理立即构建点击任务中的立即构建查看构建工程的日志点击上述的任务条即可查看任务拉取源码日志可以看到源码已经拉取带本地可以根据第三行日志信息查看本地拉取到的源码查看容器中的源码源码存放位置配置构建代码代码拉取到本地后需要在中对代码进行构建这里需要的环境而需要的环境接下来需要在中安装和并且配置到服务准备压缩包通过数据卷映射到容器内部数据卷存放位置解压压缩包并配置的阿里云镜像地址编译插件配置并保存配置任务构建代码配置构建代码立即构建测试查看下的包构建源码配置发布远程操作包构建好之后就可以根据情况发布到测试或生产环境这里需要用到之前下载好的插件配置连接测试生产环境配置配置任务的构建后操作发布包到目标服务配置构建后操作立即构建任务并去目标服务查看立即构建入门操作基于拉取的代码进行构建发布到测试环境实现持续集成基于拉取指定发行版本的代码进行构建发布到生产环境实现实现持续部署持续集成为了让程序代码可以自动推送到测试环境基于服务运行需要添加配置和脚本文件让程序可以在集成到主干的同时运行起来添加文件构建自定义镜像添加文件加载自定义镜像启动容器追加构建后操作脚本命令构建后发布并执行脚本命令发布到后由立即构建并托送到目标服务器构建日志测试部署到目标服务器程序查看目标服务器并测试接口持续交付部署程序代码在经过多次集成操作到达最终可以交付持续交付整体流程和持续集成类似不过需要选取指定的发行版本下载插件下载设置项目参数化构建基于标签构建给项目添加版本添加版本任务构建时采用方式构建拉取指定版本代码切换指定标签并构建项目基于构建任务任务发布到目标服务器构建任务集成介绍是一个开源的代码分析平台支持等种以上的语言可以检测出重复代码代码漏洞代码规范和安全性漏洞的问题可以与多种软件整合进行代码扫描比如等并且会将代码检测结果推送回并且在系统提供的界面上显示出来的界面环境搭建安装在版本中已经放弃了对的支持并且建议在商业环境中采用那么安装时需要依赖并且这里会安装的长期支持版本拉取镜像编写启动容器需要设置文件信息设置并执行命令刷新重新启动需要一定时间启动可以可以查看容器日志看到如下内容代表启动成功容器日志访问首页登录还需要重新设置一次密码重新设置密码首页首页安装中文插件安装中文插件安装成功后需要重启安装失败重新点击重装即可安装成功后会查看到重启按钮点击即可重启按钮重启后查看效果首页效果基本使用的使用方式很多可以整合也可以采用的方式再查看的检测效果实现代码检测修改的文件配置信息在代码位置执行命令执行代码检测查看界面检测结果检测结果实现代码检测下载下载版本即可要求版本解压并配置服务端信息由于是压缩包需要安装解压插件解压压缩包配置服务端地址修改下的配置服务端信息执行命令检测代码在项目所在目录执行以下命令主要查看我的执行命令的位置查看日志信息查看界面检测结果检测结果集成继承实现代码扫描需要先下载整合插件安装插件下载插件配置开启权限验证开启权限校验获取的令牌获取令牌配置的信息配置将添加到数据卷中并配置全局配置配置配置任务的配置任务的构建任务构建任务集成介绍前面在部署项目时我们主要采用推送包到指定服务器再通过脚本命令让目标服务器对当前进行部署这种方式在项目较多时每个目标服务器都需要将包制作成自定义镜像再通过进行启动重复操作比较多会降低项目部署时间我们可以通过作为私有的镜像仓库让统一将项目打包并制作成镜像发布到仓库中只需要通知目标服务让目标服务统一去仓库上拉取镜像并在本地部署即可官方提供了镜像仓库但是的功能相对简陋是公司提供的一款镜像仓库提供了权限控制分布式发布强大的安全扫描与审查机制等功能安装这里采用原生的方式安装下载安装包拖拽到并解压修改配置文件首先复制一份配置编辑配置文件配置文件启动查看日志登录登录首页信息首页信息使用方式作为镜像仓库主要的交互方式就是将镜像上传到上以及从上下载指定镜像在传输镜像前可以先使用提供的权限管理将项目设置为私有项目并对不同用户设置不同角色从而更方便管理镜像添加用户构建项目创建用户创建用户构建项目设置为私有构建项目给项目追加用户追加用户管理切换测试用户切换测试用户发布镜像到修改镜像名称名称要求地址项目名镜像名版本修改镜像名称修改支持仓库并重启修改支持仓库设置登录仓库信息用户名密码地址推送镜像到推送镜像到从拉取镜像跟传统方式一样不过需要先配置文件拉取镜像容器使用宿主机构建镜像和发布镜像到都需要使用到命令而在容器内部安装官方推荐直接采用宿主机带的即可设置容器使用宿主机设置宿主机权限添加数据卷添加构建操作制作自定义镜像编写部署脚本部署项目需要通过插件让目标服务器执行命令为了方便一次性实现拉取镜像和启动的命令推荐采用脚本文件的方式添加脚本文件到目标服务器再通过插件让目标服务器执行脚本即可编写脚本文件添加到目标服务器并设置权限为可执行如图配置构建后操作执行脚本文件流水线流水线任务介绍之前采用的自由风格构建的项目每个步骤流程都要通过不同的方式设置并且构建过程中整体流程是不可见的无法确认每个流程花费的时间并且问题不方便定位问题的可以让项目的发布整体流程可视化明确执行的阶段可以快速的定位问题并且整个项目的生命周期可以通过一个文件管理而且文件是可以放在项目中维护所以相对自由风格或者其他的项目风格更容易操作流水线任务构建流水线任务构建任务构建流水线任务生成脚本脚本生成构建后查看视图构建后查看视图脚本脚本基础语法所有脚本命令包含在中指定任务在哪个节点执行支持分布式配置全局环境指定变量名变量值信息存放所有任务的合集单个任务任务实现任务的具体流程单个任务任务实现任务的具体流程编写例子测试存放所有任务的合集拉取代码拉取代码检测代码质量检测代码质量构建代码构建代码制作自定义镜像并发布制作自定义镜像并发布基于部署工程基于部署工程配置脚本查看效果查看效果涉及到特定脚本给予了充足的提示可以自动生成命令生成命令位置实现方式需要将脚本内容编写到项目中的文件中每次构建会自动拉取项目并且获取项目中文件对项目进行构建配置配置准备准备文件测试效果测试效果流水线任务实现参数化构建添加参数化构建方便选择不的项目版本参数化构建拉取代码通过流水线语法生成代码的脚本语法生成将更改为标签拉取代码构建代码通过脚本执行的构建命令拉取代码构建代码代码质量检测通过脚本执行命令即可拉取代码构建代码检测代码质量制作自定义镜像并发布生成自定义镜像脚本存放所有任务的合集拉取代码构建代码检测代码质量制作自定义镜像并发布生成脚本存放所有任务的合集拉取代码构建代码检测代码质量制作自定义镜像并发布目标服务器拉取镜像并运行由于采用变量记得使用双引号流水线整合钉钉在程序部署成功后可以通过钉钉的机器人及时向群众发送部署的最终结果通知安装插件安装插件钉钉内部创建群组并构建机器人钉钉内部创建群组并构建机器人最终或获取到信息系统配置添加钉钉通知配置钉钉通知任务中追加流水线配置拉取代码构建代码检测代码制作自定义镜像推送自定义镜像通知目标服务器成功构建项目版本持续时间任务失败构建项目版本持续时间任务查看效果钉钉通知效果十编排工具介绍是一个开源的用于管理云平台中多个主机上的容器化的应用的目标是让部署容器化的应用简单并且高效提供了应用部署规划更新维护的一种机制一个核心的特点就是能够自主的管理容器来保证云平台中的容器按照用户的期望状态运行着管理员可以加载一个微型服务让规划器来找到合适的位置同时也系统提升工具以及人性化方面让用户能够方便的部署自己的应用主要能帮助我们完成服务发现和负载均衡可以使用名称或自己的地址公开容器如果进入容器的流量很大可以负载均衡并分配网络流量从而使部署稳定存储编排允许你自动挂载你选择的存储系统比如本地存储类似的数据卷自动部署和回滚你可以使用描述已部署容器的所需状态它可以以受控的速率将实际状态更改为期望状态会自动帮你根据情况部署创建新容器并删除现有容器给新容器提供资源自动完成装箱计算允许你设置每个容器的资源比如和内存自我修复重新启动失败的容器替换容器杀死不响应用户定义的容器并运行状况检查的容器秘钥与配置管理允许你存储和管理敏感信息例如密码令牌和密钥你可以在不重建容器镜像的情况下部署和更新密钥和应用程序配置也无需在堆栈配置中暴露密钥架构搭建需要至少两个节点一个负责管理一个搭建在工作服务器上负责分配架构从图中可以看到各个组件的基本功能作为通讯的核心组件内部交互以及接收发送指令的组件作为的核心组件主要做资源调度根据集群情况分配资源一个的数据库存储存储集群的状态信息负责调度每个工作节点负责调度其他云服务产品管理上面的容器负责处理其他或客户端的请求可以理解为就是运行的容器安装这里会采用提供的方式安装安装单节点要求使用版本至少台核的服务器安装流程安装流程准备好服务器后开始安装重新设置不允许为修改名字不允许使用下划线小数点大写字母不能叫查看修改结果设置解析要求台服务之间可以相互通讯安装软件阿里云镜像首先初始化节点关于初始化时用到的环境变量不能是的必须全为小写字母数字小数点不能包含减号所使用的网段不能与节点节点所在的网段重叠该字段的取值为一个值如果您对这个概念还不熟悉请仍然执行命令不做修改设置域名网段并执行初始化操作只在节点执行替换为节点实际请使用内网命令只在当前会话中有效开启新的窗口后如果要继续安装过程请重新执行此处的命令替换为您想要的容器组所在的网段该网段安装完成后由创建事先并不存在于您的物理网络中检查启动状态只在节点执行执行如下命令等待分钟直到所有的容器组处于状态查看节点初始化结果如果出现的情况执行最新版本的一般没有安装网络服务插件初始化节点获取命令参数在节点执行只在节点执行获取命令在节点初始化只在节点执行替换为节点的内网替换为初始化节点时所使用的替换为节点上命令的输出检查最终运行效果在节点上执行只在节点执行如果出现的情况执行最新版本的一般没有输出结果如下所示搭建成功效果安装管理集群安装您也可以使用下面的指令唯一的区别是该指令使用华为云的镜像仓库替代分发所需要的镜像查看启动情况查看效果在浏览器中打开链接首页输入初始用户名和密码并登录用户名密码首页效果操作首先我们要了解在运行我们的资源时关联到了哪些内容资源的构建方式采用的命令方式文件方式命名空间主要是为了对中运行的资源进行过隔离但是网络是互通的类似的容器可以将多个资源配置到一个中而可以对不同环境进行资源隔离默认情况下提供了命名空间在构建资源时如果不指定资源默认采用资源命令方式查看现有的全部命名空间构建命名空间命名空间名称删除现有命名空间并且会删除空间下的全部资源命名空间名称文件方式构建资源时设置命名空间运行的一组容器是的最小单位但是对于而然中会运行多个容器命令方式查看所有运行的查看指定下的命名空间默认创建名称镜像名称查看详细信息名称删除名称命名空间默认查看输出的日志名称进去容器内部名称查看给分配的信息并且通过和容器的端口可以直接访问方式推荐运行的名称名称命名空间镜像名称容器名称启动文件名称删除文件名称中运行多个容器运行的名称名称命名空间镜像名称容器名称镜像名称容器名称启动后可以查看到效果部署时可以通过管理和编排部署实现命令方式基于启动容器名称镜像名称用启动的容器会在被删除后自动再次创建达到故障漂移的效果需要使用的方式删除查看现在的删除名称基于启动容器并设置集群数名称镜像名称集群个数配置文件方式正常使用运行即可弹性伸缩功能基于实现弹性伸缩名称集群个数或者修改文件名称图形化页面修改灰度发布可以在部署新版本数据时成功启动一个才会下线一个老版本的名称容器名镜像版本可以将多个对外暴露一个让客户端可以通过访问到这一组并且可以实现负载均衡方式是集群内部之间的访问方式命令实现效果通过生成映射一个下的所有中的某一个端口的容器名称端口号内容器端口之后通过查看提供的即可访问也可以通过名称名称作为域名访问在服务容器内执行方式的方式只能在内部实现访问但是一般需要对外暴露网关所以需要的方式外暴露访问命令实现方式通过生成映射一个下的所有中的某一个端口的容器名称端口号内容器端口查看效果也可以通过文件实现通过启动就也可以创建测试效果部署通过暴露可以查看到暴露的信息信息推荐将作为所有的入口提供统一的入口避免多个服务之间需要记录大量的或者域名毕竟可能改变服务太多域名记录不方便底层其实就是一个可以在上直接点击安装安装因为副本数默认为但是整体集群就个节点所以显示下面即为安装成功安装成功可以将接收到的请求转发到不同的中推荐使用文件方式启动时问题安装的有的校验配置需要先删除配置再启动找到指定的的校验信息删除即可删除信息查看校验的配置删除指定的校验配置本地文件配置记下来既可以访问在中暴露的信息服通过访问集成准备部署的文件私服配置在尝试用的文件启动服务时会出现无法拉取镜像的问题这里需要在所在的中配置服务信息并且保证可以拉取上的镜像设置和的私服地址信息设置私服地址在上设置私服密文信息设置密文并测试按照复制指令的位置测试认证效果如下测试效果测试使用效果执行命令基于启动服务并且基于部署后服务的提示信息以及的设置直接访问远程调用将配置到中配置文件配置的目标服务器可以将文件传输到的上设置目标服务器修改重新设置流水线任务脚本并测试效果传递文件脚本设置无密码登录将中公钥信息复制到的中保证远程连接无密码远程执行命令无需密码设置执行的脚本到设置执行查看效果执行流水线可以查看到文件是由变化的这样就会重新加载查看效果效果这种方式更适应与操作将项目将基于某个版本部署到指定的目标服务器基于的这里要实现自动化的一个操作也就是开发人员代码到仓库后会自动的构建项目将最新的提交点代码构建并进行打包部署这里区别去上述的操作操作需要基于某个版本进行部署而这里每次都是将最新的提交点集成到主干上并测试通知开启的自动构建构建触发器设置的设置的需要关闭的认证关闭的认证再次测试再次测试修改配置修改实现基于最新提交点实现持续集成效果将之前引用的全部去掉所有的脚本命令都放在中指定任务再哪个集群节点中执行声明全局变量方便后面使用拉取仓库代码通过构建项目通过做代码质量检测通过制作自定义镜像将自定义镜像推送到将文件传到上远程执行的命令成功构建版本持续时间构建失败版本持续时间修改更改镜像版本这里省略其他内容滚动更新因为没有改变时每次不会重新加载这样会导致中的容器不会动态更新这里需要使用的命令滚动更新设置注意点安装的一定要是最新版本的不然很多插件无法安装安装的插件").trim().substring(0, num)

      const queryParams = `key=${options.key}&content=${truncateDescription}`;
      const requestOptions = {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          Referer: options.Referer
        },
      };
      try {
        let animationInterval = null
        if (animationInterval) clearInterval(animationInterval);
        animationInterval = setInterval(() => {
          const animationText = "生成中" + ".".repeat(j);
          explanation.innerHTML = animationText;
          j = (j % 3) + 1; // 在 1、2、3 之间循环
        }, 500);
        const response = await fetch(`https://summary.tianli0.top/?${queryParams}`, requestOptions);
        let result;
        if (response.status === 403) {
          result = {
            summary: "403 refer与key不匹配，本地无法显示。"
          }
        } else if (response.status === 500) {
          result = {
            summary: "500 系统内部错误"
          }
        } else {
          result = await response.json();
        }
        const summary = result.summary.trim();
        setTimeout(() => {
          aiTitleRefreshIcon.style.opacity = "1";
        }, 300)
        startAI(summary);
        clearInterval(animationInterval)
      } catch (error) {
        console.error(error);
        explanation.innerHTML = "发生异常" + error;
      }
    } else {
      const strArr = "true".split(",").map(item => item.trim()); // 将字符串转换为数组，去除每个字符串前后的空格
      if (strArr.length !== 1) {
        let randomIndex = Math.floor(Math.random() * strArr.length); // 随机生成一个索引
        while (randomIndex === lastAiRandomIndex) { // 如果随机到了上次的索引
          randomIndex = Math.floor(Math.random() * strArr.length); // 再次随机
        }
        lastAiRandomIndex = randomIndex; // 更新上次随机到的索引
        startAI(strArr[randomIndex]);
      } else {
        startAI(strArr[0])
      }
      setTimeout(() => {
        aiTitleRefreshIcon.style.opacity = "1";
      }, 600)
    }
  }

  function aiRecommend() {
    i = 0; //重置计数器
    j = 1;
    clearSTO();
    animationRunning = false;
    elapsed = 0;
    explanation.innerHTML = "生成中. . .";
    ai_str = "";
    ai_str_length = "";
    observer.disconnect(); // 暂停上一次监听
    sto[2] = setTimeout(() => {
      explanation.innerHTML = recommendList();
    }, 600);
  }
  function aiGoHome() {
    startAI("正在前往博客主页...", false);
    sto[2] = setTimeout(() => {
      pjax.loadUrl("/");
    }, 1000);
  }
  const ai_btn_item = document.querySelectorAll(".ai-btn-item");
  function Introduce() {
    if (mode == "tianli") {
      startAI("我是文章辅助AI: TianliGPT，点击下方的按钮，让我生成本文简介、推荐相关文章等。")
    } else {
      startAI("我是文章辅助AI: 故梦 GPT，点击下方的按钮，让我生成本文简介、推荐相关文章等。")
    }
  }
  function aiTitleRefreshIconClick() {
    aiTitleRefreshIcon.click()
  }
  const aiFunctions = [Introduce, aiTitleRefreshIconClick, aiRecommend, aiGoHome];
  ai_btn_item.forEach((item, index) => {
    item.addEventListener("click", () => {
      aiFunctions[index]();
    });
  });

  function recommendList() {
    let thumbnail = document.querySelectorAll('.relatedPosts-list a');
    if (!thumbnail.length) {
      const cardRecentPost = document.querySelector('.card-widget.card-recent-post'); 
      if (!cardRecentPost) return '';

      thumbnail = cardRecentPost.querySelectorAll('.aside-list-item a');

      let list = '';
      for (let i = 0; i < thumbnail.length; i++) {
        const item = thumbnail[i];
        list += `<div class="ai-recommend-item"><span class="index">${i + 1}：</span><a href="javascript:;" onclick="pjax.loadUrl('${item.href}')" title="${item.title}" data-pjax-state="">${item.title}</a></div>`;
      }
      
      return `很抱歉，无法找到类似的文章，你也可以看看本站最新发布的文章：<br /><div class="ai-recommend">${list}</div>`;
    }

    let list = '';
    for (let i = 0; i < thumbnail.length; i++) {
      const item = thumbnail[i];
      list += `<div class="ai-recommend-item"><span>推荐${i + 1}：</span><a href="javascript:;" onclick="pjax.loadUrl('${item.href}')" title="${item.title}" data-pjax-state="">${item.title}</a></div>`;
    }

    return `推荐文章：<br /><div class="ai-recommend">${list}</div>`;
  }


  function changeShowMode() {
    if (mode === "tianli") {
      mode = "local";
      document.getElementById("ai-tag").innerHTML = "故梦 GPT";
      aiAbstract(1000);
    } else {
      mode = "tianli";
      document.getElementById("ai-tag").innerHTML = "Tianli GPT";

      const truncateDescription = ("" + "DevOps 介绍, Code 阶段工具, Docker 安装, Git 安装, GitLab 安装, Build 阶段工具, Operate 阶段工具, Docker 安装, Docker-Compose 安装, Integrate 工具, Jenkins 介绍, Jenkins 安装, Jenkins 入门配置, 构建任务, 配置源码拉取地址, 配置 Maven 构建代码, 配置 Publish 发布amp远程操作, CI、CD 入门操作, 持续集成, 持续交付、部署, 集成 Sonar Qube, Sonar Qube 介绍, Sonar Qube 环境搭建, Sonar Qube 安装, 安装中文插件, Sonar Qube 基本使用, Maven 实现代码检测, Sonar-scanner 实现代码检测, Jenkins 集成 Sonar Qube, Jenkins 安装插件, Jenkins 配置 Sonar Qube, 配置 Sonar-scanner, 构建任务, 集成 Harbor, Harbor 介绍, Harbor 安装, Harbor 使用方式, 添加用户构建项目, 发布镜像到 Harbor, 从 Harbor 拉取镜像 ls, Jenkins 容器使用宿主机 Docker, 添加构建操作, 编写部署脚本, 配置构建后操作, Jenkins 流水线, Jenkins 流水线任务介绍, Jenkins 流水线任务, 构建 Jenkins 流水线任务, Groovy 脚本, Jenkinsfile 实现, Jenkins 流水线任务实现, 参数化构建, 拉取 Git 代码, 构建代码, 代码质量检测, 制作自定义镜像并发布, Jenkins 流水线整合钉钉, Kubernetes 介绍, Kubernetes 架构, Kubernetes 安装, Kubernetes 操作, Namespace, Pod, Deployment, Service, Ingress, Jenkins 集成 Kubernetes, 准备部署的 yml 文件, Harbor 私服配置, 测试使用效果, Jenkins 远程调用, 基于 GitLab 的 WebHooks, WebHooks 通知, 修改配置, 滚动更新, 注意点转载来自不想当短发少女了介绍软件开发最开始是由两个团队组成开发计划由开发团队从头开始设计和整体系统的构建需要系统不停的迭代更新运维团队将开发团队的进行测试后部署上线希望系统稳定安全运行这看似两个目标不同的团队需要协同完成一个软件的开发在开发团队指定好计划并完成后需要提供到运维团队运维团队向开发团队反馈需要修复的以及一些需要返工的任务这时开发团队需要经常等待运维团队的反馈这无疑延长了事件并推迟了整个软件开发的周期会有一种方式在开发团队等待的时候让开发团队转移到下一个项目中等待运维团队为之前的代码提供反馈可是这样就意味着一个完整的项目需要一个更长的周期才可以开发出最终代码基于现在的互联网现状更推崇敏捷式开发这样就导致项目的迭代速度更快但是由于开发团队与运维团队的沟通问题会导致新版本上线的时间成本很高这又违背的敏捷式开发的最初的目的那么如果让开发团队和运维团队整合到成一个团队协同应对一套软件呢这就被称为字面意思是的缩写也就是开发运维虽然字面意思只涉及到了开发团队和运维团队其实测试团队也是参与其中的网上可以查看到的符号类似于一个无穷大的符号这表明是一个不断提高效率并且持续不断工作的过程的方式可以让公司能够更快地应对更新和市场发展变化开发可以快速交付部署也更加稳定核心就在于简化和团队之间的流程使整体软件开发过程更快速整体的软件开发流程包括开发团队根据客户的目标制定开发计划根据开始编码过程需要将不同版本的代码存储在一个库中编码完成后需要将代码构建并且运行成功构建项目后需要测试代码是否存在或错误代码经过手动测试和自动化测试后认定代码已经准备好部署并且交给运维团队运维团队将代码部署到生产环境中项目部署上线后需要持续的监控产品然后将监控阶段收到的反馈发送回阶段整体反复的流程就是的核心即持续集成持续部署为了保证整体流程可以高效的完成各个阶段都有比较常见的工具如下图软件开发过程涉及工具最终可以给下一个定义强调的是高效组织团队之间如何通过自动化的工具协作和沟通来完成软件的生命周期管理从而更快更频繁地交付更稳定的软件自动化的工具协作和沟通来完成软件的生命周期管理阶段工具在阶段我们需要将不同版本的代码存储到一个仓库中常见的版本控制工具就是或者这里我们采用作为版本控制工具作为远程仓库安装参考安装方案参考方案安装安装地址安装单独准备服务器采用安装查看镜像拉取镜像准备文件启动容器需要稍等一小会访问首页首页查看用户初始密码初始密码登录用户登录成功后跳转页面第一次登录后需要修改密码修改密码搞定后即可像一样使用阶段工具构建项目的工具一般有两种选择一个是一个是这里我们选择作为项目的编译工具具体安装流程不做阐述但是需要确保配置好仓库私服以及编译版本阶段工具部署过程会采用进行部署暂时只安装即可后续还需安装安装准备测试环境生产环境下载依赖组件设置下载的镜像源为阿里云安装服务安装成功后启动并设置开机自启启动服务设置开机自动启动测试安装成功效果安装下载将下载好的文件移动到操作系统设置文件权限并移动到目录中设置文件权限移动到目录下并重命名为测试安装成功效果工具持续集成持续部署的工具很多其中是一个开源的持续集成平台涉及到将编写完毕的代码发布到测试环境和生产环境的任务并且还涉及到了构建项目等任务需要大量的插件保证工作安装成本较高下面会基于搭建介绍是一个开源软件项目是基于开发的一种持续集成工具应用广泛大多数互联网公司都采用配合作为实现的核心工具最强大的就在于插件官方提供了大量的插件库来自动化过程中的各种琐碎功能最主要的工作就是将上可以构建的工程代码拉取并且进行构建再根据流程可以选择发布到测试环境或是生产环境一般是上的代码经过大量的测试后确定发行版本再发布到生产环境可以理解为过程即是通过将代码拉取构建制作镜像交给测试人员测试持续集成让软件代码可以持续的集成到主干上并自动构建和测试过程即是通过将打好标签的发行版本代码拉取构建制作镜像交给运维人员部署持续交付让经过持续集成的代码可以进行手动部署持续部署让可以持续交付的代码随时随地的自动化部署安装拉取镜像编写首次启动会因为数据卷目录没有权限导致启动失败设置目录写权限错误日志重新启动容器后由于需要下载大量内容但是由于默认下载地址下载速度较慢需要重新设置下载地址为国内镜像站修改数据卷中的文件将下载地址替换为清华大学的插件源也可以再次重启容器访问需要稍微等会首页查看密码登录并登录下载插件登录并下载插件选择需要安装的插件选择需要安装的插件下载完毕设置信息进入首页可能会出现下载失败的插件入门配置由于需要从拉取代码需要本地构建甚至需要直接发布自定义镜像到仓库所以需要配置大量内容构建任务准备好仓库中的项目并且通过配置项目的实现当前项目的基本流程构建工程发布到均可查看项目点击左侧导航新建任务新建任务选择自由风格构建任务构建任务配置源码拉取地址需要将上存放的源码存储到服务所在磁盘的本地配置任务源码拉取的地址源码管理立即构建点击任务中的立即构建查看构建工程的日志点击上述的任务条即可查看任务拉取源码日志可以看到源码已经拉取带本地可以根据第三行日志信息查看本地拉取到的源码查看容器中的源码源码存放位置配置构建代码代码拉取到本地后需要在中对代码进行构建这里需要的环境而需要的环境接下来需要在中安装和并且配置到服务准备压缩包通过数据卷映射到容器内部数据卷存放位置解压压缩包并配置的阿里云镜像地址编译插件配置并保存配置任务构建代码配置构建代码立即构建测试查看下的包构建源码配置发布远程操作包构建好之后就可以根据情况发布到测试或生产环境这里需要用到之前下载好的插件配置连接测试生产环境配置配置任务的构建后操作发布包到目标服务配置构建后操作立即构建任务并去目标服务查看立即构建入门操作基于拉取的代码进行构建发布到测试环境实现持续集成基于拉取指定发行版本的代码进行构建发布到生产环境实现实现持续部署持续集成为了让程序代码可以自动推送到测试环境基于服务运行需要添加配置和脚本文件让程序可以在集成到主干的同时运行起来添加文件构建自定义镜像添加文件加载自定义镜像启动容器追加构建后操作脚本命令构建后发布并执行脚本命令发布到后由立即构建并托送到目标服务器构建日志测试部署到目标服务器程序查看目标服务器并测试接口持续交付部署程序代码在经过多次集成操作到达最终可以交付持续交付整体流程和持续集成类似不过需要选取指定的发行版本下载插件下载设置项目参数化构建基于标签构建给项目添加版本添加版本任务构建时采用方式构建拉取指定版本代码切换指定标签并构建项目基于构建任务任务发布到目标服务器构建任务集成介绍是一个开源的代码分析平台支持等种以上的语言可以检测出重复代码代码漏洞代码规范和安全性漏洞的问题可以与多种软件整合进行代码扫描比如等并且会将代码检测结果推送回并且在系统提供的界面上显示出来的界面环境搭建安装在版本中已经放弃了对的支持并且建议在商业环境中采用那么安装时需要依赖并且这里会安装的长期支持版本拉取镜像编写启动容器需要设置文件信息设置并执行命令刷新重新启动需要一定时间启动可以可以查看容器日志看到如下内容代表启动成功容器日志访问首页登录还需要重新设置一次密码重新设置密码首页首页安装中文插件安装中文插件安装成功后需要重启安装失败重新点击重装即可安装成功后会查看到重启按钮点击即可重启按钮重启后查看效果首页效果基本使用的使用方式很多可以整合也可以采用的方式再查看的检测效果实现代码检测修改的文件配置信息在代码位置执行命令执行代码检测查看界面检测结果检测结果实现代码检测下载下载版本即可要求版本解压并配置服务端信息由于是压缩包需要安装解压插件解压压缩包配置服务端地址修改下的配置服务端信息执行命令检测代码在项目所在目录执行以下命令主要查看我的执行命令的位置查看日志信息查看界面检测结果检测结果集成继承实现代码扫描需要先下载整合插件安装插件下载插件配置开启权限验证开启权限校验获取的令牌获取令牌配置的信息配置将添加到数据卷中并配置全局配置配置配置任务的配置任务的构建任务构建任务集成介绍前面在部署项目时我们主要采用推送包到指定服务器再通过脚本命令让目标服务器对当前进行部署这种方式在项目较多时每个目标服务器都需要将包制作成自定义镜像再通过进行启动重复操作比较多会降低项目部署时间我们可以通过作为私有的镜像仓库让统一将项目打包并制作成镜像发布到仓库中只需要通知目标服务让目标服务统一去仓库上拉取镜像并在本地部署即可官方提供了镜像仓库但是的功能相对简陋是公司提供的一款镜像仓库提供了权限控制分布式发布强大的安全扫描与审查机制等功能安装这里采用原生的方式安装下载安装包拖拽到并解压修改配置文件首先复制一份配置编辑配置文件配置文件启动查看日志登录登录首页信息首页信息使用方式作为镜像仓库主要的交互方式就是将镜像上传到上以及从上下载指定镜像在传输镜像前可以先使用提供的权限管理将项目设置为私有项目并对不同用户设置不同角色从而更方便管理镜像添加用户构建项目创建用户创建用户构建项目设置为私有构建项目给项目追加用户追加用户管理切换测试用户切换测试用户发布镜像到修改镜像名称名称要求地址项目名镜像名版本修改镜像名称修改支持仓库并重启修改支持仓库设置登录仓库信息用户名密码地址推送镜像到推送镜像到从拉取镜像跟传统方式一样不过需要先配置文件拉取镜像容器使用宿主机构建镜像和发布镜像到都需要使用到命令而在容器内部安装官方推荐直接采用宿主机带的即可设置容器使用宿主机设置宿主机权限添加数据卷添加构建操作制作自定义镜像编写部署脚本部署项目需要通过插件让目标服务器执行命令为了方便一次性实现拉取镜像和启动的命令推荐采用脚本文件的方式添加脚本文件到目标服务器再通过插件让目标服务器执行脚本即可编写脚本文件添加到目标服务器并设置权限为可执行如图配置构建后操作执行脚本文件流水线流水线任务介绍之前采用的自由风格构建的项目每个步骤流程都要通过不同的方式设置并且构建过程中整体流程是不可见的无法确认每个流程花费的时间并且问题不方便定位问题的可以让项目的发布整体流程可视化明确执行的阶段可以快速的定位问题并且整个项目的生命周期可以通过一个文件管理而且文件是可以放在项目中维护所以相对自由风格或者其他的项目风格更容易操作流水线任务构建流水线任务构建任务构建流水线任务生成脚本脚本生成构建后查看视图构建后查看视图脚本脚本基础语法所有脚本命令包含在中指定任务在哪个节点执行支持分布式配置全局环境指定变量名变量值信息存放所有任务的合集单个任务任务实现任务的具体流程单个任务任务实现任务的具体流程编写例子测试存放所有任务的合集拉取代码拉取代码检测代码质量检测代码质量构建代码构建代码制作自定义镜像并发布制作自定义镜像并发布基于部署工程基于部署工程配置脚本查看效果查看效果涉及到特定脚本给予了充足的提示可以自动生成命令生成命令位置实现方式需要将脚本内容编写到项目中的文件中每次构建会自动拉取项目并且获取项目中文件对项目进行构建配置配置准备准备文件测试效果测试效果流水线任务实现参数化构建添加参数化构建方便选择不的项目版本参数化构建拉取代码通过流水线语法生成代码的脚本语法生成将更改为标签拉取代码构建代码通过脚本执行的构建命令拉取代码构建代码代码质量检测通过脚本执行命令即可拉取代码构建代码检测代码质量制作自定义镜像并发布生成自定义镜像脚本存放所有任务的合集拉取代码构建代码检测代码质量制作自定义镜像并发布生成脚本存放所有任务的合集拉取代码构建代码检测代码质量制作自定义镜像并发布目标服务器拉取镜像并运行由于采用变量记得使用双引号流水线整合钉钉在程序部署成功后可以通过钉钉的机器人及时向群众发送部署的最终结果通知安装插件安装插件钉钉内部创建群组并构建机器人钉钉内部创建群组并构建机器人最终或获取到信息系统配置添加钉钉通知配置钉钉通知任务中追加流水线配置拉取代码构建代码检测代码制作自定义镜像推送自定义镜像通知目标服务器成功构建项目版本持续时间任务失败构建项目版本持续时间任务查看效果钉钉通知效果十编排工具介绍是一个开源的用于管理云平台中多个主机上的容器化的应用的目标是让部署容器化的应用简单并且高效提供了应用部署规划更新维护的一种机制一个核心的特点就是能够自主的管理容器来保证云平台中的容器按照用户的期望状态运行着管理员可以加载一个微型服务让规划器来找到合适的位置同时也系统提升工具以及人性化方面让用户能够方便的部署自己的应用主要能帮助我们完成服务发现和负载均衡可以使用名称或自己的地址公开容器如果进入容器的流量很大可以负载均衡并分配网络流量从而使部署稳定存储编排允许你自动挂载你选择的存储系统比如本地存储类似的数据卷自动部署和回滚你可以使用描述已部署容器的所需状态它可以以受控的速率将实际状态更改为期望状态会自动帮你根据情况部署创建新容器并删除现有容器给新容器提供资源自动完成装箱计算允许你设置每个容器的资源比如和内存自我修复重新启动失败的容器替换容器杀死不响应用户定义的容器并运行状况检查的容器秘钥与配置管理允许你存储和管理敏感信息例如密码令牌和密钥你可以在不重建容器镜像的情况下部署和更新密钥和应用程序配置也无需在堆栈配置中暴露密钥架构搭建需要至少两个节点一个负责管理一个搭建在工作服务器上负责分配架构从图中可以看到各个组件的基本功能作为通讯的核心组件内部交互以及接收发送指令的组件作为的核心组件主要做资源调度根据集群情况分配资源一个的数据库存储存储集群的状态信息负责调度每个工作节点负责调度其他云服务产品管理上面的容器负责处理其他或客户端的请求可以理解为就是运行的容器安装这里会采用提供的方式安装安装单节点要求使用版本至少台核的服务器安装流程安装流程准备好服务器后开始安装重新设置不允许为修改名字不允许使用下划线小数点大写字母不能叫查看修改结果设置解析要求台服务之间可以相互通讯安装软件阿里云镜像首先初始化节点关于初始化时用到的环境变量不能是的必须全为小写字母数字小数点不能包含减号所使用的网段不能与节点节点所在的网段重叠该字段的取值为一个值如果您对这个概念还不熟悉请仍然执行命令不做修改设置域名网段并执行初始化操作只在节点执行替换为节点实际请使用内网命令只在当前会话中有效开启新的窗口后如果要继续安装过程请重新执行此处的命令替换为您想要的容器组所在的网段该网段安装完成后由创建事先并不存在于您的物理网络中检查启动状态只在节点执行执行如下命令等待分钟直到所有的容器组处于状态查看节点初始化结果如果出现的情况执行最新版本的一般没有安装网络服务插件初始化节点获取命令参数在节点执行只在节点执行获取命令在节点初始化只在节点执行替换为节点的内网替换为初始化节点时所使用的替换为节点上命令的输出检查最终运行效果在节点上执行只在节点执行如果出现的情况执行最新版本的一般没有输出结果如下所示搭建成功效果安装管理集群安装您也可以使用下面的指令唯一的区别是该指令使用华为云的镜像仓库替代分发所需要的镜像查看启动情况查看效果在浏览器中打开链接首页输入初始用户名和密码并登录用户名密码首页效果操作首先我们要了解在运行我们的资源时关联到了哪些内容资源的构建方式采用的命令方式文件方式命名空间主要是为了对中运行的资源进行过隔离但是网络是互通的类似的容器可以将多个资源配置到一个中而可以对不同环境进行资源隔离默认情况下提供了命名空间在构建资源时如果不指定资源默认采用资源命令方式查看现有的全部命名空间构建命名空间命名空间名称删除现有命名空间并且会删除空间下的全部资源命名空间名称文件方式构建资源时设置命名空间运行的一组容器是的最小单位但是对于而然中会运行多个容器命令方式查看所有运行的查看指定下的命名空间默认创建名称镜像名称查看详细信息名称删除名称命名空间默认查看输出的日志名称进去容器内部名称查看给分配的信息并且通过和容器的端口可以直接访问方式推荐运行的名称名称命名空间镜像名称容器名称启动文件名称删除文件名称中运行多个容器运行的名称名称命名空间镜像名称容器名称镜像名称容器名称启动后可以查看到效果部署时可以通过管理和编排部署实现命令方式基于启动容器名称镜像名称用启动的容器会在被删除后自动再次创建达到故障漂移的效果需要使用的方式删除查看现在的删除名称基于启动容器并设置集群数名称镜像名称集群个数配置文件方式正常使用运行即可弹性伸缩功能基于实现弹性伸缩名称集群个数或者修改文件名称图形化页面修改灰度发布可以在部署新版本数据时成功启动一个才会下线一个老版本的名称容器名镜像版本可以将多个对外暴露一个让客户端可以通过访问到这一组并且可以实现负载均衡方式是集群内部之间的访问方式命令实现效果通过生成映射一个下的所有中的某一个端口的容器名称端口号内容器端口之后通过查看提供的即可访问也可以通过名称名称作为域名访问在服务容器内执行方式的方式只能在内部实现访问但是一般需要对外暴露网关所以需要的方式外暴露访问命令实现方式通过生成映射一个下的所有中的某一个端口的容器名称端口号内容器端口查看效果也可以通过文件实现通过启动就也可以创建测试效果部署通过暴露可以查看到暴露的信息信息推荐将作为所有的入口提供统一的入口避免多个服务之间需要记录大量的或者域名毕竟可能改变服务太多域名记录不方便底层其实就是一个可以在上直接点击安装安装因为副本数默认为但是整体集群就个节点所以显示下面即为安装成功安装成功可以将接收到的请求转发到不同的中推荐使用文件方式启动时问题安装的有的校验配置需要先删除配置再启动找到指定的的校验信息删除即可删除信息查看校验的配置删除指定的校验配置本地文件配置记下来既可以访问在中暴露的信息服通过访问集成准备部署的文件私服配置在尝试用的文件启动服务时会出现无法拉取镜像的问题这里需要在所在的中配置服务信息并且保证可以拉取上的镜像设置和的私服地址信息设置私服地址在上设置私服密文信息设置密文并测试按照复制指令的位置测试认证效果如下测试效果测试使用效果执行命令基于启动服务并且基于部署后服务的提示信息以及的设置直接访问远程调用将配置到中配置文件配置的目标服务器可以将文件传输到的上设置目标服务器修改重新设置流水线任务脚本并测试效果传递文件脚本设置无密码登录将中公钥信息复制到的中保证远程连接无密码远程执行命令无需密码设置执行的脚本到设置执行查看效果执行流水线可以查看到文件是由变化的这样就会重新加载查看效果效果这种方式更适应与操作将项目将基于某个版本部署到指定的目标服务器基于的这里要实现自动化的一个操作也就是开发人员代码到仓库后会自动的构建项目将最新的提交点代码构建并进行打包部署这里区别去上述的操作操作需要基于某个版本进行部署而这里每次都是将最新的提交点集成到主干上并测试通知开启的自动构建构建触发器设置的设置的需要关闭的认证关闭的认证再次测试再次测试修改配置修改实现基于最新提交点实现持续集成效果将之前引用的全部去掉所有的脚本命令都放在中指定任务再哪个集群节点中执行声明全局变量方便后面使用拉取仓库代码通过构建项目通过做代码质量检测通过制作自定义镜像将自定义镜像推送到将文件传到上远程执行的命令成功构建版本持续时间构建失败版本持续时间修改更改镜像版本这里省略其他内容滚动更新因为没有改变时每次不会重新加载这样会导致中的容器不会动态更新这里需要使用的命令滚动更新设置注意点安装的一定要是最新版本的不然很多插件无法安装安装的插件").trim().substring(0, 1000);
      let value = Math.floor(Math.random() * 3) + 1000;
      while (value === prevParam || truncateDescription.length - value === prevParam) {
        value = Math.floor(Math.random() * 3) + 1000;
      }
      aiTitleRefreshIcon.style.opacity = "0.2";
      aiTitleRefreshIcon.style.transitionDuration = "0.3s";
      aiTitleRefreshIcon.style.transform = "rotate(" + 360 * refreshNum + "deg)";
      if (truncateDescription.length <= 1000) {
        let param = truncateDescription.length - Math.floor(Math.random() * 3);
        while (param === prevParam) {
          param = truncateDescription.length - Math.floor(Math.random() * 3);
        }
        aiAbstract(param);
        prevParam = param;
      } else {
        aiAbstract(value);
        prevParam = value;
      }
      refreshNum++;
    }
  }

  //- 监听tag点击事件
  document.getElementById("ai-tag").addEventListener("click", () => {
    if (mode === "tianli") {
      document.querySelectorAll(".ai-btn-item").forEach(item => item.style.display = "none");
      document.getElementById("go-tianli-blog").style.display = "block";
      startAI("你好，我是Tianli开发的摘要生成助理TianliGPT，是一个基于GPT-4的生成式AI。我在这里只负责摘要的预生成和显示，你无法与我直接沟通，如果你也需要一个这样的AI摘要接口，可以在下方购买。（暂未开放购买，敬请期待）")
    } else {
      document.getElementById("go-tianli-blog").style.display = "none";
      startAI("你好，我是本站摘要生成助理故梦 GPT，是一个基于GPT-4的生成式AI。我在这里只负责摘要的预生成和显示，你无法与我直接沟通。")
    }

  });

  aiTitleRefreshIcon.addEventListener("click", () => {
    const truncateDescription = ("" + "DevOps 介绍, Code 阶段工具, Docker 安装, Git 安装, GitLab 安装, Build 阶段工具, Operate 阶段工具, Docker 安装, Docker-Compose 安装, Integrate 工具, Jenkins 介绍, Jenkins 安装, Jenkins 入门配置, 构建任务, 配置源码拉取地址, 配置 Maven 构建代码, 配置 Publish 发布amp远程操作, CI、CD 入门操作, 持续集成, 持续交付、部署, 集成 Sonar Qube, Sonar Qube 介绍, Sonar Qube 环境搭建, Sonar Qube 安装, 安装中文插件, Sonar Qube 基本使用, Maven 实现代码检测, Sonar-scanner 实现代码检测, Jenkins 集成 Sonar Qube, Jenkins 安装插件, Jenkins 配置 Sonar Qube, 配置 Sonar-scanner, 构建任务, 集成 Harbor, Harbor 介绍, Harbor 安装, Harbor 使用方式, 添加用户构建项目, 发布镜像到 Harbor, 从 Harbor 拉取镜像 ls, Jenkins 容器使用宿主机 Docker, 添加构建操作, 编写部署脚本, 配置构建后操作, Jenkins 流水线, Jenkins 流水线任务介绍, Jenkins 流水线任务, 构建 Jenkins 流水线任务, Groovy 脚本, Jenkinsfile 实现, Jenkins 流水线任务实现, 参数化构建, 拉取 Git 代码, 构建代码, 代码质量检测, 制作自定义镜像并发布, Jenkins 流水线整合钉钉, Kubernetes 介绍, Kubernetes 架构, Kubernetes 安装, Kubernetes 操作, Namespace, Pod, Deployment, Service, Ingress, Jenkins 集成 Kubernetes, 准备部署的 yml 文件, Harbor 私服配置, 测试使用效果, Jenkins 远程调用, 基于 GitLab 的 WebHooks, WebHooks 通知, 修改配置, 滚动更新, 注意点转载来自不想当短发少女了介绍软件开发最开始是由两个团队组成开发计划由开发团队从头开始设计和整体系统的构建需要系统不停的迭代更新运维团队将开发团队的进行测试后部署上线希望系统稳定安全运行这看似两个目标不同的团队需要协同完成一个软件的开发在开发团队指定好计划并完成后需要提供到运维团队运维团队向开发团队反馈需要修复的以及一些需要返工的任务这时开发团队需要经常等待运维团队的反馈这无疑延长了事件并推迟了整个软件开发的周期会有一种方式在开发团队等待的时候让开发团队转移到下一个项目中等待运维团队为之前的代码提供反馈可是这样就意味着一个完整的项目需要一个更长的周期才可以开发出最终代码基于现在的互联网现状更推崇敏捷式开发这样就导致项目的迭代速度更快但是由于开发团队与运维团队的沟通问题会导致新版本上线的时间成本很高这又违背的敏捷式开发的最初的目的那么如果让开发团队和运维团队整合到成一个团队协同应对一套软件呢这就被称为字面意思是的缩写也就是开发运维虽然字面意思只涉及到了开发团队和运维团队其实测试团队也是参与其中的网上可以查看到的符号类似于一个无穷大的符号这表明是一个不断提高效率并且持续不断工作的过程的方式可以让公司能够更快地应对更新和市场发展变化开发可以快速交付部署也更加稳定核心就在于简化和团队之间的流程使整体软件开发过程更快速整体的软件开发流程包括开发团队根据客户的目标制定开发计划根据开始编码过程需要将不同版本的代码存储在一个库中编码完成后需要将代码构建并且运行成功构建项目后需要测试代码是否存在或错误代码经过手动测试和自动化测试后认定代码已经准备好部署并且交给运维团队运维团队将代码部署到生产环境中项目部署上线后需要持续的监控产品然后将监控阶段收到的反馈发送回阶段整体反复的流程就是的核心即持续集成持续部署为了保证整体流程可以高效的完成各个阶段都有比较常见的工具如下图软件开发过程涉及工具最终可以给下一个定义强调的是高效组织团队之间如何通过自动化的工具协作和沟通来完成软件的生命周期管理从而更快更频繁地交付更稳定的软件自动化的工具协作和沟通来完成软件的生命周期管理阶段工具在阶段我们需要将不同版本的代码存储到一个仓库中常见的版本控制工具就是或者这里我们采用作为版本控制工具作为远程仓库安装参考安装方案参考方案安装安装地址安装单独准备服务器采用安装查看镜像拉取镜像准备文件启动容器需要稍等一小会访问首页首页查看用户初始密码初始密码登录用户登录成功后跳转页面第一次登录后需要修改密码修改密码搞定后即可像一样使用阶段工具构建项目的工具一般有两种选择一个是一个是这里我们选择作为项目的编译工具具体安装流程不做阐述但是需要确保配置好仓库私服以及编译版本阶段工具部署过程会采用进行部署暂时只安装即可后续还需安装安装准备测试环境生产环境下载依赖组件设置下载的镜像源为阿里云安装服务安装成功后启动并设置开机自启启动服务设置开机自动启动测试安装成功效果安装下载将下载好的文件移动到操作系统设置文件权限并移动到目录中设置文件权限移动到目录下并重命名为测试安装成功效果工具持续集成持续部署的工具很多其中是一个开源的持续集成平台涉及到将编写完毕的代码发布到测试环境和生产环境的任务并且还涉及到了构建项目等任务需要大量的插件保证工作安装成本较高下面会基于搭建介绍是一个开源软件项目是基于开发的一种持续集成工具应用广泛大多数互联网公司都采用配合作为实现的核心工具最强大的就在于插件官方提供了大量的插件库来自动化过程中的各种琐碎功能最主要的工作就是将上可以构建的工程代码拉取并且进行构建再根据流程可以选择发布到测试环境或是生产环境一般是上的代码经过大量的测试后确定发行版本再发布到生产环境可以理解为过程即是通过将代码拉取构建制作镜像交给测试人员测试持续集成让软件代码可以持续的集成到主干上并自动构建和测试过程即是通过将打好标签的发行版本代码拉取构建制作镜像交给运维人员部署持续交付让经过持续集成的代码可以进行手动部署持续部署让可以持续交付的代码随时随地的自动化部署安装拉取镜像编写首次启动会因为数据卷目录没有权限导致启动失败设置目录写权限错误日志重新启动容器后由于需要下载大量内容但是由于默认下载地址下载速度较慢需要重新设置下载地址为国内镜像站修改数据卷中的文件将下载地址替换为清华大学的插件源也可以再次重启容器访问需要稍微等会首页查看密码登录并登录下载插件登录并下载插件选择需要安装的插件选择需要安装的插件下载完毕设置信息进入首页可能会出现下载失败的插件入门配置由于需要从拉取代码需要本地构建甚至需要直接发布自定义镜像到仓库所以需要配置大量内容构建任务准备好仓库中的项目并且通过配置项目的实现当前项目的基本流程构建工程发布到均可查看项目点击左侧导航新建任务新建任务选择自由风格构建任务构建任务配置源码拉取地址需要将上存放的源码存储到服务所在磁盘的本地配置任务源码拉取的地址源码管理立即构建点击任务中的立即构建查看构建工程的日志点击上述的任务条即可查看任务拉取源码日志可以看到源码已经拉取带本地可以根据第三行日志信息查看本地拉取到的源码查看容器中的源码源码存放位置配置构建代码代码拉取到本地后需要在中对代码进行构建这里需要的环境而需要的环境接下来需要在中安装和并且配置到服务准备压缩包通过数据卷映射到容器内部数据卷存放位置解压压缩包并配置的阿里云镜像地址编译插件配置并保存配置任务构建代码配置构建代码立即构建测试查看下的包构建源码配置发布远程操作包构建好之后就可以根据情况发布到测试或生产环境这里需要用到之前下载好的插件配置连接测试生产环境配置配置任务的构建后操作发布包到目标服务配置构建后操作立即构建任务并去目标服务查看立即构建入门操作基于拉取的代码进行构建发布到测试环境实现持续集成基于拉取指定发行版本的代码进行构建发布到生产环境实现实现持续部署持续集成为了让程序代码可以自动推送到测试环境基于服务运行需要添加配置和脚本文件让程序可以在集成到主干的同时运行起来添加文件构建自定义镜像添加文件加载自定义镜像启动容器追加构建后操作脚本命令构建后发布并执行脚本命令发布到后由立即构建并托送到目标服务器构建日志测试部署到目标服务器程序查看目标服务器并测试接口持续交付部署程序代码在经过多次集成操作到达最终可以交付持续交付整体流程和持续集成类似不过需要选取指定的发行版本下载插件下载设置项目参数化构建基于标签构建给项目添加版本添加版本任务构建时采用方式构建拉取指定版本代码切换指定标签并构建项目基于构建任务任务发布到目标服务器构建任务集成介绍是一个开源的代码分析平台支持等种以上的语言可以检测出重复代码代码漏洞代码规范和安全性漏洞的问题可以与多种软件整合进行代码扫描比如等并且会将代码检测结果推送回并且在系统提供的界面上显示出来的界面环境搭建安装在版本中已经放弃了对的支持并且建议在商业环境中采用那么安装时需要依赖并且这里会安装的长期支持版本拉取镜像编写启动容器需要设置文件信息设置并执行命令刷新重新启动需要一定时间启动可以可以查看容器日志看到如下内容代表启动成功容器日志访问首页登录还需要重新设置一次密码重新设置密码首页首页安装中文插件安装中文插件安装成功后需要重启安装失败重新点击重装即可安装成功后会查看到重启按钮点击即可重启按钮重启后查看效果首页效果基本使用的使用方式很多可以整合也可以采用的方式再查看的检测效果实现代码检测修改的文件配置信息在代码位置执行命令执行代码检测查看界面检测结果检测结果实现代码检测下载下载版本即可要求版本解压并配置服务端信息由于是压缩包需要安装解压插件解压压缩包配置服务端地址修改下的配置服务端信息执行命令检测代码在项目所在目录执行以下命令主要查看我的执行命令的位置查看日志信息查看界面检测结果检测结果集成继承实现代码扫描需要先下载整合插件安装插件下载插件配置开启权限验证开启权限校验获取的令牌获取令牌配置的信息配置将添加到数据卷中并配置全局配置配置配置任务的配置任务的构建任务构建任务集成介绍前面在部署项目时我们主要采用推送包到指定服务器再通过脚本命令让目标服务器对当前进行部署这种方式在项目较多时每个目标服务器都需要将包制作成自定义镜像再通过进行启动重复操作比较多会降低项目部署时间我们可以通过作为私有的镜像仓库让统一将项目打包并制作成镜像发布到仓库中只需要通知目标服务让目标服务统一去仓库上拉取镜像并在本地部署即可官方提供了镜像仓库但是的功能相对简陋是公司提供的一款镜像仓库提供了权限控制分布式发布强大的安全扫描与审查机制等功能安装这里采用原生的方式安装下载安装包拖拽到并解压修改配置文件首先复制一份配置编辑配置文件配置文件启动查看日志登录登录首页信息首页信息使用方式作为镜像仓库主要的交互方式就是将镜像上传到上以及从上下载指定镜像在传输镜像前可以先使用提供的权限管理将项目设置为私有项目并对不同用户设置不同角色从而更方便管理镜像添加用户构建项目创建用户创建用户构建项目设置为私有构建项目给项目追加用户追加用户管理切换测试用户切换测试用户发布镜像到修改镜像名称名称要求地址项目名镜像名版本修改镜像名称修改支持仓库并重启修改支持仓库设置登录仓库信息用户名密码地址推送镜像到推送镜像到从拉取镜像跟传统方式一样不过需要先配置文件拉取镜像容器使用宿主机构建镜像和发布镜像到都需要使用到命令而在容器内部安装官方推荐直接采用宿主机带的即可设置容器使用宿主机设置宿主机权限添加数据卷添加构建操作制作自定义镜像编写部署脚本部署项目需要通过插件让目标服务器执行命令为了方便一次性实现拉取镜像和启动的命令推荐采用脚本文件的方式添加脚本文件到目标服务器再通过插件让目标服务器执行脚本即可编写脚本文件添加到目标服务器并设置权限为可执行如图配置构建后操作执行脚本文件流水线流水线任务介绍之前采用的自由风格构建的项目每个步骤流程都要通过不同的方式设置并且构建过程中整体流程是不可见的无法确认每个流程花费的时间并且问题不方便定位问题的可以让项目的发布整体流程可视化明确执行的阶段可以快速的定位问题并且整个项目的生命周期可以通过一个文件管理而且文件是可以放在项目中维护所以相对自由风格或者其他的项目风格更容易操作流水线任务构建流水线任务构建任务构建流水线任务生成脚本脚本生成构建后查看视图构建后查看视图脚本脚本基础语法所有脚本命令包含在中指定任务在哪个节点执行支持分布式配置全局环境指定变量名变量值信息存放所有任务的合集单个任务任务实现任务的具体流程单个任务任务实现任务的具体流程编写例子测试存放所有任务的合集拉取代码拉取代码检测代码质量检测代码质量构建代码构建代码制作自定义镜像并发布制作自定义镜像并发布基于部署工程基于部署工程配置脚本查看效果查看效果涉及到特定脚本给予了充足的提示可以自动生成命令生成命令位置实现方式需要将脚本内容编写到项目中的文件中每次构建会自动拉取项目并且获取项目中文件对项目进行构建配置配置准备准备文件测试效果测试效果流水线任务实现参数化构建添加参数化构建方便选择不的项目版本参数化构建拉取代码通过流水线语法生成代码的脚本语法生成将更改为标签拉取代码构建代码通过脚本执行的构建命令拉取代码构建代码代码质量检测通过脚本执行命令即可拉取代码构建代码检测代码质量制作自定义镜像并发布生成自定义镜像脚本存放所有任务的合集拉取代码构建代码检测代码质量制作自定义镜像并发布生成脚本存放所有任务的合集拉取代码构建代码检测代码质量制作自定义镜像并发布目标服务器拉取镜像并运行由于采用变量记得使用双引号流水线整合钉钉在程序部署成功后可以通过钉钉的机器人及时向群众发送部署的最终结果通知安装插件安装插件钉钉内部创建群组并构建机器人钉钉内部创建群组并构建机器人最终或获取到信息系统配置添加钉钉通知配置钉钉通知任务中追加流水线配置拉取代码构建代码检测代码制作自定义镜像推送自定义镜像通知目标服务器成功构建项目版本持续时间任务失败构建项目版本持续时间任务查看效果钉钉通知效果十编排工具介绍是一个开源的用于管理云平台中多个主机上的容器化的应用的目标是让部署容器化的应用简单并且高效提供了应用部署规划更新维护的一种机制一个核心的特点就是能够自主的管理容器来保证云平台中的容器按照用户的期望状态运行着管理员可以加载一个微型服务让规划器来找到合适的位置同时也系统提升工具以及人性化方面让用户能够方便的部署自己的应用主要能帮助我们完成服务发现和负载均衡可以使用名称或自己的地址公开容器如果进入容器的流量很大可以负载均衡并分配网络流量从而使部署稳定存储编排允许你自动挂载你选择的存储系统比如本地存储类似的数据卷自动部署和回滚你可以使用描述已部署容器的所需状态它可以以受控的速率将实际状态更改为期望状态会自动帮你根据情况部署创建新容器并删除现有容器给新容器提供资源自动完成装箱计算允许你设置每个容器的资源比如和内存自我修复重新启动失败的容器替换容器杀死不响应用户定义的容器并运行状况检查的容器秘钥与配置管理允许你存储和管理敏感信息例如密码令牌和密钥你可以在不重建容器镜像的情况下部署和更新密钥和应用程序配置也无需在堆栈配置中暴露密钥架构搭建需要至少两个节点一个负责管理一个搭建在工作服务器上负责分配架构从图中可以看到各个组件的基本功能作为通讯的核心组件内部交互以及接收发送指令的组件作为的核心组件主要做资源调度根据集群情况分配资源一个的数据库存储存储集群的状态信息负责调度每个工作节点负责调度其他云服务产品管理上面的容器负责处理其他或客户端的请求可以理解为就是运行的容器安装这里会采用提供的方式安装安装单节点要求使用版本至少台核的服务器安装流程安装流程准备好服务器后开始安装重新设置不允许为修改名字不允许使用下划线小数点大写字母不能叫查看修改结果设置解析要求台服务之间可以相互通讯安装软件阿里云镜像首先初始化节点关于初始化时用到的环境变量不能是的必须全为小写字母数字小数点不能包含减号所使用的网段不能与节点节点所在的网段重叠该字段的取值为一个值如果您对这个概念还不熟悉请仍然执行命令不做修改设置域名网段并执行初始化操作只在节点执行替换为节点实际请使用内网命令只在当前会话中有效开启新的窗口后如果要继续安装过程请重新执行此处的命令替换为您想要的容器组所在的网段该网段安装完成后由创建事先并不存在于您的物理网络中检查启动状态只在节点执行执行如下命令等待分钟直到所有的容器组处于状态查看节点初始化结果如果出现的情况执行最新版本的一般没有安装网络服务插件初始化节点获取命令参数在节点执行只在节点执行获取命令在节点初始化只在节点执行替换为节点的内网替换为初始化节点时所使用的替换为节点上命令的输出检查最终运行效果在节点上执行只在节点执行如果出现的情况执行最新版本的一般没有输出结果如下所示搭建成功效果安装管理集群安装您也可以使用下面的指令唯一的区别是该指令使用华为云的镜像仓库替代分发所需要的镜像查看启动情况查看效果在浏览器中打开链接首页输入初始用户名和密码并登录用户名密码首页效果操作首先我们要了解在运行我们的资源时关联到了哪些内容资源的构建方式采用的命令方式文件方式命名空间主要是为了对中运行的资源进行过隔离但是网络是互通的类似的容器可以将多个资源配置到一个中而可以对不同环境进行资源隔离默认情况下提供了命名空间在构建资源时如果不指定资源默认采用资源命令方式查看现有的全部命名空间构建命名空间命名空间名称删除现有命名空间并且会删除空间下的全部资源命名空间名称文件方式构建资源时设置命名空间运行的一组容器是的最小单位但是对于而然中会运行多个容器命令方式查看所有运行的查看指定下的命名空间默认创建名称镜像名称查看详细信息名称删除名称命名空间默认查看输出的日志名称进去容器内部名称查看给分配的信息并且通过和容器的端口可以直接访问方式推荐运行的名称名称命名空间镜像名称容器名称启动文件名称删除文件名称中运行多个容器运行的名称名称命名空间镜像名称容器名称镜像名称容器名称启动后可以查看到效果部署时可以通过管理和编排部署实现命令方式基于启动容器名称镜像名称用启动的容器会在被删除后自动再次创建达到故障漂移的效果需要使用的方式删除查看现在的删除名称基于启动容器并设置集群数名称镜像名称集群个数配置文件方式正常使用运行即可弹性伸缩功能基于实现弹性伸缩名称集群个数或者修改文件名称图形化页面修改灰度发布可以在部署新版本数据时成功启动一个才会下线一个老版本的名称容器名镜像版本可以将多个对外暴露一个让客户端可以通过访问到这一组并且可以实现负载均衡方式是集群内部之间的访问方式命令实现效果通过生成映射一个下的所有中的某一个端口的容器名称端口号内容器端口之后通过查看提供的即可访问也可以通过名称名称作为域名访问在服务容器内执行方式的方式只能在内部实现访问但是一般需要对外暴露网关所以需要的方式外暴露访问命令实现方式通过生成映射一个下的所有中的某一个端口的容器名称端口号内容器端口查看效果也可以通过文件实现通过启动就也可以创建测试效果部署通过暴露可以查看到暴露的信息信息推荐将作为所有的入口提供统一的入口避免多个服务之间需要记录大量的或者域名毕竟可能改变服务太多域名记录不方便底层其实就是一个可以在上直接点击安装安装因为副本数默认为但是整体集群就个节点所以显示下面即为安装成功安装成功可以将接收到的请求转发到不同的中推荐使用文件方式启动时问题安装的有的校验配置需要先删除配置再启动找到指定的的校验信息删除即可删除信息查看校验的配置删除指定的校验配置本地文件配置记下来既可以访问在中暴露的信息服通过访问集成准备部署的文件私服配置在尝试用的文件启动服务时会出现无法拉取镜像的问题这里需要在所在的中配置服务信息并且保证可以拉取上的镜像设置和的私服地址信息设置私服地址在上设置私服密文信息设置密文并测试按照复制指令的位置测试认证效果如下测试效果测试使用效果执行命令基于启动服务并且基于部署后服务的提示信息以及的设置直接访问远程调用将配置到中配置文件配置的目标服务器可以将文件传输到的上设置目标服务器修改重新设置流水线任务脚本并测试效果传递文件脚本设置无密码登录将中公钥信息复制到的中保证远程连接无密码远程执行命令无需密码设置执行的脚本到设置执行查看效果执行流水线可以查看到文件是由变化的这样就会重新加载查看效果效果这种方式更适应与操作将项目将基于某个版本部署到指定的目标服务器基于的这里要实现自动化的一个操作也就是开发人员代码到仓库后会自动的构建项目将最新的提交点代码构建并进行打包部署这里区别去上述的操作操作需要基于某个版本进行部署而这里每次都是将最新的提交点集成到主干上并测试通知开启的自动构建构建触发器设置的设置的需要关闭的认证关闭的认证再次测试再次测试修改配置修改实现基于最新提交点实现持续集成效果将之前引用的全部去掉所有的脚本命令都放在中指定任务再哪个集群节点中执行声明全局变量方便后面使用拉取仓库代码通过构建项目通过做代码质量检测通过制作自定义镜像将自定义镜像推送到将文件传到上远程执行的命令成功构建版本持续时间构建失败版本持续时间修改更改镜像版本这里省略其他内容滚动更新因为没有改变时每次不会重新加载这样会导致中的容器不会动态更新这里需要使用的命令滚动更新设置注意点安装的一定要是最新版本的不然很多插件无法安装安装的插件").trim().substring(0, 1000);
    let value = Math.floor(Math.random() * 3) + 1000;
    while (value === prevParam || truncateDescription.length - value === prevParam) {
      value = Math.floor(Math.random() * 3) + 1000;
    }
    aiTitleRefreshIcon.style.opacity = "0.2";
    aiTitleRefreshIcon.style.transitionDuration = "0.3s";
    aiTitleRefreshIcon.style.transform = "rotate(" + 360 * refreshNum + "deg)";
    if (truncateDescription.length <= 1000) {
      let param = truncateDescription.length - Math.floor(Math.random() * 3);
      while (param === prevParam) {
        param = truncateDescription.length - Math.floor(Math.random() * 3);
      }
      aiAbstract(param);
      prevParam = param;
    } else {
      aiAbstract(value);
      prevParam = value;
    }
    showAiBtn();
    refreshNum++;
  });

  document.getElementById("go-tianli-blog").addEventListener("click", () => {
    window.open("https://afdian.net/item/886a79d4db6711eda42a52540025c377", "_blank");
  });
  
  if (false) {
    document.getElementById("ai-Toggle").addEventListener("click", () => {
      changeShowMode()
    });
  }

  function showAiBtn() {
    document.querySelectorAll(".ai-btn-item").forEach(item => {
      if (item.id !== "go-tianli-blog") {
        item.style.display = "block";
      }
      if (item.id === "go-tianli-blog") {
        item.style.display = "none";
      }
    });
  }


  aiAbstract();
  showAiBtn()
})()</script></div><article class="post-content" id="article-container"><div class="note blue anzhiyufont anzhiyu-icon-bullhorn simple"><p>转载来自<a target="_blank" rel="noopener" href="https://space.bilibili.com/397867515">不想当短发少女了</a></p></div><h3 id="DevOps-介绍"><a href="#DevOps-介绍" class="headerlink" title="DevOps 介绍"></a>DevOps 介绍</h3><p>软件开发最开始是由两个团队组成：</p><ul><li>开发计划由<a href="">开发团队</a>从头开始设计和整体系统的构建。需要系统不停的迭代更新。</li><li><a href="">运维团队</a>将开发团队的 Code 进行测试后部署上线。希望系统稳定安全运行。</li></ul><p>这看似两个目标不同的团队需要协同完成一个软件的开发。</p><p>在开发团队指定好计划并完成 coding 后，需要提供到运维团队。</p><p>运维团队向开发团队反馈需要修复的 BUG 以及一些需要返工的任务。</p><p>这时开发团队需要经常等待运维团队的反馈。这无疑延长了事件并推迟了整个软件开发的周期。</p><p>会有一种方式，在开发团队等待的时候，让开发团队转移到下一个项目中。等待运维团队为之前的代码提供反馈。</p><p>可是这样就意味着一个完整的项目需要一个更长的周期才可以开发出最终代码。</p><hr><p>基于现在的互联网现状，更推崇敏捷式开发，这样就导致项目的迭代速度更快，但是由于开发团队与运维团队的沟通问题，会导致新版本上线的时间成本很高。这又违背的敏捷式开发的最初的目的。</p><p>那么如果让开发团队和运维团队整合到成一个团队，协同应对一套软件呢？这就被称为<a href="">DevOps</a>。</p><p><a href="">DevOps</a>，字面意思是 Development &amp; Operations 的缩写，也就是开发&amp;运维。</p><p>虽然字面意思只涉及到了开发团队和运维团队，其实 QA 测试团队也是参与其中的。</p><p>网上可以查看到<a href="">DevOps</a>的符号类似于一个无穷大的符号</p><table><thead><tr><th align="center"><a href="">DevOps</a></th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211124130409521.png" alt="image-20211124130409521"></td></tr></tbody></table><p>这表明<a href="">DevOps</a>是一个不断提高效率并且持续不断工作的过程</p><p><a href="">DevOps</a>的方式可以让公司能够更快地应对更新和市场发展变化，开发可以快速交付，部署也更加稳定。</p><p>核心就在于<a href="">简化 Dev 和 Ops 团队之间的流程，使整体软件开发过程更快速。</a></p><p>整体的软件开发流程包括：</p><ul><li>PLAN：开发团队根据客户的目标制定开发计划</li><li>CODE：根据 PLAN 开始编码过程，需要将不同版本的代码存储在一个库中。</li><li>BUILD：编码完成后，需要将代码构建并且运行。</li><li>TEST：成功构建项目后，需要测试代码是否存在 BUG 或错误。</li><li>DEPLOY：代码经过手动测试和自动化测试后，认定代码已经准备好部署并且交给运维团队。</li><li>OPERATE：运维团队将代码部署到生产环境中。</li><li>MONITOR：项目部署上线后，需要持续的监控产品。</li><li>INTEGRATE：然后将监控阶段收到的反馈发送回 PLAN 阶段，整体反复的流程就是<a href="">DevOps</a>的核心，即持续集成、持续部署。</li></ul><p>为了保证整体流程可以高效的完成，各个阶段都有比较常见的工具，如下图：</p><table><thead><tr><th align="center">软件开发过程&amp;涉及工具</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/2021-11-23_175935.png" alt="2021-11-23_175935"></td></tr></tbody></table><p>最终可以给<a href="">DevOps</a>下一个定义：<a href="">DevOps 强调的是高效组织团队之间如何通过自动化的工具协作和沟通来完成软件的生命周期管理，从而更快、更频繁地交付更稳定的软件。</a></p><p>自动化的工具协作和沟通来完成软件的生命周期管理</p><h3 id="Code-阶段工具"><a href="#Code-阶段工具" class="headerlink" title="Code 阶段工具"></a>Code 阶段工具</h3><p>在 code 阶段，我们需要将不同版本的代码存储到一个仓库中，常见的版本控制工具就是 SVN 或者 Git，这里我们采用 Git 作为版本控制工具，GitLab 作为远程仓库。</p><h4 id="Docker-安装"><a href="#Docker-安装" class="headerlink" title="Docker 安装"></a>Docker 安装</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_59196543/article/details/124749175">参考安装方案</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/RtxTitanV/article/details/106607505?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522169486337816800215057168%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=169486337816800215057168&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-106607505-null-null.142%5Ev94%5Einsert_down1&utm_term=linux%E5%AE%89%E8%A3%85docker-compose&spm=1018.2226.3001.4187">参考方案</a></p><h4 id="Git-安装"><a href="#Git-安装" class="headerlink" title="Git 安装"></a>Git 安装</h4><p><a target="_blank" rel="noopener" href="https://git-scm.com/">安装地址</a></p><h4 id="GitLab-安装"><a href="#GitLab-安装" class="headerlink" title="GitLab 安装"></a>GitLab 安装</h4><p>单独准备服务器，采用 Docker 安装</p><ul><li><p>查看 GitLab 镜像</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search gitlab</span><br></pre></td></tr></table></figure></li><li><p>拉取 GitLab 镜像</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull gitlab/gitlab-ce</span><br></pre></td></tr></table></figure></li><li><p>准备 docker-compose.yml 文件</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.1&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">gitlab:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&#x27;gitlab/gitlab-ce:latest&#x27;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">gitlab</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">GITLAB_OMNIBUS_CONFIG:</span> <span class="string">|</span></span><br><span class="line"><span class="string">        external_url &#x27;http://192.168.11.11:8929&#x27;</span></span><br><span class="line"><span class="string">        gitlab_rails[&#x27;gitlab_shell_ssh_port&#x27;] = 2224</span></span><br><span class="line"><span class="string"></span>    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;8929:8929&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;2224:2224&#x27;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;./config:/etc/gitlab&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;./logs:/var/log/gitlab&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;./data:/var/opt/gitlab&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p>启动容器（需要稍等一小会……）</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure></li><li><p>访问 GitLab 首页</p><table><thead><tr><th align="center">首页</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211124182140596.png" alt="image-20211124182140596"></td></tr></tbody></table></li><li><p>查看 root 用户初始密码</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it gitlab <span class="built_in">cat</span> /etc/gitlab/initial_root_password</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">初始密码</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211124182921234.png" alt="image-20211124182921234"></td></tr></tbody></table></li><li><p>登录 root 用户</p><table><thead><tr><th align="center">登录成功后跳转页面</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211124183003858.png" alt="image-20211124183003858"></td></tr></tbody></table></li><li><p>第一次登录后需要修改密码</p><table><thead><tr><th align="center">修改密码</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211124193444561.png" alt="image-20211124193444561"></td></tr></tbody></table></li></ul><p>搞定后，即可像 Gitee、GitHub 一样使用。</p><h3 id="Build-阶段工具"><a href="#Build-阶段工具" class="headerlink" title="Build 阶段工具"></a>Build 阶段工具</h3><p>构建 Java 项目的工具一般有两种选择，一个是 Maven，一个是 Gradle。</p><p>这里我们选择 Maven 作为项目的编译工具。</p><p>具体安装 Maven 流程不做阐述，但是需要确保配置好 Maven 仓库私服以及 JDK 编译版本。</p><h3 id="Operate-阶段工具"><a href="#Operate-阶段工具" class="headerlink" title="Operate 阶段工具"></a>Operate 阶段工具</h3><p>部署过程，会采用 Docker 进行部署，暂时只安装 Docker 即可，后续还需安装 Kubenetes</p><h4 id="Docker-安装-1"><a href="#Docker-安装-1" class="headerlink" title="Docker 安装"></a>Docker 安装</h4><ul><li><p>准备测试环境&amp;生产环境</p></li><li><p>下载 Docker 依赖组件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure></li><li><p>设置下载 Docker 的镜像源为阿里云</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure></li><li><p>安装 Docker 服务</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install docker-ce</span><br></pre></td></tr></table></figure></li><li><p>安装成功后，启动 Docker 并设置开机自启</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动Docker服务</span></span><br><span class="line">systemctl start docker</span><br><span class="line"><span class="comment"># 设置开机自动启动</span></span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure></li><li><p>测试安装成功</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker version</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">效果</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211124200317795.png" alt="image-20211124200317795"></td></tr></tbody></table></li></ul><h4 id="Docker-Compose-安装"><a href="#Docker-Compose-安装" class="headerlink" title="Docker-Compose 安装"></a>Docker-Compose 安装</h4><ul><li><p>下载 Docker&#x2F;Compose：<a target="_blank" rel="noopener" href="https://github.com/docker/compose">https://github.com/docker/compose</a></p></li><li><p>将下载好的<a href="">docker-compose-Linux-x86_64</a>文件移动到 Linux 操作系统：……</p></li><li><p>设置<a href="">docker-compose-Linux-x86_64</a>文件权限，并移动到$PATH 目录中</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置文件权限</span></span><br><span class="line"><span class="built_in">chmod</span> a+x docker-compose-Linux-x86_64</span><br><span class="line"><span class="comment"># 移动到/usr/bin目录下，并重命名为docker-compose</span></span><br><span class="line"><span class="built_in">mv</span> docker-compose-Linux-x86_64 /usr/bin/docker-compose</span><br></pre></td></tr></table></figure></li><li><p>测试安装成功</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose version</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">效果</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211124200658107.png" alt="image-20211124200658107"></td></tr></tbody></table></li></ul><h3 id="Integrate-工具"><a href="#Integrate-工具" class="headerlink" title="Integrate 工具"></a>Integrate 工具</h3><p>持续集成、持续部署的工具很多，其中 Jenkins 是一个开源的持续集成平台。</p><p>Jenkins 涉及到将编写完毕的代码发布到测试环境和生产环境的任务，并且还涉及到了构建项目等任务。</p><p>Jenkins 需要大量的插件保证工作，安装成本较高，下面会基于 Docker 搭建 Jenkins。</p><h4 id="Jenkins-介绍"><a href="#Jenkins-介绍" class="headerlink" title="Jenkins 介绍"></a>Jenkins 介绍</h4><p>Jenkins 是一个开源软件项目，是基于 Java 开发的一种持续集成工具</p><p>Jenkins 应用广泛，大多数互联网公司都采用 Jenkins 配合 GitLab、Docker、K8s 作为实现<a href="">DevOps</a>的核心工具。</p><p>Jenkins 最强大的就在于插件，Jenkins 官方提供了大量的插件库，来自动化 CI&#x2F;CD 过程中的各种琐碎功能。</p><table><thead><tr><th align="center"></th><th align="center"></th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125141950900.png" alt="image-20211125141950900"></td><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125141701495.png" alt="image-20211124200317795"></td></tr></tbody></table><p>Jenkins 最主要的工作就是将 GitLab 上可以构建的工程代码拉取并且进行构建，再根据流程可以选择发布到测试环境或是生产环境。</p><p>一般是 GitLab 上的代码经过大量的测试后，确定发行版本，再发布到生产环境。</p><p>CI&#x2F;CD 可以理解为：</p><ul><li>CI 过程即是通过 Jenkins 将代码拉取、构建、制作镜像交给测试人员测试。<ul><li>持续集成：让软件代码可以持续的集成到主干上，并自动构建和测试。</li></ul></li><li>CD 过程即是通过 Jenkins 将打好标签的发行版本代码拉取、构建、制作镜像交给运维人员部署。<ul><li>持续交付：让经过持续集成的代码可以进行手动部署。</li><li>持续部署：让可以持续交付的代码随时随地的自动化部署。</li></ul></li></ul><table><thead><tr><th align="center">CI、CD</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125154112097.png" alt="image-20211125154112097"></td></tr></tbody></table><h4 id="Jenkins-安装"><a href="#Jenkins-安装" class="headerlink" title="Jenkins 安装"></a>Jenkins 安装</h4><ul><li><p>拉取 Jenkins 镜像</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull jenkins/jenkins</span><br></pre></td></tr></table></figure></li><li><p>编写 docker-compose.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.1&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">jenkins:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">jenkins/jenkins</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">jenkins</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:8080</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">50000</span><span class="string">:50000</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/:/var/jenkins_home/</span></span><br></pre></td></tr></table></figure></li><li><p>首次启动会因为数据卷 data 目录没有权限导致启动失败，设置 data 目录写权限</p><table><thead><tr><th align="center">错误日志</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211124202610243.png" alt="image-20211124202610243"></td></tr></tbody></table><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> -R a+w data/</span><br></pre></td></tr></table></figure></li><li><p>重新启动 Jenkins 容器后，由于 Jenkins 需要下载大量内容，但是由于默认下载地址下载速度较慢，需要重新设置下载地址为国内镜像站</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改数据卷中的hudson.model.UpdateCenter.xml文件</span></span><br><span class="line">&lt;?xml version=<span class="string">&#x27;1.1&#x27;</span> encoding=<span class="string">&#x27;UTF-8&#x27;</span>?&gt;</span><br><span class="line">&lt;sites&gt;</span><br><span class="line">  &lt;site&gt;</span><br><span class="line">    &lt;<span class="built_in">id</span>&gt;default&lt;/id&gt;</span><br><span class="line">    &lt;url&gt;https://updates.jenkins.io/update-center.json&lt;/url&gt;</span><br><span class="line">  &lt;/site&gt;</span><br><span class="line">&lt;/sites&gt;</span><br><span class="line"><span class="comment"># 将下载地址替换为http://mirror.esuni.jp/jenkins/updates/update-center.json</span></span><br><span class="line">&lt;?xml version=<span class="string">&#x27;1.1&#x27;</span> encoding=<span class="string">&#x27;UTF-8&#x27;</span>?&gt;</span><br><span class="line">&lt;sites&gt;</span><br><span class="line">  &lt;site&gt;</span><br><span class="line">    &lt;<span class="built_in">id</span>&gt;default&lt;/id&gt;</span><br><span class="line">    &lt;url&gt;http://mirror.esuni.jp/jenkins/updates/update-center.json&lt;/url&gt;</span><br><span class="line">  &lt;/site&gt;</span><br><span class="line">&lt;/sites&gt;</span><br><span class="line"><span class="comment"># 清华大学的插件源也可以https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</span></span><br></pre></td></tr></table></figure></li><li><p>再次重启 Jenkins 容器，访问 Jenkins（需要稍微等会）</p><table><thead><tr><th align="center">Jenkins 首页</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211124204517433.png" alt="image-20211124204517433"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211124203336300.png" alt="image-20211124203336300"></td></tr></tbody></table></li><li><p>查看密码登录 Jenkins，并登录下载插件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it jenkins <span class="built_in">cat</span> /var/jenkins_home/secrets/initialAdminPassword</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">登录并下载插件</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211124205050484.png" alt="image-20211124205050484"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211124205513465.png" alt="image-20211124205513465"></td></tr></tbody></table></li><li><p>选择需要安装的插件</p><table><thead><tr><th align="center">选择需要安装的插件</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211124205854418.png" alt="image-20211124205854418"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211124205858730.png" alt="image-20211124205858730"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211124205917317.png" alt="image-20211124205917317"></td></tr></tbody></table></li><li><p>下载完毕设置信息进入首页（可能会出现下载失败的插件）</p><table><thead><tr><th></th></tr></thead><tbody><tr><td><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211124211635550.png" alt="image-20211124211635550"></td></tr><tr><td><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211124211700999.png" alt="image-20211124211700999"></td></tr><tr><td><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211124211720836.png" alt="image-20211124211720836"></td></tr></tbody></table></li></ul><h4 id="Jenkins-入门配置"><a href="#Jenkins-入门配置" class="headerlink" title="Jenkins 入门配置"></a>Jenkins 入门配置</h4><p>由于 Jenkins 需要从 Git 拉取代码、需要本地构建、甚至需要直接发布自定义镜像到 Docker 仓库，所以 Jenkins 需要配置大量内容。</p><h5 id="构建任务"><a href="#构建任务" class="headerlink" title="构建任务"></a>构建任务</h5><p>准备好 GitLab 仓库中的项目，并且通过 Jenkins 配置项目的实现当前项目的<a href="">DevOps</a>基本流程。</p><ul><li><p>构建 Maven 工程发布到 GitLab（Gitee、Github 均可）</p><table><thead><tr><th align="center">GitLab 查看项目</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125195818670.png" alt="image-20211125195818670"></td></tr></tbody></table></li><li><p>Jenkins 点击左侧导航新建任务</p><table><thead><tr><th align="center">新建任务</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125163541645.png" alt="image-20211125163541645"></td></tr></tbody></table></li><li><p>选择自由风格构建任务</p><table><thead><tr><th align="center">构建任务</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125170350811.png" alt="image-20211125170350811"></td></tr></tbody></table></li></ul><h5 id="配置源码拉取地址"><a href="#配置源码拉取地址" class="headerlink" title="配置源码拉取地址"></a>配置源码拉取地址</h5><p>Jenkins 需要将 Git 上存放的源码存储到 Jenkins 服务所在磁盘的本地</p><ul><li><p>配置任务源码拉取的地址</p><table><thead><tr><th align="center">源码管理</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125170418337.png" alt="image-20211125170418337"></td></tr></tbody></table></li><li><p>Jenkins 立即构建</p><table><thead><tr><th align="center">点击任务 test 中的立即构建</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125200218093.png" alt="image-20211125200218093"></td></tr></tbody></table></li><li><p>查看构建工程的日志，点击上述 ③ 的任务条即可</p><table><thead><tr><th align="center">查看任务拉取 Git 源码日志</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125201701443.png" alt="image-20211125201701443"></td></tr></tbody></table><p>可以看到源码已经拉取带 Jenkins 本地，可以根据第三行日志信息，查看 Jenkins 本地拉取到的源码。</p></li><li><p>查看 Jenkins 容器中<a href="">&#x2F;var&#x2F;jenkins_home&#x2F;workspace&#x2F;test</a>的源码</p><table><thead><tr><th align="center">源码存放位置</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125201919108.png" alt="image-20211125201919108"></td></tr></tbody></table></li></ul><h5 id="配置-Maven-构建代码"><a href="#配置-Maven-构建代码" class="headerlink" title="配置 Maven 构建代码"></a>配置 Maven 构建代码</h5><p>代码拉取到 Jenkins 本地后，需要在 Jenkins 中对代码进行构建，这里需要 Maven 的环境，而 Maven 需要 Java 的环境，接下来需要在 Jenkins 中安装 JDK 和 Maven，并且配置到 Jenkins 服务。</p><ul><li><p>准备 JDK、Maven 压缩包通过数据卷映射到 Jenkins 容器内部</p><table><thead><tr><th align="center">数据卷存放位置</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125203757232.png" alt="image-20211125203757232"></td></tr></tbody></table></li><li><p>解压压缩包，并配置 Maven 的 settings.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 阿里云镜像地址 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- JDK1.8编译插件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>jdk-1.8<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdk</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">jdk</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.compilerVersion</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.compilerVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>Jenkins 配置 JDK&amp;Maven 并保存</p><table><thead><tr><th></th></tr></thead><tbody><tr><td><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125204811759.png" alt="image-20211125204811759"></td></tr><tr><td><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125204818869.png" alt="image-20211125204818869"></td></tr></tbody></table></li><li><p>配置 Jenkins 任务构建代码</p><table><thead><tr><th align="center">配置 Maven 构建代码</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125205027013.png" alt="image-20211125205027013"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125205020738.png" alt="image-20211125205020738"></td></tr></tbody></table></li><li><p>立即构建测试，查看 target 下的 jar 包</p><table><thead><tr><th align="center">构建源码</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125205240208.png" alt="image-20211125205240208"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125205725948.png" alt="image-20211125205725948"></td></tr></tbody></table></li></ul><h5 id="配置-Publish-发布-远程操作"><a href="#配置-Publish-发布-远程操作" class="headerlink" title="配置 Publish 发布&amp;远程操作"></a>配置 Publish 发布&amp;远程操作</h5><p>jar 包构建好之后，就可以根据情况发布到测试或生产环境，这里需要用到之前下载好的插件 Publish Over SSH。</p><ul><li><p>配置 Publish Over SSH 连接测试、生产环境</p><table><thead><tr><th align="center">Publish Over SSH 配置</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125210148202.png" alt="image-20211125210148202"></td></tr></tbody></table></li><li><p>配置任务的构建后操作，发布 jar 包到目标服务</p><table><thead><tr><th align="center">配置构建后操作</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125205027013.png" alt="image-20211125205027013"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125210424346.png" alt="image-20211125210424346"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125210626631.png" alt="image-20211125210626631"></td></tr></tbody></table></li><li><p>立即构建任务，并去目标服务查看</p><table><thead><tr><th align="center">立即构建</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125210755556.png" alt="image-20211125210755556"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211125210826057.png" alt="image-20211125210826057"></td></tr></tbody></table></li></ul><h3 id="CI、CD-入门操作"><a href="#CI、CD-入门操作" class="headerlink" title="CI、CD 入门操作"></a>CI、CD 入门操作</h3><p>基于 Jenkins 拉取 GitLab 的 SpringBoot 代码进行构建发布到测试环境实现持续集成</p><p>基于 Jenkins 拉取 GitLab 指定发行版本的 SpringBoot 代码进行构建发布到生产环境实现 CD 实现持续部署</p><h4 id="持续集成"><a href="#持续集成" class="headerlink" title="持续集成"></a>持续集成</h4><p>为了让程序代码可以自动推送到测试环境基于 Docker 服务运行，需要添加 Docker 配置和脚本文件让程序可以在集成到主干的同时运行起来。</p><ul><li><p>添加 Dockerfile 文件</p><table><thead><tr><th align="center">构建自定义镜像</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211126161304485.png" alt="image-20211126161304485"></td></tr></tbody></table></li><li><p>添加 docker-compose.yml 文件</p><table><thead><tr><th align="center">加载自定义镜像启动容器</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211126161331991.png" alt="image-20211126161331991"></td></tr></tbody></table></li><li><p>追加 Jenkins 构建后操作脚本命令</p><table><thead><tr><th align="center">构建后发布并执行脚本命令</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211126161408514.png" alt="image-20211126161408514"></td></tr></tbody></table></li><li><p>发布到 GitLab 后由 Jenkins 立即构建并托送到目标服务器</p><table><thead><tr><th align="center">构建日志</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211126161448527.png" alt="image-20211126161448527"></td></tr></tbody></table></li><li><p>测试部署到目标服务器程序</p><table><thead><tr><th align="center">查看目标服务器并测试接口</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211126161504715.png" alt="image-20211126161504715"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211126161509411.png" alt="image-20211126161509411"></td></tr></tbody></table></li></ul><h4 id="持续交付、部署"><a href="#持续交付、部署" class="headerlink" title="持续交付、部署"></a>持续交付、部署</h4><p>程序代码在经过多次集成操作到达最终可以交付，持续交付整体流程和持续集成类似，不过需要选取指定的发行版本</p><ul><li><p>下载 Git Parameter 插件</p><table><thead><tr><th align="center">下载 Git Parameter</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211126165209057.png" alt="image-20211126165209057"></td></tr></tbody></table></li><li><p>设置项目参数化构建</p><table><thead><tr><th align="center">基于 Git 标签构建</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211126165444124.png" alt="image-20211126165444124"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211126172828266.png" alt="image-20211126172828266"></td></tr></tbody></table></li><li><p>给项目添加 tag 版本</p><table><thead><tr><th align="center">添加 tag 版本</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211126165639286.png" alt="image-20211126165639286"></td></tr></tbody></table></li><li><p>任务构建时，采用 Shell 方式构建，拉取指定 tag 版本代码</p><table><thead><tr><th align="center">切换指定标签并构建项目</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211126174715028.png" alt="image-20211126174715028"></td></tr></tbody></table></li><li><p>基于 Parameter 构建任务，任务发布到目标服务器</p><table><thead><tr><th align="center">构建任务</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211126174159487.png" alt="image-20211126174159487"></td></tr></tbody></table></li></ul><h3 id="集成-Sonar-Qube"><a href="#集成-Sonar-Qube" class="headerlink" title="集成 Sonar Qube"></a>集成 Sonar Qube</h3><h4 id="Sonar-Qube-介绍"><a href="#Sonar-Qube-介绍" class="headerlink" title="Sonar Qube 介绍"></a>Sonar Qube 介绍</h4><p>Sonar Qube 是一个开源的代码分析平台，支持 Java、Python、PHP、JavaScript、CSS 等 25 种以上的语言，可以检测出重复代码、代码漏洞、代码规范和安全性漏洞的问题。</p><p>Sonar Qube 可以与多种软件整合进行代码扫描，比如 Maven，Gradle，Git，Jenkins 等，并且会将代码检测结果推送回 Sonar Qube 并且在系统提供的 UI 界面上显示出来</p><table><thead><tr><th align="center">Sonar Qube 的 UI 界面</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211129190039986.png" alt="image-20211129190039986"></td></tr></tbody></table><h4 id="Sonar-Qube-环境搭建"><a href="#Sonar-Qube-环境搭建" class="headerlink" title="Sonar Qube 环境搭建"></a>Sonar Qube 环境搭建</h4><h5 id="Sonar-Qube-安装"><a href="#Sonar-Qube-安装" class="headerlink" title="Sonar Qube 安装"></a>Sonar Qube 安装</h5><p>Sonar Qube 在 7.9 版本中已经放弃了对 MySQL 的支持，并且建议在商业环境中采用 PostgreSQL，那么安装 Sonar Qube 时需要依赖 PostgreSQL。</p><p>并且这里会安装 Sonar Qube 的长期支持版本<a href="">8.9</a></p><ul><li><p>拉取镜像</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull postgres</span><br><span class="line">docker pull sonarqube:8.9.3-community</span><br></pre></td></tr></table></figure></li><li><p>编写 docker-compoe.yml</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.1&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">5432</span><span class="string">:5432</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sonarnet</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">POSTGRES_USER:</span> <span class="string">sonar</span></span><br><span class="line">      <span class="attr">POSTGRES_PASSWORD:</span> <span class="string">sonar</span></span><br><span class="line">  <span class="attr">sonarqube:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">sonarqube:8.9.3-community</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">sonarqube</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;9000:9000&#x27;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sonarnet</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SONAR_JDBC_URL:</span> <span class="string">jdbc:postgresql://db:5432/sonar</span></span><br><span class="line">      <span class="attr">SONAR_JDBC_USERNAME:</span> <span class="string">sonar</span></span><br><span class="line">      <span class="attr">SONAR_JDBC_PASSWORD:</span> <span class="string">sonar</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">sonarnet:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure></li><li><p>启动容器</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure></li><li><p>需要设置 sysctl.conf 文件信息</p><table><thead><tr><th align="center">设置 vm.max_map_count</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211207145215817.png" alt="image-20211207145215817"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211207145342350.png" alt="image-20211207145342350"></td></tr></tbody></table><p>并执行命令刷新</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure></li><li><p>重新启动需要一定时间启动，可以可以查看容器日志，看到如下内容代表启动成功</p><table><thead><tr><th align="center">容器日志</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211129191426344.png" alt="image-20211129191426344"></td></tr></tbody></table></li><li><p>访问 Sonar Qube 首页</p><table><thead><tr><th align="center">登录</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211129191537050.png" alt="image-20211129191537050"></td></tr></tbody></table></li><li><p>还需要重新设置一次密码</p><table><thead><tr><th align="center">重新设置密码</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211129193824428.png" alt="image-20211129193824428"></td></tr></tbody></table></li><li><p>Sonar Qube 首页</p><table><thead><tr><th align="center">Sonar Qube 首页</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211129194148239.png" alt="image-20211129194148239"></td></tr></tbody></table></li></ul><h5 id="安装中文插件"><a href="#安装中文插件" class="headerlink" title="安装中文插件"></a>安装中文插件</h5><table><thead><tr><th align="center">安装中文插件</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211129194621820.png" alt="image-20211129194621820"></td></tr></tbody></table><p>安装成功后需要重启，安装失败重新点击 install 重装即可。</p><p>安装成功后，会查看到重启按钮，点击即可</p><table><thead><tr><th align="center">重启按钮</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211129194748765.png" alt="image-20211129194748765"></td></tr></tbody></table><p>重启后查看效果</p><table><thead><tr><th align="center">首页效果</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211129194931944.png" alt="image-20211129194931944"></td></tr></tbody></table><h4 id="Sonar-Qube-基本使用"><a href="#Sonar-Qube-基本使用" class="headerlink" title="Sonar Qube 基本使用"></a>Sonar Qube 基本使用</h4><p>Sonar Qube 的使用方式很多，Maven 可以整合，也可以采用 sonar-scanner 的方式，再查看 Sonar Qube 的检测效果</p><h5 id="Maven-实现代码检测"><a href="#Maven-实现代码检测" class="headerlink" title="Maven 实现代码检测"></a>Maven 实现代码检测</h5><ul><li><p>修改 Maven 的 settings.xml 文件配置 Sonar Qube 信息</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>sonar<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sonar.login</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">sonar.login</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sonar.password</span>&gt;</span>123456789<span class="tag">&lt;/<span class="name">sonar.password</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sonar.host.url</span>&gt;</span>http://192.168.11.11:9000<span class="tag">&lt;/<span class="name">sonar.host.url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>在代码位置执行命令：mvn sonar:sonar</p><table><thead><tr><th align="center">执行代码检测</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211129195430146.png" alt="image-20211129195430146"></td></tr></tbody></table></li><li><p>查看 Sonar Qube 界面检测结果</p><table><thead><tr><th align="center">Sonar Qube 检测结果</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211129195503762.png" alt="image-20211129195503762"></td></tr></tbody></table></li></ul><h5 id="Sonar-scanner-实现代码检测"><a href="#Sonar-scanner-实现代码检测" class="headerlink" title="Sonar-scanner 实现代码检测"></a>Sonar-scanner 实现代码检测</h5><ul><li><p>下载 Sonar-scanner：<a target="_blank" rel="noopener" href="https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/">https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/</a></p><p>下载 4.6.x 版本即可，要求 Linux 版本</p></li><li><p>解压并配置 sonar 服务端信息</p><ul><li><p>由于是 zip 压缩包，需要安装 unzip 解压插件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install unzip</span><br></pre></td></tr></table></figure></li><li><p>解压压缩包</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip sonar-scanner-cli/sonar-scanner-cli-4.6.0.2311-linux.zip</span><br></pre></td></tr></table></figure></li><li><p>配置 sonarQube 服务端地址，修改 conf 下的 sonar-scanner.properties</p><table><thead><tr><th align="center">配置服务端信息</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211130140043382.png" alt="image-20211130140043382"></td></tr></tbody></table></li></ul></li><li><p>执行命令检测代码</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在项目所在目录执行以下命令</span></span><br><span class="line">~/sonar-scanner/bin/sonar-scanner -Dsonar.sources=./ -Dsonar.projectname=demo -Dsonar.projectKey=java -Dsonar.java.binaries=target/</span><br></pre></td></tr></table></figure><p><a href="">Ps：主要查看我的 sonar-scanner 执行命令的位置</a></p><table><thead><tr><th align="center">查看日志信息</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211130141303457.png" alt="image-20211130141303457"></td></tr></tbody></table></li><li><p>查看 SonarQube 界面检测结果</p><table><thead><tr><th align="center">检测结果</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211130144608025.png" alt="image-20211130144608025"></td></tr></tbody></table></li></ul><h4 id="Jenkins-集成-Sonar-Qube"><a href="#Jenkins-集成-Sonar-Qube" class="headerlink" title="Jenkins 集成 Sonar Qube"></a>Jenkins 集成 Sonar Qube</h4><p>Jenkins 继承 Sonar Qube 实现代码扫描需要先下载整合插件</p><h5 id="Jenkins-安装插件"><a href="#Jenkins-安装插件" class="headerlink" title="Jenkins 安装插件"></a>Jenkins 安装插件</h5><table><thead><tr><th align="center">下载 Sonar Qube 插件</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211129201625561.png" alt="image-20211129201625561"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211129201607240.png" alt="image-20211129201607240"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211129202147390.png" alt="image-20211129202147390"></td></tr></tbody></table><h5 id="Jenkins-配置-Sonar-Qube"><a href="#Jenkins-配置-Sonar-Qube" class="headerlink" title="Jenkins 配置 Sonar Qube"></a>Jenkins 配置 Sonar Qube</h5><ul><li><p>开启 Sonar Qube 权限验证</p><table><thead><tr><th align="center">开启 Sonar Qube 权限校验</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211130144850186.png" alt="image-20211130144850186"></td></tr></tbody></table></li><li><p>获取 Sonar Qube 的令牌</p><table><thead><tr><th align="center">获取令牌</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211129203102334.png" alt="image-20211129203102334"></td></tr></tbody></table></li><li><p>配置 Jenkins 的 Sonar Qube 信息</p><table><thead><tr><th></th></tr></thead><tbody><tr><td><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211129203235019.png" alt="image-20211129203235019"></td></tr><tr><td><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211129203342171.png" alt="image-20211129203342171"></td></tr><tr><td><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211129203457604.png" alt="image-20211129203457604"></td></tr></tbody></table></li></ul><h5 id="配置-Sonar-scanner"><a href="#配置-Sonar-scanner" class="headerlink" title="配置 Sonar-scanner"></a>配置 Sonar-scanner</h5><ul><li><p>将 Sonar-scaner 添加到 Jenkins 数据卷中并配置全局配置</p><table><thead><tr><th align="center">配置 Sonar-scanner</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211130153628925.png" alt="image-20211130153628925"></td></tr></tbody></table></li><li><p>配置任务的 Sonar-scanner</p><table><thead><tr><th align="center">配置任务的 Sonar-scanner</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211130155849143.png" alt="image-20211130155849143"></td></tr></tbody></table></li></ul><h5 id="构建任务-1"><a href="#构建任务-1" class="headerlink" title="构建任务"></a>构建任务</h5><table><thead><tr><th align="center">构建任务</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211130160017465.png" alt="image-20211130160017465"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211130160047648.png" alt="image-20211130160047648"></td></tr></tbody></table><h3 id="集成-Harbor"><a href="#集成-Harbor" class="headerlink" title="集成 Harbor"></a>集成 Harbor</h3><h4 id="Harbor-介绍"><a href="#Harbor-介绍" class="headerlink" title="Harbor 介绍"></a>Harbor 介绍</h4><p>前面在部署项目时，我们主要采用 Jenkins 推送 jar 包到指定服务器，再通过脚本命令让目标服务器对当前 jar 进行部署，这种方式在项目较多时，每个目标服务器都需要将 jar 包制作成自定义镜像再通过 docker 进行启动，重复操作比较多，会降低项目部署时间。</p><p>我们可以通过 Harbor 作为私有的 Docker 镜像仓库。让 Jenkins 统一将项目打包并制作成 Docker 镜像发布到 Harbor 仓库中，只需要通知目标服务，让目标服务统一去 Harbor 仓库上拉取镜像并在本地部署即可。</p><p>Docker 官方提供了 Registry 镜像仓库，但是 Registry 的功能相对简陋。Harbor 是 VMware 公司提供的一款镜像仓库，提供了权限控制、分布式发布、强大的安全扫描与审查机制等功能</p><h4 id="Harbor-安装"><a href="#Harbor-安装" class="headerlink" title="Harbor 安装"></a>Harbor 安装</h4><p>这里采用原生的方式安装 Harbor。</p><ul><li><p>下载 Harbor 安装包：<a target="_blank" rel="noopener" href="https://github.com/goharbor/harbor/releases/download/v2.3.4/harbor-offline-installer-v2.3.4.tgz">https://github.com/goharbor/harbor/releases/download/v2.3.4/harbor-offline-installer-v2.3.4.tgz</a></p></li><li><p>拖拽到 Linux 并解压：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf harbor-offline-installer-v2.3.4.tgz -C /usr/local/</span><br></pre></td></tr></table></figure></li><li><p>修改 Harbor 配置文件：</p><ul><li><p>首先复制一份 harbor.yml 配置</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> harbor.yml.tmpl harbor.yml</span><br></pre></td></tr></table></figure></li><li><p>编辑 harbor.yml 配置文件</p><table><thead><tr><th align="center">配置 Harbor 文件</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211130215555218.png" alt="image-20211130215555218"></td></tr></tbody></table></li></ul></li><li><p>启动 Harbor</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./install.sh</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">查看日志</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211130215941857.png" alt="image-20211130215941857"></td></tr></tbody></table></li><li><p>登录 Harbor</p><table><thead><tr><th align="center">登录 Harbor</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211130220028840.png" alt="image-20211130220028840"></td></tr></tbody></table></li><li><p>首页信息</p><table><thead><tr><th align="center">首页信息</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211130220111602.png" alt="image-20211130220111602"></td></tr></tbody></table></li></ul><h4 id="Harbor-使用方式"><a href="#Harbor-使用方式" class="headerlink" title="Harbor 使用方式"></a>Harbor 使用方式</h4><p>Harbor 作为镜像仓库，主要的交互方式就是将镜像上传到 Harbor 上，以及从 Harbor 上下载指定镜像</p><p>在传输镜像前，可以先使用 Harbor 提供的权限管理，将项目设置为私有项目，并对不同用户设置不同角色，从而更方便管理镜像。</p><h5 id="添加用户构建项目"><a href="#添加用户构建项目" class="headerlink" title="添加用户构建项目"></a>添加用户构建项目</h5><ul><li><p>创建用户</p><table><thead><tr><th align="center">创建用户</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211201213427157.png" alt="image-20211201213427157"></td></tr></tbody></table></li><li><p>构建项目（设置为私有）</p><table><thead><tr><th align="center">构建项目</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211201213751780.png" alt="image-20211201213751780"></td></tr></tbody></table></li><li><p>给项目追加用户</p><table><thead><tr><th align="center">追加用户管理</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211201213832458.png" alt="image-20211201213832458"></td></tr></tbody></table></li><li><p>切换测试用户</p><table><thead><tr><th align="center">切换测试用户</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211201214008303.png" alt="image-20211201214008303"></td></tr></tbody></table></li></ul><h5 id="发布镜像到-Harbor"><a href="#发布镜像到-Harbor" class="headerlink" title="发布镜像到 Harbor"></a>发布镜像到 Harbor</h5><ul><li><p>修改镜像名称</p><p>名称要求：<a href="">harbor 地址&#x2F;项目名&#x2F;镜像名:版本</a></p><table><thead><tr><th>修改镜像名称</th></tr></thead><tbody><tr><td><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211201221040200.png" alt="image-20211201221040200"></td></tr></tbody></table></li><li><p>修改 daemon.json，支持 Docker 仓库，并重启 Docker</p><table><thead><tr><th align="center">修改 daemon.json，支持 Docker 仓库</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211201215931237.png" alt="image-20211201215931237"></td></tr></tbody></table></li><li><p>设置登录仓库信息</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login -u 用户名 -p 密码 Harbor地址</span><br></pre></td></tr></table></figure></li><li><p>推送镜像到 Harbor</p><table><thead><tr><th align="center">推送镜像到 Harbor</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211201221225196.png" alt="image-20211201221225196"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211201221300055.png" alt="image-20211201221300055"></td></tr></tbody></table></li></ul><h5 id="从-Harbor-拉取镜像-ls"><a href="#从-Harbor-拉取镜像-ls" class="headerlink" title="从 Harbor 拉取镜像 ls"></a>从 Harbor 拉取镜像 ls</h5><p>跟传统方式一样，不过需要先配置<a href="">&#x2F;etc&#x2F;docker&#x2F;daemon.json</a>文件</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;registry-mirrors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;https://pee6w651.mirror.aliyuncs.com&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;insecure-registries&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;192.168.11.11:80&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">拉取镜像</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211201222450091.png" alt="image-20211201222450091"></td></tr></tbody></table><h5 id="Jenkins-容器使用宿主机-Docker"><a href="#Jenkins-容器使用宿主机-Docker" class="headerlink" title="Jenkins 容器使用宿主机 Docker"></a>Jenkins 容器使用宿主机 Docker</h5><p>构建镜像和发布镜像到 harbor 都需要使用到 docker 命令。而在 Jenkins 容器内部安装 Docker 官方推荐直接采用宿主机带的 Docker 即可。</p><p>设置 Jenkins 容器使用宿主机 Docker</p><ul><li><p>设置宿主机 docker.sock 权限：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chown</span> root:root /var/run/docker.sock</span><br><span class="line">sudo <span class="built_in">chmod</span> o+rw /var/run/docker.sock</span><br></pre></td></tr></table></figure></li><li><p>添加数据卷</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.1&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">jenkins:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">jenkins/jenkins</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">jenkins</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:8080</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">50000</span><span class="string">:50000</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/:/var/jenkins_home/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/bin/docker:/usr/bin/docker</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/docker/daemon.json:/etc/docker/daemon.json</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="添加构建操作"><a href="#添加构建操作" class="headerlink" title="添加构建操作"></a>添加构建操作</h5><table><thead><tr><th align="center">制作自定义镜像</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211229155834500.png" alt="image-20211229155834500"></td></tr></tbody></table><h5 id="编写部署脚本"><a href="#编写部署脚本" class="headerlink" title="编写部署脚本"></a>编写部署脚本</h5><p>部署项目需要通过 Publish Over SSH 插件，让目标服务器执行命令。为了方便一次性实现拉取镜像和启动的命令，推荐采用脚本文件的方式。</p><p>添加脚本文件到目标服务器，再通过 Publish Over SSH 插件让目标服务器执行脚本即可。</p><ul><li><p>编写脚本文件，添加到目标服务器</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">harbor_url=<span class="variable">$1</span></span><br><span class="line">harbor_project_name=<span class="variable">$2</span></span><br><span class="line">project_name=<span class="variable">$3</span></span><br><span class="line">tag=<span class="variable">$4</span></span><br><span class="line">port=<span class="variable">$5</span></span><br><span class="line"></span><br><span class="line">imageName=<span class="variable">$harbor_url</span>/<span class="variable">$harbor_project_name</span>/<span class="variable">$project_name</span>:<span class="variable">$tag</span></span><br><span class="line"></span><br><span class="line">containerId=`docker ps -a | grep <span class="variable">$&#123;project_name&#125;</span> | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$containerId</span>&quot;</span> != <span class="string">&quot;&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">    docker stop <span class="variable">$containerId</span></span><br><span class="line">    docker <span class="built_in">rm</span> <span class="variable">$containerId</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Delete Container Success&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">imageId=`docker images | grep <span class="variable">$&#123;project_name&#125;</span> | awk <span class="string">&#x27;&#123;print $3&#125;&#x27;</span>`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$imageId</span>&quot;</span> != <span class="string">&quot;&quot;</span> ] ; <span class="keyword">then</span></span><br><span class="line">    docker rmi -f <span class="variable">$imageId</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Delete Image Success&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">docker login -u DevOps -p P@ssw0rd <span class="variable">$harbor_url</span></span><br><span class="line"></span><br><span class="line">docker pull <span class="variable">$imageName</span></span><br><span class="line"></span><br><span class="line">docker run -d -p <span class="variable">$port</span>:<span class="variable">$port</span> --name <span class="variable">$project_name</span> <span class="variable">$imageName</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Start Container Success&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$project_name</span></span><br></pre></td></tr></table></figure><p>并设置权限为可执行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod a+x deploy.sh</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">如图</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211203192047357.png" alt="image-20211203192047357"></td></tr></tbody></table></li></ul><h5 id="配置构建后操作"><a href="#配置构建后操作" class="headerlink" title="配置构建后操作"></a>配置构建后操作</h5><table><thead><tr><th align="center">执行脚本文件</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211229155949038.png" alt="image-20211229155949038"></td></tr></tbody></table><h3 id="Jenkins-流水线"><a href="#Jenkins-流水线" class="headerlink" title="Jenkins 流水线"></a>Jenkins 流水线</h3><h4 id="Jenkins-流水线任务介绍"><a href="#Jenkins-流水线任务介绍" class="headerlink" title="Jenkins 流水线任务介绍"></a>Jenkins 流水线任务介绍</h4><p>之前采用 Jenkins 的自由风格构建的项目，每个步骤流程都要通过不同的方式设置，并且构建过程中整体流程是不可见的，无法确认每个流程花费的时间，并且问题不方便定位问题。</p><p>Jenkins 的 Pipeline 可以让项目的发布整体流程可视化，明确执行的阶段，可以快速的定位问题。并且整个项目的生命周期可以通过一个 Jenkinsfile 文件管理，而且 Jenkinsfile 文件是可以放在项目中维护。</p><p>所以 Pipeline 相对自由风格或者其他的项目风格更容易操作。</p><h4 id="Jenkins-流水线任务"><a href="#Jenkins-流水线任务" class="headerlink" title="Jenkins 流水线任务"></a>Jenkins 流水线任务</h4><h5 id="构建-Jenkins-流水线任务"><a href="#构建-Jenkins-流水线任务" class="headerlink" title="构建 Jenkins 流水线任务"></a>构建 Jenkins 流水线任务</h5><ul><li><p>构建任务</p><table><thead><tr><th>构建 Jenkins 流水线任务</th></tr></thead><tbody><tr><td><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211202144429302.png" alt="image-20211202144429302"></td></tr></tbody></table></li><li><p>生成 Groovy 脚本</p><table><thead><tr><th align="center">Hello World 脚本生成</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211202144531749.png" alt="image-20211202144531749"></td></tr></tbody></table></li><li><p>构建后查看视图</p><table><thead><tr><th align="center">构建后查看视图</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211202144616117.png" alt="image-20211202144616117"></td></tr></tbody></table></li></ul><h5 id="Groovy-脚本"><a href="#Groovy-脚本" class="headerlink" title="Groovy 脚本"></a>Groovy 脚本</h5><ul><li><p>Groovy 脚本基础语法</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">// 所有脚本命令包含在pipeline&#123;&#125;中</span><br><span class="line">pipeline &#123;</span><br><span class="line">	// 指定任务在哪个节点执行（Jenkins支持分布式）</span><br><span class="line">    agent any</span><br><span class="line"></span><br><span class="line">    // 配置全局环境，指定变量名=变量值信息</span><br><span class="line">    environment&#123;</span><br><span class="line">    	host = <span class="string">&#x27;192.168.11.11&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 存放所有任务的合集</span><br><span class="line">    stages &#123;</span><br><span class="line">    	// 单个任务</span><br><span class="line">        stage(<span class="string">&#x27;任务1&#x27;</span>) &#123;</span><br><span class="line">        	// 实现任务的具体流程</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&#x27;do something&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">		// 单个任务</span><br><span class="line">        stage(<span class="string">&#x27;任务2&#x27;</span>) &#123;</span><br><span class="line">        	// 实现任务的具体流程</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&#x27;do something&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // ……</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>编写例子测试</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line"></span><br><span class="line">    // 存放所有任务的合集</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;拉取Git代码&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&#x27;拉取Git代码&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;检测代码质量&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&#x27;检测代码质量&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;构建代码&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&#x27;构建代码&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;制作自定义镜像并发布Harbor&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&#x27;制作自定义镜像并发布Harbor&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;基于Harbor部署工程&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&#x27;基于Harbor部署工程&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">配置 Grovvy 脚本</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211202145155428.png" alt="image-20211202145155428"></td></tr></tbody></table></li><li><p>查看效果</p><table><thead><tr><th align="center">查看效果</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211202145240166.png" alt="image-20211202145240166"></td></tr></tbody></table></li></ul><p><a href="">Ps：涉及到特定脚本，Jenkins 给予了充足的提示，可以自动生成命令</a></p><table><thead><tr><th align="center">生成命令位置</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211202145349043.png" alt="image-20211202145349043"></td></tr></tbody></table><h5 id="Jenkinsfile-实现"><a href="#Jenkinsfile-实现" class="headerlink" title="Jenkinsfile 实现"></a>Jenkinsfile 实现</h5><p>Jenkinsfile 方式需要将脚本内容编写到项目中的 Jenkinsfile 文件中，每次构建会自动拉取项目并且获取项目中 Jenkinsfile 文件对项目进行构建</p><ul><li><p>配置 pipeline</p><table><thead><tr><th align="center">配置 pipeline</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211202151127254.png" alt="image-20211202151127254"></td></tr></tbody></table></li><li><p>准备 Jenkinsfile</p><table><thead><tr><th align="center">准备 Jenkinsfile 文件</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211202151155145.png" alt="image-20211202151155145"></td></tr></tbody></table></li><li><p>测试效果</p><table><thead><tr><th align="center">测试效果</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211202151225161.png" alt="image-20211202151225161"></td></tr></tbody></table></li></ul><h4 id="Jenkins-流水线任务实现"><a href="#Jenkins-流水线任务实现" class="headerlink" title="Jenkins 流水线任务实现"></a>Jenkins 流水线任务实现</h4><h5 id="参数化构建"><a href="#参数化构建" class="headerlink" title="参数化构建"></a>参数化构建</h5><p>添加参数化构建，方便选择不的项目版本</p><table><thead><tr><th align="center">Git 参数化构建</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211202191944277.png" alt="image-20211202191944277"></td></tr></tbody></table><h5 id="拉取-Git-代码"><a href="#拉取-Git-代码" class="headerlink" title="拉取 Git 代码"></a>拉取 Git 代码</h5><p>通过流水线语法生成 Checkout 代码的脚本</p><table><thead><tr><th align="center">语法生成</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211202192047619.png" alt="image-20211202192047619"></td></tr></tbody></table><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211202192129895.png" alt="image-20211202192129895">将*&#x2F;master 更改为标签<a href="">${tag}</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;拉取Git代码&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([<span class="variable">$class</span>: <span class="string">&#x27;GitSCM&#x27;</span>, branches: [[name: <span class="string">&#x27;$&#123;tag&#125;&#x27;</span>]], extensions: [], userRemoteConfigs: [[url: <span class="string">&#x27;http://49.233.115.171:8929/root/test.git&#x27;</span>]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="构建代码"><a href="#构建代码" class="headerlink" title="构建代码"></a>构建代码</h5><p>通过脚本执行 mvn 的构建命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;拉取Git代码&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([<span class="variable">$class</span>: <span class="string">&#x27;GitSCM&#x27;</span>, branches: [[name: <span class="string">&#x27;$&#123;tag&#125;&#x27;</span>]], extensions: [], userRemoteConfigs: [[url: <span class="string">&#x27;http://49.233.115.171:8929/root/test.git&#x27;</span>]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;构建代码&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;/var/jenkins_home/maven/bin/mvn clean package -DskipTests&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="代码质量检测"><a href="#代码质量检测" class="headerlink" title="代码质量检测"></a>代码质量检测</h5><p>通过脚本执行 sonar-scanner 命令即可</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;拉取Git代码&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([<span class="variable">$class</span>: <span class="string">&#x27;GitSCM&#x27;</span>, branches: [[name: <span class="string">&#x27;$&#123;tag&#125;&#x27;</span>]], extensions: [], userRemoteConfigs: [[url: <span class="string">&#x27;http://49.233.115.171:8929/root/test.git&#x27;</span>]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;构建代码&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;/var/jenkins_home/maven/bin/mvn clean package -DskipTests&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;检测代码质量&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.sources=./ -Dsonar.projectname=$&#123;JOB_NAME&#125; -Dsonar.projectKey=$&#123;JOB_NAME&#125; -Dsonar.java.binaries=target/ -Dsonar.login=31388be45653876c1f51ec02f0d478e2d9d0e1fa&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="制作自定义镜像并发布"><a href="#制作自定义镜像并发布" class="headerlink" title="制作自定义镜像并发布"></a>制作自定义镜像并发布</h5><ul><li><p>生成自定义镜像脚本</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    environment&#123;</span><br><span class="line">        harborHost = <span class="string">&#x27;192.168.11.11:80&#x27;</span></span><br><span class="line">        harborRepo = <span class="string">&#x27;repository&#x27;</span></span><br><span class="line">        harborUser = <span class="string">&#x27;DevOps&#x27;</span></span><br><span class="line">        harborPasswd = <span class="string">&#x27;P@ssw0rd&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 存放所有任务的合集</span><br><span class="line">    stages &#123;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;拉取Git代码&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([<span class="variable">$class</span>: <span class="string">&#x27;GitSCM&#x27;</span>, branches: [[name: <span class="string">&#x27;$&#123;tag&#125;&#x27;</span>]], extensions: [], userRemoteConfigs: [[url: <span class="string">&#x27;http://49.233.115.171:8929/root/test.git&#x27;</span>]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;构建代码&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;/var/jenkins_home/maven/bin/mvn clean package -DskipTests&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;检测代码质量&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.sources=./ -Dsonar.projectname=$&#123;JOB_NAME&#125; -Dsonar.projectKey=$&#123;JOB_NAME&#125; -Dsonar.java.binaries=target/ -Dsonar.login=31388be45653876c1f51ec02f0d478e2d9d0e1fa&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;制作自定义镜像并发布Harbor&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;&#x27;</span><span class="string">&#x27;cp ./target/*.jar ./docker/</span></span><br><span class="line"><span class="string">                cd ./docker</span></span><br><span class="line"><span class="string">                docker build -t $&#123;JOB_NAME&#125;:$&#123;tag&#125; ./&#x27;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">                sh <span class="string">&#x27;&#x27;</span><span class="string">&#x27;docker login -u $&#123;harborUser&#125; -p $&#123;harborPasswd&#125; $&#123;harborHost&#125;</span></span><br><span class="line"><span class="string">                docker tag $&#123;JOB_NAME&#125;:$&#123;tag&#125; $&#123;harborHost&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:$&#123;tag&#125;</span></span><br><span class="line"><span class="string">                docker push $&#123;harborHost&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:$&#123;tag&#125;&#x27;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>生成 Publish Over SSH 脚本</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    environment&#123;</span><br><span class="line">        harborHost = <span class="string">&#x27;192.168.11.11:80&#x27;</span></span><br><span class="line">        harborRepo = <span class="string">&#x27;repository&#x27;</span></span><br><span class="line">        harborUser = <span class="string">&#x27;DevOps&#x27;</span></span><br><span class="line">        harborPasswd = <span class="string">&#x27;P@ssw0rd&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 存放所有任务的合集</span><br><span class="line">    stages &#123;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;拉取Git代码&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([<span class="variable">$class</span>: <span class="string">&#x27;GitSCM&#x27;</span>, branches: [[name: <span class="string">&#x27;$&#123;tag&#125;&#x27;</span>]], extensions: [], userRemoteConfigs: [[url: <span class="string">&#x27;http://49.233.115.171:8929/root/test.git&#x27;</span>]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;构建代码&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;/var/jenkins_home/maven/bin/mvn clean package -DskipTests&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;docker</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;检测代码质量&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.sources=./ -Dsonar.projectname=$&#123;JOB_NAME&#125; -Dsonar.projectKey=$&#123;JOB_NAME&#125; -Dsonar.java.binaries=target/ -Dsonar.login=7d66af4b39cfe4f52ac0a915d4c9d5c513207098&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;制作自定义镜像并发布Harbor&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;&#x27;</span><span class="string">&#x27;cp ./target/*.jar ./docker/</span></span><br><span class="line"><span class="string">                cd ./docker</span></span><br><span class="line"><span class="string">                docker build -t $&#123;JOB_NAME&#125;:$&#123;tag&#125; ./&#x27;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">                sh <span class="string">&#x27;&#x27;</span><span class="string">&#x27;docker login -u $&#123;harborUser&#125; -p $&#123;harborPasswd&#125; $&#123;harborHost&#125;</span></span><br><span class="line"><span class="string">                docker tag $&#123;JOB_NAME&#125;:$&#123;tag&#125; $&#123;harborHost&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:$&#123;tag&#125;</span></span><br><span class="line"><span class="string">                docker push $&#123;harborHost&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:$&#123;tag&#125;&#x27;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;目标服务器拉取镜像并运行&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sshPublisher(publishers: [sshPublisherDesc(configName: <span class="string">&#x27;testEnvironment&#x27;</span>, transfers: [sshTransfer(cleanRemote: <span class="literal">false</span>, excludes: <span class="string">&#x27;&#x27;</span>, execCommand: <span class="string">&quot;/usr/bin/deploy.sh <span class="variable">$harborHost</span> <span class="variable">$harborRepo</span> <span class="variable">$JOB_NAME</span> <span class="variable">$tag</span> <span class="variable">$port</span> &quot;</span>, execTimeout: 120000, flatten: <span class="literal">false</span>, makeEmptyDirs: <span class="literal">false</span>, noDefaultExcludes: <span class="literal">false</span>, patternSeparator: <span class="string">&#x27;[, ]+&#x27;</span>, remoteDirectory: <span class="string">&#x27;&#x27;</span>, remoteDirectorySDF: <span class="literal">false</span>, removePrefix: <span class="string">&#x27;&#x27;</span>, sourceFiles: <span class="string">&#x27;&#x27;</span>)], usePromotionTimestamp: <span class="literal">false</span>, useWorkspaceInPromotion: <span class="literal">false</span>, verbose: <span class="literal">false</span>)])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p><a href="">Ps：由于采用变量，记得使用双引号</a></p><h4 id="Jenkins-流水线整合钉钉"><a href="#Jenkins-流水线整合钉钉" class="headerlink" title="Jenkins 流水线整合钉钉"></a>Jenkins 流水线整合钉钉</h4><p>在程序部署成功后，可以通过钉钉的机器人及时向群众发送部署的最终结果通知</p><ul><li><p>安装插件</p><table><thead><tr><th align="center">安装插件</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211209151549412.png" alt="image-20211209151549412"></td></tr></tbody></table></li><li><p>钉钉内部创建群组并构建机器人</p><table><thead><tr><th align="center">钉钉内部创建群组并构建机器人</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211209152217433.png" alt="image-20211209152217433"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211209152252050.png" alt="image-20211209152252050"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211209152403312.png" alt="image-20211209152403312"></td></tr></tbody></table><p>最终或获取到 Webhook 信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://oapi.dingtalk.com/robot/send?access_token=kej4ehkj34gjhg34jh5bh5jb34hj53b4</span><br></pre></td></tr></table></figure></li><li><p>系统配置添加钉钉通知</p><table><thead><tr><th align="center">配置钉钉通知</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211209162923440.png" alt="image-20211209162923440"></td></tr></tbody></table></li><li><p>任务中追加流水线配置</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line"></span><br><span class="line">    environment &#123;</span><br><span class="line">        sonarLogin = <span class="string">&#x27;2bab7bf7d5af25e2c2ca2f178af2c3c55c64d5d8&#x27;</span></span><br><span class="line">        harborUser = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">        harborPassword = <span class="string">&#x27;Harbor12345&#x27;</span></span><br><span class="line">        harborHost = <span class="string">&#x27;192.168.11.12:8888&#x27;</span></span><br><span class="line">        harborRepo = <span class="string">&#x27;repository&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;拉取Git代码&#x27;</span>)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                checkout([<span class="variable">$class</span>: <span class="string">&#x27;GitSCM&#x27;</span>, branches: [[name: <span class="string">&#x27;$tag&#x27;</span>]], extensions: [], userRemoteConfigs: [[url: <span class="string">&#x27;http://49.233.115.171:8929/root/lsx.git&#x27;</span>]]])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;Maven构建代码&#x27;</span>)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;/var/jenkins_home/maven/bin/mvn clean package -DskipTests&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;SonarQube检测代码&#x27;</span>)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.sources=./ -Dsonar.projectname=$&#123;JOB_NAME&#125; -Dsonar.projectKey=$&#123;JOB_NAME&#125; -Dsonar.java.binaries=target/ -Dsonar.login=$&#123;sonarLogin&#125;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;制作自定义镜像&#x27;</span>)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;&#x27;</span><span class="string">&#x27;cd docker</span></span><br><span class="line"><span class="string">                mv ../target/*.jar ./</span></span><br><span class="line"><span class="string">                docker build -t $&#123;JOB_NAME&#125;:$tag .</span></span><br><span class="line"><span class="string">                &#x27;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;推送自定义镜像&#x27;</span>)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;&#x27;</span><span class="string">&#x27;docker login -u $&#123;harborUser&#125; -p $&#123;harborPassword&#125; $&#123;harborHost&#125;</span></span><br><span class="line"><span class="string">                docker tag $&#123;JOB_NAME&#125;:$tag $&#123;harborHost&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:$tag</span></span><br><span class="line"><span class="string">                docker push $&#123;harborHost&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:$tag&#x27;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        stage(<span class="string">&#x27;通知目标服务器&#x27;</span>)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sshPublisher(publishers: [sshPublisherDesc(configName: <span class="string">&#x27;centos-docker&#x27;</span>, transfers: [sshTransfer(cleanRemote: <span class="literal">false</span>, excludes: <span class="string">&#x27;&#x27;</span>, execCommand: <span class="string">&quot;/usr/bin/deploy.sh <span class="variable">$harborHost</span> <span class="variable">$harborRepo</span> <span class="variable">$JOB_NAME</span> <span class="variable">$tag</span> <span class="variable">$port</span>&quot;</span>, execTimeout: 120000, flatten: <span class="literal">false</span>, makeEmptyDirs: <span class="literal">false</span>, noDefaultExcludes: <span class="literal">false</span>, patternSeparator: <span class="string">&#x27;[, ]+&#x27;</span>, remoteDirectory: <span class="string">&#x27;&#x27;</span>, remoteDirectorySDF: <span class="literal">false</span>, removePrefix: <span class="string">&#x27;&#x27;</span>, sourceFiles: <span class="string">&#x27;&#x27;</span>)], usePromotionTimestamp: <span class="literal">false</span>, useWorkspaceInPromotion: <span class="literal">false</span>, verbose: <span class="literal">false</span>)])</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    post &#123;</span><br><span class="line">        success &#123;</span><br><span class="line">            dingtalk (</span><br><span class="line">                robot: <span class="string">&#x27;Jenkins-DingDing&#x27;</span>,</span><br><span class="line">                <span class="built_in">type</span>:<span class="string">&#x27;MARKDOWN&#x27;</span>,</span><br><span class="line">                title: <span class="string">&quot;success: <span class="variable">$&#123;JOB_NAME&#125;</span>&quot;</span>,</span><br><span class="line">                text: [<span class="string">&quot;- 成功构建:<span class="variable">$&#123;JOB_NAME&#125;</span>项目!\n- 版本:<span class="variable">$&#123;tag&#125;</span>\n- 持续时间:<span class="variable">$&#123;currentBuild.durationString&#125;</span>\n- 任务:#<span class="variable">$&#123;JOB_NAME&#125;</span>&quot;</span>]</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">        failure &#123;</span><br><span class="line">            dingtalk (</span><br><span class="line">                robot: <span class="string">&#x27;Jenkins-DingDing&#x27;</span>,</span><br><span class="line">                <span class="built_in">type</span>:<span class="string">&#x27;MARKDOWN&#x27;</span>,</span><br><span class="line">                title: <span class="string">&quot;fail: <span class="variable">$&#123;JOB_NAME&#125;</span>&quot;</span>,</span><br><span class="line">                text: [<span class="string">&quot;- 失败构建:<span class="variable">$&#123;JOB_NAME&#125;</span>项目!\n- 版本:<span class="variable">$&#123;tag&#125;</span>\n- 持续时间:<span class="variable">$&#123;currentBuild.durationString&#125;</span>\n- 任务:#<span class="variable">$&#123;JOB_NAME&#125;</span>&quot;</span>]</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>查看效果</p><table><thead><tr><th align="center">钉钉通知效果</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211209163021396.png" alt="image-20211209163021396"></td></tr></tbody></table></li></ul><p>###十、Kubernetes 编排工具</p><h4 id="Kubernetes-介绍"><a href="#Kubernetes-介绍" class="headerlink" title="Kubernetes 介绍"></a>Kubernetes 介绍</h4><p>Kubernetes 是一个开源的，用于管理云平台中多个主机上的容器化的应用，Kubernetes 的目标是让部署容器化的应用简单并且高效（powerful），Kubernetes 提供了应用部署，规划，更新，维护的一种机制。</p><p>Kubernetes 一个核心的特点就是能够自主的管理容器来保证云平台中的容器按照用户的期望状态运行着，管理员可以加载一个微型服务，让规划器来找到合适的位置，同时，Kubernetes 也系统提升工具以及人性化方面，让用户能够方便的部署自己的应用。</p><p>Kubernetes 主要能帮助我们完成：</p><ul><li><p>服务发现和负载均衡</p><p>Kubernetes 可以使用 DNS 名称或自己的 IP 地址公开容器，如果进入容器的流量很大， Kubernetes 可以负载均衡并分配网络流量，从而使部署稳定。</p></li><li><p>存储编排</p><p>Kubernetes 允许你自动挂载你选择的存储系统，比如本地存储，类似 Docker 的数据卷。</p></li><li><p>自动部署和回滚</p><p>你可以使用 Kubernetes 描述已部署容器的所需状态，它可以以受控的速率将实际状态 更改为期望状态。Kubernetes 会自动帮你根据情况部署创建新容器，并删除现有容器给新容器提供资源。</p></li><li><p>自动完成装箱计算</p><p>Kubernetes 允许你设置每个容器的资源，比如 CPU 和内存。</p></li><li><p>自我修复</p><p>Kubernetes 重新启动失败的容器、替换容器、杀死不响应用户定义的容器，并运行状况检查的容器。</p></li><li><p>秘钥与配置管理</p><p>Kubernetes 允许你存储和管理敏感信息，例如密码、OAuth 令牌和 ssh 密钥。你可以在不重建容器镜像的情况下部署和更新密钥和应用程序配置，也无需在堆栈配置中暴露密钥。</p></li></ul><h4 id="Kubernetes-架构"><a href="#Kubernetes-架构" class="headerlink" title="Kubernetes 架构"></a>Kubernetes 架构</h4><p>Kubernetes 搭建需要至少两个节点，一个 Master 负责管理，一个 Slave 搭建在工作服务器上负责分配。</p><table><thead><tr><th align="center">kubernetes 架构</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211210114507638.png" alt="image-20211210114507638"></td></tr></tbody></table><p>从图中可以看到各个组件的基本功能：</p><ul><li>API Server：作为 K8s 通讯的核心组件，K8s 内部交互以及接收发送指令的组件。</li><li>controller-manager：作为 K8s 的核心组件，主要做资源调度，根据集群情况分配资源</li><li>etcd：一个 key-value 的数据库，存储存储集群的状态信息</li><li>scheduler：负责调度每个工作节点</li><li>cloud-controller-manager：负责调度其他云服务产品</li><li>kubelet：管理 Pods 上面的容器。</li><li>kube-proxy：负责处理其他 Slave 或客户端的请求。</li><li>Pod：可以理解为就是运行的容器</li></ul><h4 id="Kubernetes-安装"><a href="#Kubernetes-安装" class="headerlink" title="Kubernetes 安装"></a>Kubernetes 安装</h4><p>这里会采用<a target="_blank" rel="noopener" href="https://kuboard.cn/%E6%8F%90%E4%BE%9B%E7%9A%84%E6%96%B9%E5%BC%8F%E5%AE%89%E8%A3%85K8s%EF%BC%8C%E5%AE%89%E8%A3%85%E5%8D%95Master%E8%8A%82%E7%82%B9">https://kuboard.cn/提供的方式安装K8s，安装单Master节点</a></p><ul><li>要求使用 Centos7.8 版本：<a target="_blank" rel="noopener" href="https://vault.centos.org/7.8.2003/isos/x86_64/CentOS-7-x86_64-Minimal-2003.iso">https://vault.centos.org/7.8.2003/isos/x86_64/CentOS-7-x86_64-Minimal-2003.iso</a></li><li>至少 2 台 <strong>2 核 4G</strong> 的服务器</li></ul><p>安装流程</p><table><thead><tr><th align="center">安装流程</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211210190653687.png" alt="image-20211210190653687"></td></tr></tbody></table><p>准备好服务器后开始安装</p><ul><li><p>重新设置 hostname，不允许为 localhost</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改 hostname，名字不允许使用下划线、小数点、大写字母，不能叫master</span></span><br><span class="line">hostnamectl set-hostname your-new-host-name</span><br><span class="line"><span class="comment"># 查看修改结果</span></span><br><span class="line">hostnamectl status</span><br><span class="line"><span class="comment"># 设置 hostname 解析</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;127.0.0.1   <span class="subst">$(hostname)</span>&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure></li><li><p>要求 2 台服务之间可以相互通讯</p></li><li><p>安装软件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 阿里云 docker hub 镜像</span></span><br><span class="line"><span class="built_in">export</span> REGISTRY_MIRROR=https://registry.cn-hangzhou.aliyuncs.com</span><br><span class="line">curl -sSL https://kuboard.cn/install-script/v1.19.x/install_kubelet.sh | sh -s 1.19.5</span><br></pre></td></tr></table></figure></li></ul><p>首先初始化 Master 节点</p><blockquote><p>关于初始化时用到的环境变量</p><ul><li><strong>APISERVER_NAME</strong> 不能是 master 的 hostname</li><li><strong>APISERVER_NAME</strong> 必须全为小写字母、数字、小数点，不能包含减号</li><li><strong>POD_SUBNET</strong> 所使用的网段不能与 <strong><em>master 节点&#x2F;worker 节点</em></strong> 所在的网段重叠。该字段的取值为一个 <a target="_blank" rel="noopener" href="https://kuboard.cn/glossary/cidr.html">CIDR</a> 值，如果您对 CIDR 这个概念还不熟悉，请仍然执行 export POD_SUBNET&#x3D;10.100.0.0&#x2F;16 命令，不做修改</li></ul></blockquote><ul><li><p>设置 ip，域名，网段并执行初始化操作</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 master 节点执行</span></span><br><span class="line"><span class="comment"># 替换 x.x.x.x 为 master 节点实际 IP（请使用内网 IP）</span></span><br><span class="line"><span class="comment"># export 命令只在当前 shell 会话中有效，开启新的 shell 窗口后，如果要继续安装过程，请重新执行此处的 export 命令</span></span><br><span class="line"><span class="built_in">export</span> MASTER_IP=192.168.11.32</span><br><span class="line"><span class="comment"># 替换 apiserver.demo 为 您想要的 dnsName</span></span><br><span class="line"><span class="built_in">export</span> APISERVER_NAME=apiserver.demo</span><br><span class="line"><span class="comment"># Kubernetes 容器组所在的网段，该网段安装完成后，由 kubernetes 创建，事先并不存在于您的物理网络中</span></span><br><span class="line"><span class="built_in">export</span> POD_SUBNET=10.100.0.1/16</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;MASTER_IP&#125;</span>    <span class="variable">$&#123;APISERVER_NAME&#125;</span>&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line">curl -sSL https://kuboard.cn/install-script/v1.19.x/init_master.sh | sh -s 1.19.5</span><br></pre></td></tr></table></figure></li><li><p>检查 Master 启动状态</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 master 节点执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行如下命令，等待 3-10 分钟，直到所有的容器组处于 Running 状态</span></span><br><span class="line">watch kubectl get pod -n kube-system -o wide</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 master 节点初始化结果</span></span><br><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure></li></ul><p><code>Ps：如果出现NotReady的情况执行（最新版本的BUG，1.19一般没有）</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker pull quay.io/coreos/flannel:v0.10.0-amd64</span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/cni/net.d/</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF&gt; /etc/cni/net.d/10-flannel.conf</span></span><br><span class="line"><span class="string">&#123;&quot;name&quot;:&quot;cbr0&quot;,&quot;type&quot;:&quot;flannel&quot;,&quot;delegate&quot;: &#123;&quot;isDefaultGateway&quot;: true&#125;&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">mkdir</span> /usr/share/oci-umount/oci-umount.d -p</span><br><span class="line"><span class="built_in">mkdir</span> /run/flannel/</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF&gt; /run/flannel/subnet.env</span></span><br><span class="line"><span class="string">FLANNEL_NETWORK=172.100.0.0/16</span></span><br><span class="line"><span class="string">FLANNEL_SUBNET=172.100.1.0/24</span></span><br><span class="line"><span class="string">FLANNEL_MTU=1450</span></span><br><span class="line"><span class="string">FLANNEL_IPMASQ=true</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.9.1/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><p>安装网络服务插件</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> POD_SUBNET=10.100.0.0/16</span><br><span class="line">kubectl apply -f https://kuboard.cn/install-script/v1.22.x/calico-operator.yaml</span><br><span class="line">wget https://kuboard.cn/install-script/v1.22.x/calico-custom-resources.yaml</span><br><span class="line">sed -i <span class="string">&quot;s#192.168.0.0/16#<span class="variable">$&#123;POD_SUBNET&#125;</span>#&quot;</span> calico-custom-resources.yaml</span><br><span class="line">kubectl apply -f calico-custom-resources.yaml</span><br></pre></td></tr></table></figure><p>初始化 worker 节点</p><ul><li><p>获取 Join 命令参数，在 Master 节点执行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 master 节点执行</span></span><br><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">获取命令</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211213183025291.png" alt="image-20211213183025291"></td></tr></tbody></table></li><li><p>在 worker 节点初始化</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 worker 节点执行</span></span><br><span class="line"><span class="comment"># 替换 x.x.x.x 为 master 节点的内网 IP</span></span><br><span class="line"><span class="built_in">export</span> MASTER_IP=192.168.11.32</span><br><span class="line"><span class="comment"># 替换 apiserver.demo 为初始化 master 节点时所使用的 APISERVER_NAME</span></span><br><span class="line"><span class="built_in">export</span> APISERVER_NAME=apiserver.demo</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;MASTER_IP&#125;</span>    <span class="variable">$&#123;APISERVER_NAME&#125;</span>&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 替换为 master 节点上 kubeadm token create 命令的输出</span></span><br><span class="line">kubeadm <span class="built_in">join</span> apiserver.demo:6443 --token vwfilu.3nhndohc5gn1jv9k     --discovery-token-ca-cert-hash sha256:22ff15cabfe87ab48a7db39b3bbf986fee92ec92eb8efc7fe9b0abe2175ff0c2</span><br></pre></td></tr></table></figure></li></ul><p>检查最终运行效果</p><ul><li><p>在 master 节点上执行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只在 master 节点执行</span></span><br><span class="line">kubectl get nodes -o wide</span><br></pre></td></tr></table></figure></li></ul><p><code>Ps：如果出现NotReady的情况执行（最新版本的BUG，1.19一般没有）</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker pull quay.io/coreos/flannel:v0.10.0-amd64</span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/cni/net.d/</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF&gt; /etc/cni/net.d/10-flannel.conf</span></span><br><span class="line"><span class="string">&#123;&quot;name&quot;:&quot;cbr0&quot;,&quot;type&quot;:&quot;flannel&quot;,&quot;delegate&quot;: &#123;&quot;isDefaultGateway&quot;: true&#125;&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">mkdir</span> /usr/share/oci-umount/oci-umount.d -p</span><br><span class="line"><span class="built_in">mkdir</span> /run/flannel/</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF&gt; /run/flannel/subnet.env</span></span><br><span class="line"><span class="string">FLANNEL_NETWORK=172.100.0.0/16</span></span><br><span class="line"><span class="string">FLANNEL_SUBNET=172.100.1.0/24</span></span><br><span class="line"><span class="string">FLANNEL_MTU=1450</span></span><br><span class="line"><span class="string">FLANNEL_IPMASQ=true</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/v0.9.1/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><ul><li><p>输出结果如下所示：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@k8smaster ~]<span class="comment"># kubectl get nodes</span></span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">搭建成功效果</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211210184851810.png" alt="image-20211210184851810"></td></tr></tbody></table></li></ul><p>安装 Kuboard 管理 K8s 集群</p><ul><li><p>安装 Kuboard</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">https://addons.kuboard.cn/kuboard/kuboard-v3.yaml</span></span><br><span class="line"><span class="comment"># 您也可以使用下面的指令，唯一的区别是，该指令使用华为云的镜像仓库替代 docker hub 分发 Kuboard 所需要的镜像</span></span><br><span class="line"><span class="comment"># kubectl apply -f https://addons.kuboard.cn/kuboard/kuboard-v3-swr.yaml</span></span><br></pre></td></tr></table></figure></li><li><p>查看启动情况</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch kubectl get pods -n kuboard</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">查看效果</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211213184701784.png" alt="image-20211213184701784"></td></tr></tbody></table></li><li><p>在浏览器中打开链接 <a target="_blank" rel="noopener" href="http://your-node-ip-address:30080/">http://your-node-ip-address:30080</a></p><table><thead><tr><th align="center">首页</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211213184742709.png" alt="image-20211213184742709"></td></tr></tbody></table></li><li><p>输入初始用户名和密码，并登录</p><ul><li>用户名： <code>admin</code></li><li>密码： <code>Kuboard123</code></li></ul><table><thead><tr><th align="center">首页效果</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20211213184840120.png" alt="image-20211213184840120"></td></tr></tbody></table></li></ul><h4 id="Kubernetes-操作"><a href="#Kubernetes-操作" class="headerlink" title="Kubernetes 操作"></a>Kubernetes 操作</h4><p>首先我们要了解 Kubernetes 在运行我们的资源时，关联到了哪些内容</p><ul><li><p>资源的构建方式：</p><ul><li>采用 kubectl 的命令方式</li><li>yaml 文件方式</li></ul></li></ul><h5 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h5><ul><li><p>命名空间：主要是为了对 Kubernetes 中运行的资源进行过隔离， 但是网络是互通的，类似 Docker 的容器，可以将多个资源配置到一个 NameSpace 中。而 NameSpace 可以对不同环境进行资源隔离，默认情况下 Kubernetes 提供了 default 命名空间，在构建资源时，如果不指定资源，默认采用 default 资源。<br>命令方式：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看现有的全部命名空间</span></span><br><span class="line">kubectl get ns</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建命名空间</span></span><br><span class="line">kubectl create ns 命名空间名称</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除现有命名空间， 并且会删除空间下的全部资源</span></span><br><span class="line">kubectl delete ns 命名空间名称</span><br></pre></td></tr></table></figure><p>yaml 文件方式：（构建资源时，设置命名空间）</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test</span></span><br></pre></td></tr></table></figure></li></ul><h5 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h5><ul><li><p>Pod：Kubernetes 运行的一组容器，Pod 是 Kubernetes 的最小单位，但是对于 Docker 而然，Pod 中会运行多个 Docker 容器</p><ul><li><p>命令方式：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看所有运行的pod</span></span><br><span class="line">kubectl get pods -A</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看指定Namespace下的Pod</span></span><br><span class="line">kubectl get pod [-n 命名空间]  <span class="comment">#（默认default）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建Pod</span></span><br><span class="line">kubectl run pod名称 --image=镜像名称</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看Pod详细信息</span></span><br><span class="line">kubectl describe pod pod名称</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除pod</span></span><br><span class="line">kubectl delete pod pod名称 [-n 命名空间]  <span class="comment">#（默认default）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod输出的日志</span></span><br><span class="line">kubectl logs -f pod名称</span><br><span class="line"></span><br><span class="line"><span class="comment"># 进去pod容器内部</span></span><br><span class="line">kubectl <span class="built_in">exec</span> -it pod名称 -- bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看kubernetes给Pod分配的ip信息，并且通过ip和容器的端口，可以直接访问</span></span><br><span class="line">kubectl get pod -owide</span><br></pre></td></tr></table></figure></li><li><p>yaml 方式（推荐）</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">运行的pod名称</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">命名空间</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">镜像名称</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">容器名称</span></span><br><span class="line"><span class="comment"># 启动Pod：kubectl apply -f yaml文件名称</span></span><br><span class="line"><span class="comment"># 删除Pod：kubectl delete -f yaml文件名称</span></span><br></pre></td></tr></table></figure></li><li><p>Pod 中运行多个容器</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">运行的pod名称</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod名称</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">命名空间</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">镜像名称</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">容器名称</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">镜像名称</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">容器名称</span></span><br><span class="line"><span class="string">…………</span></span><br></pre></td></tr></table></figure><p>启动后可以查看到</p><table><thead><tr><th align="center">Kuboard 效果</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20220104203155749.png" alt="image-20220104203155749"></td></tr></tbody></table></li></ul></li></ul><h5 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h5><p>部署时，可以通过 Deployment 管理和编排 Pod</p><p>Deployment 部署实现</p><ul><li><p>命令方式</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基于Deployment启动容器</span></span><br><span class="line">kubectl create deployment deployment名称 --image=镜像名称</span><br><span class="line"><span class="comment"># 用deployment启动的容器会在被删除后自动再次创建，达到故障漂移的效果</span></span><br><span class="line"><span class="comment"># 需要使用deploy的方式删除deploy</span></span><br><span class="line"><span class="comment"># 查看现在的deployment</span></span><br><span class="line">kubectl get deployment</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除deployment</span></span><br><span class="line">kubectl delete deployment deployment名称</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基于Deployment启动容器并设置Pod集群数</span></span><br><span class="line">kubectl create deployment deployment名称 --image=镜像名称 --replicas 集群个数</span><br></pre></td></tr></table></figure></li><li><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/">配置文件方式</a></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">       <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">       <span class="attr">ports:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>正常使用 kubectl 运行 yaml 即可</p></li></ul><p>弹性伸缩功能</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基于scale实现弹性伸缩</span></span><br><span class="line">kubectl scale deploy/Deployment名称 --replicas 集群个数</span><br><span class="line"><span class="comment"># 或者修改yaml文件</span></span><br><span class="line">kubectl edit deploy Deployment名称</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">图形化页面修改</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20220104210823057.png" alt="image-20220104210823057"></td></tr></tbody></table><p>灰度发布</p><p>Deploy 可以在部署新版本数据时，成功启动一个 pod，才会下线一个老版本的 Pod</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl set image deployment/Deployment名称 容器名=镜像:版本</span><br></pre></td></tr></table></figure><h5 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h5><p>可以将多个 Pod 对外暴露一个 Service，让客户端可以通过 Service 访问到这一组 Pod，并且可以实现负载均衡</p><p>ClusterIP 方式：</p><p>ClusterIP 是集群内部 Pod 之间的访问方式</p><ul><li><p>命令实现效果</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过生成service映射一个Deployment下的所有pod中的某一个端口的容器</span></span><br><span class="line">kubectl expose deployment Deployment名称 --port=Service端口号 --target-port=Pod内容器端口</span><br></pre></td></tr></table></figure><p>之后通过<code>kubectl get service</code>查看 Service 提供的 ip，即可访问</p><table><thead><tr><th align="center">kubectl get service</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20220104214659229.png" alt="image-20220104214659229"></td></tr></tbody></table><p>也可以通过<code>Deployment名称.namespace名称.svc</code>作为域名访问</p><table><thead><tr><th align="center">在服务容器内执行</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20220104215030265.png" alt="image-20220104215030265"></td></tr></tbody></table></li></ul><p>NodePort 方式</p><p>ClusterIP 的方式只能在 Pod 内部实现访问，但是一般需要对外暴露网关，所以需要 NodePort 的方式 Pod 外暴露访问</p><ul><li><p>命令实现方式</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过生成service映射一个Deployment下的所有pod中的某一个端口的容器</span></span><br><span class="line">kubectl expose deployment Deployment名称 --port=Service端口号 --target-port=Pod内容器端口 --<span class="built_in">type</span>=NodePort</span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">查看 Service 效果</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20220104222750733.png" alt="image-20220104222750733"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20220104222819455.png" alt="image-20220104222819455"></td></tr></tbody></table></li></ul><p>Service 也可以通过 yaml 文件实现</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="string">labels</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">selector:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8888</span></span><br><span class="line">     <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">     <span class="attr">targetPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure><p>通过 apply 启动就也可以创建 Service</p><p>测试效果-Deployment 部署，通过 Service 暴露</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-deployment</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-service</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-deployment</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8888</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure><p>可以查看到暴露的信息</p><table><thead><tr><th align="center">Service 信息</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20220105205334996.png" alt="image-20220105205334996"></td></tr></tbody></table><h5 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h5><p>Kubernetes 推荐将 Ingress 作为所有 Service 的入口，提供统一的入口，避免多个服务之间需要记录大量的 IP 或者域名，毕竟 IP 可能改变，服务太多域名记录不方便。</p><p>Ingress 底层其实就是一个 Nginx， 可以在 Kuboard 上直接点击安装</p><table><thead><tr><th align="center">Kuboard 安装</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20220105153343642.png" alt="image-20220105153343642"></td></tr><tr><td align="center"><strong><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20220105153416367.png" alt="image-20220105153416367"></strong></td></tr></tbody></table><p>因为副本数默认为 1，但是 k8s 整体集群就 2 个节点，所以显示下面即为安装成功</p><table><thead><tr><th align="center">安装成功</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20220105153502619.png" alt="image-20220105153502619"></td></tr></tbody></table><p>可以将 Ingress 接收到的请求转发到不同的 Service 中。</p><p>推荐使用 yaml 文件方式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-ingress</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">ingress</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">nginx.mashibing.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">nginx-service</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">8888</span></span><br></pre></td></tr></table></figure><table><thead><tr><th align="center">启动时问题</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20220105203819715.png" alt="image-20220105203819715"></td></tr></tbody></table><p>Kuboard 安装的 Ingress 有 admission 的校验配置，需要先删除配置再启动</p><p>找到指定的 ingress 的校验信息，删除即可</p><table><thead><tr><th align="center">删除信息</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20220105204434044.png" alt="image-20220105204434044"></td></tr></tbody></table><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看校验webhook的配置</span></span><br><span class="line">kubectl get -A ValidatingWebhookConfiguration</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除指定的校验</span></span><br><span class="line">kubectl delete ValidatingWebhookConfiguration ingress-nginx-admission-my-ingress-controller</span><br></pre></td></tr></table></figure><p>配置本地 hosts 文件</p><table><thead><tr><th align="center">配置 hosts</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20220105204921272.png" alt="image-20220105204921272"></td></tr></tbody></table><p>记下来既可以访问在 Service 中暴露的 Nginx 信息</p><table><thead><tr><th align="center">服通过 Ingress 访问</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/image-20220105205407393.png" alt="image-20220105205407393"></td></tr></tbody></table><h4 id="Jenkins-集成-Kubernetes"><a href="#Jenkins-集成-Kubernetes" class="headerlink" title="Jenkins 集成 Kubernetes"></a>Jenkins 集成 Kubernetes</h4><h5 id="准备部署的-yml-文件"><a href="#准备部署的-yml-文件" class="headerlink" title="准备部署的 yml 文件"></a>准备部署的 yml 文件</h5><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pipeline</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">pipeline</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">pipeline</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">pipeline</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pipeline</span></span><br><span class="line">          <span class="attr">image:</span> <span class="number">192.168</span><span class="number">.11</span><span class="number">.102</span><span class="string">:80/repo/pipeline:v4.0.0</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">pipeline</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pipeline</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">pipeline</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pipeline</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">ingress</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">mashibing.pipeline.com</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">paths:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">            <span class="attr">backend:</span></span><br><span class="line">              <span class="attr">service:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">pipeline</span></span><br><span class="line">                <span class="attr">port:</span></span><br><span class="line">                  <span class="attr">number:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure><h5 id="Harbor-私服配置"><a href="#Harbor-私服配置" class="headerlink" title="Harbor 私服配置"></a>Harbor 私服配置</h5><p>在尝试用 kubernetes 的 yml 文件启动 pipeline 服务时，会出现 Kubernetes 无法拉取镜像的问题，这里需要在 kubernetes 所在的 Linux 中配置 Harbor 服务信息，并且保证 Kubernetes 可以拉取 Harbor 上的镜像</p><ul><li><p>设置 Master 和 Worker 的私服地址信息</p><table><thead><tr><th align="center">设置 Harbor 私服地址</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642498962716.png" alt="1642498962716"></td></tr></tbody></table></li><li><p>在 Kuboard 上设置私服密文信息</p><table><thead><tr><th align="center">设置密文并测试</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642498994935.png" alt="1642498994935"></td></tr></tbody></table><p>按照复制指令的位置测试认证，效果如下</p><table><thead><tr><th align="center">测试效果</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642499172789.png" alt="1642499172789"></td></tr></tbody></table></li></ul><h5 id="测试使用效果"><a href="#测试使用效果" class="headerlink" title="测试使用效果"></a>测试使用效果</h5><p>执行 kubectl 命令，基于 yml 启动服务，并且基于部署后服务的提示信息以及 Ingress 的设置，直接访问</p><table><thead><tr><th></th></tr></thead><tbody><tr><td><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642499368121.png" alt="1642499368121"></td></tr><tr><td><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642499788199.png" alt="1642499788199"></td></tr></tbody></table><h5 id="Jenkins-远程调用"><a href="#Jenkins-远程调用" class="headerlink" title="Jenkins 远程调用"></a>Jenkins 远程调用</h5><ul><li><p>将 pipeline.yml 配置到 Gitlab 中</p><table><thead><tr><th align="center">配置 yml 文件</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642499885324.png" alt="1642499885324"></td></tr></tbody></table></li><li><p>配置 Jenkins 的目标服务器，可以将 yml 文件传输到 K8s 的 Master 上</p><table><thead><tr><th align="center">设置目标服务器</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642499992148.png" alt="1642499992148"></td></tr></tbody></table></li><li><p>修改 Jenkinsfile，重新设置流水线任务脚本，并测试效果</p><table><thead><tr><th align="center">传递 yml 文件脚本</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642500061153.png" alt="1642500061153"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642500102996.png" alt="1642500102996"></td></tr></tbody></table></li><li><p>设置 Jenkins 无密码登录 k8s-master</p><p>将 Jenkins 中公钥信息复制到 k8s-master 的~&#x2F;.ssh&#x2F;authorized_keysz 中，保证远程连接无密码</p><table><thead><tr><th align="center">远程执行命令无需密码</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642500239406.png" alt="1642500239406"></td></tr></tbody></table></li><li><p>设置执行 kubectl 的脚本到 Jenkinsfile</p><table><thead><tr><th align="center">设置 Jenkinsfile</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642500378788.png" alt="1642500378788"></td></tr></tbody></table></li><li><p>执行查看效果</p><table><thead><tr><th align="center">执行流水线</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642500413802.png" alt="1642500413802"></td></tr></tbody></table><p>可以查看到 yml 文件是由变化的， 这样 k8s 就会重新加载</p></li><li><p>查看效果</p><table><thead><tr><th align="center">效果</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642500474036.png" alt="1642500474036"></td></tr></tbody></table></li></ul><p><a href="">Ps：这种方式更适应与 CD 操作，将项目将基于某个版本部署到指定的目标服务器</a></p><h4 id="基于-GitLab-的-WebHooks"><a href="#基于-GitLab-的-WebHooks" class="headerlink" title="基于 GitLab 的 WebHooks"></a>基于 GitLab 的 WebHooks</h4><p>这里要实现自动化的一个 CI 操作，也就是开发人员 Push 代码到 Git 仓库后，Jenkins 会自动的构建项目，将最新的提交点代码构建并进行打包部署，这里区别去上述的 CD 操作，CD 操作需要基于某个版本进行部署，而这里每次都是将最新的提交点集成到主干上并测试。</p><h5 id="WebHooks-通知"><a href="#WebHooks-通知" class="headerlink" title="WebHooks 通知"></a>WebHooks 通知</h5><p>开启 Jenkins 的自动构建</p><table><thead><tr><th align="center">构建触发器</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642500817131.png" alt="1642500817131"></td></tr></tbody></table><p>设置 Gitlab 的 Webhooks</p><table><thead><tr><th align="center">设置 Gitlab 的 Webhooks</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642500933316.png" alt="1642500933316"></td></tr></tbody></table><p>需要关闭 Jenkins 的 Gitlab 认证</p><table><thead><tr><th align="center">关闭 Jenkins 的 Gitlab 认证</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642501016474.png" alt="1642501016474"></td></tr></tbody></table><p>再次测试 Gitlab</p><table><thead><tr><th align="center">再次测试</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642501065243.png" alt="1642501065243"></td></tr></tbody></table><h5 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h5><p>修改 Jenkinsfile 实现基于最新提交点实现持续集成效果，将之前引用${tag}的全部去掉</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有的脚本命令都放在pipeline中</span></span><br><span class="line">pipeline<span class="punctuation">&#123;</span></span><br><span class="line">	<span class="comment">// 指定任务再哪个集群节点中执行</span></span><br><span class="line">	agent any</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 声明全局变量，方便后面使用</span></span><br><span class="line">	environment <span class="punctuation">&#123;</span></span><br><span class="line">		harborUser = &#x27;admin&#x27;</span><br><span class="line">        harborPasswd = &#x27;Harbor12345&#x27;</span><br><span class="line">        harborAddress = &#x27;<span class="number">192.168</span><span class="number">.11</span><span class="number">.102</span><span class="punctuation">:</span><span class="number">80</span>&#x27;</span><br><span class="line">        harborRepo = &#x27;repo&#x27;</span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">    stages <span class="punctuation">&#123;</span></span><br><span class="line">        stage(&#x27;拉取git仓库代码&#x27;) <span class="punctuation">&#123;</span></span><br><span class="line">            steps <span class="punctuation">&#123;</span></span><br><span class="line">                checkout(<span class="punctuation">[</span>$class<span class="punctuation">:</span> &#x27;GitSCM&#x27;<span class="punctuation">,</span> branches<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">[</span>name<span class="punctuation">:</span> &#x27;*/master&#x27;<span class="punctuation">]</span><span class="punctuation">]</span><span class="punctuation">,</span> extensions<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span> userRemoteConfigs<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">[</span>url<span class="punctuation">:</span> &#x27;http<span class="punctuation">:</span><span class="comment">//192.168.11.101:8929/root/mytest.git&#x27;]]])</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        stage(&#x27;通过maven构建项目&#x27;) <span class="punctuation">&#123;</span></span><br><span class="line">            steps <span class="punctuation">&#123;</span></span><br><span class="line">                sh &#x27;/var/jenkins_home/maven/bin/mvn clean package -DskipTests&#x27;</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        stage(&#x27;通过SonarQube做代码质量检测&#x27;) <span class="punctuation">&#123;</span></span><br><span class="line">            steps <span class="punctuation">&#123;</span></span><br><span class="line">                sh &#x27;/var/jenkins_home/sonar-scanner/bin/sonar-scanner -Dsonar.source=./ -Dsonar.projectname=$<span class="punctuation">&#123;</span>JOB_NAME<span class="punctuation">&#125;</span> -Dsonar.projectKey=$<span class="punctuation">&#123;</span>JOB_NAME<span class="punctuation">&#125;</span> -Dsonar.java.binaries=./target/ -Dsonar.login=<span class="number">40306</span>ae8ea69a4792df2ceb4d9d25fe8a6ab1701&#x27;</span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">        stage(&#x27;通过Docker制作自定义镜像&#x27;) <span class="punctuation">&#123;</span></span><br><span class="line">            steps <span class="punctuation">&#123;</span></span><br><span class="line">                sh &#x27;&#x27;&#x27;mv ./target<span class="comment">/*.jar ./docker/</span></span><br><span class="line"><span class="comment">                docker build -t $&#123;JOB_NAME&#125;:latest ./docker/&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        stage(&#x27;将自定义镜像推送到Harbor&#x27;) &#123;</span></span><br><span class="line"><span class="comment">            steps &#123;</span></span><br><span class="line"><span class="comment">                sh &#x27;&#x27;&#x27;docker login -u $&#123;harborUser&#125; -p $&#123;harborPasswd&#125; $&#123;harborAddress&#125;</span></span><br><span class="line"><span class="comment">                docker tag $&#123;JOB_NAME&#125;:latest  $&#123;harborAddress&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:latest</span></span><br><span class="line"><span class="comment">                docker push $&#123;harborAddress&#125;/$&#123;harborRepo&#125;/$&#123;JOB_NAME&#125;:latest &#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        stage(&#x27;将yml文件传到k8s-master上&#x27;) &#123;</span></span><br><span class="line"><span class="comment">            steps &#123;</span></span><br><span class="line"><span class="comment">                sshPublisher(publishers: [sshPublisherDesc(configName: &#x27;k8s&#x27;, transfers: [sshTransfer(cleanRemote: false, excludes: &#x27;&#x27;, execCommand: &#x27;&#x27;, execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, patternSeparator: &#x27;[, ]+&#x27;, remoteDirectory: &#x27;&#x27;, remoteDirectorySDF: false, removePrefix: &#x27;&#x27;, sourceFiles: &#x27;pipeline.yml&#x27;)], usePromotionTimestamp: false, useWorkspaceInPromotion: false, verbose: false)])</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        stage(&#x27;远程执行k8s-master的kubectl命令&#x27;) &#123;</span></span><br><span class="line"><span class="comment">            steps &#123;</span></span><br><span class="line"><span class="comment">               sh &#x27;&#x27;&#x27;ssh root@192.168.11.201 kubectl apply -f /usr/local/k8s/pipeline.yml</span></span><br><span class="line"><span class="comment">                ssh root@192.168.11.201 kubectl rollout restart deployment pipeline -n test&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    post &#123;</span></span><br><span class="line"><span class="comment">        success &#123;</span></span><br><span class="line"><span class="comment">            dingtalk(</span></span><br><span class="line"><span class="comment">                robot: &#x27;Jenkins-DingDing&#x27;,</span></span><br><span class="line"><span class="comment">                type: &#x27;MARKDOWN&#x27;,</span></span><br><span class="line"><span class="comment">                title: &quot;success: $&#123;JOB_NAME&#125;&quot;,</span></span><br><span class="line"><span class="comment">                text: [&quot;- 成功构建：$&#123;JOB_NAME&#125;! \n- 版本：latest \n- 持续时间：$&#123;currentBuild.durationString&#125;&quot; ]</span></span><br><span class="line"><span class="comment">            )</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        failure &#123;</span></span><br><span class="line"><span class="comment">            dingtalk(</span></span><br><span class="line"><span class="comment">                robot: &#x27;Jenkins-DingDing&#x27;,</span></span><br><span class="line"><span class="comment">                type: &#x27;MARKDOWN&#x27;,</span></span><br><span class="line"><span class="comment">                title: &quot;success: $&#123;JOB_NAME&#125;&quot;,</span></span><br><span class="line"><span class="comment">                text: [&quot;- 构建失败：$&#123;JOB_NAME&#125;! \n- 版本：latest \n- 持续时间：$&#123;currentBuild.durationString&#125;&quot; ]</span></span><br><span class="line"><span class="comment">            )</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br></pre></td></tr></table></figure><p>修改 pipeline.yml，更改镜像版本</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pipeline</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">pipeline</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">pipeline</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">pipeline</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pipeline</span></span><br><span class="line">          <span class="attr">image:</span> <span class="number">192.168</span><span class="number">.11</span><span class="number">.102</span><span class="string">:80/repo/pipeline:latest</span> <span class="comment"># 这里</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="comment"># 省略其他内容…………</span></span><br></pre></td></tr></table></figure><h5 id="滚动更新"><a href="#滚动更新" class="headerlink" title="滚动更新"></a>滚动更新</h5><p>因为 pipeline 没有改变时，每次不会重新加载，这样会导致 Pod 中的容器不会动态更新，这里需要使用 kubectl 的 rollout restart 命令滚动更新</p><table><thead><tr><th align="center">设置 Jenkinsfle</th></tr></thead><tbody><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642501521065.png" alt="1642501521065"></td></tr><tr><td align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/blog/DevOps/1642501549176.png" alt="1642501549176"></td></tr></tbody></table><h3 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h3><p>docker 安装的 Jenkins 一定要是最新版本的，不然很多插件无法安装</p><p>docker 安装的插件：</p><ul><li>git parameter</li><li>publish Over SSH</li></ul></article><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/95384548.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/coverImage/3k/01/3K%20(103).jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">字节面试题——小于n的最大数</div></div></a></div><div class="next-post pull-right"><a href="/posts/ac57a49d.html"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/coverImage/1-2k/01/1K-2K%20(202).jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">开启新篇章，扬帆起航！</div></div></a></div></nav><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i> <span>评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-top" title="点击展开"><div class="card-info-avatar"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/avatar/avatar.jpg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div></div></div><div class="author-info__description">记录生活，探索学习</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">故梦</h1><div class="author-info__desc">往者不谏，来者可追</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/Itxcm" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&amp;email=1187390456@qq.com" target="_blank" title="Email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="social-icon faa-parent animated-hover" href="/atom.xml" target="_blank" title="RSS"><i class="anzhiyufont anzhiyu-icon-rss"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/652113902" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a><a class="social-icon faa-parent animated-hover" href="tencent://Message/?Uin=1187390456&amp;amp;websiteName=local.edu.com:8888=&amp;amp;Menu=yes" target="_blank" title="QQ"><i class="anzhiyufont anzhiyu-icon-qq"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background:url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center/100% no-repeat"></div><div class="back face" style="background:url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center/100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#DevOps-%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">DevOps 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Code-%E9%98%B6%E6%AE%B5%E5%B7%A5%E5%85%B7"><span class="toc-number">2.</span> <span class="toc-text">Code 阶段工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Docker-%E5%AE%89%E8%A3%85"><span class="toc-number">2.1.</span> <span class="toc-text">Docker 安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Git-%E5%AE%89%E8%A3%85"><span class="toc-number">2.2.</span> <span class="toc-text">Git 安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GitLab-%E5%AE%89%E8%A3%85"><span class="toc-number">2.3.</span> <span class="toc-text">GitLab 安装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Build-%E9%98%B6%E6%AE%B5%E5%B7%A5%E5%85%B7"><span class="toc-number">3.</span> <span class="toc-text">Build 阶段工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Operate-%E9%98%B6%E6%AE%B5%E5%B7%A5%E5%85%B7"><span class="toc-number">4.</span> <span class="toc-text">Operate 阶段工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Docker-%E5%AE%89%E8%A3%85-1"><span class="toc-number">4.1.</span> <span class="toc-text">Docker 安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Docker-Compose-%E5%AE%89%E8%A3%85"><span class="toc-number">4.2.</span> <span class="toc-text">Docker-Compose 安装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Integrate-%E5%B7%A5%E5%85%B7"><span class="toc-number">5.</span> <span class="toc-text">Integrate 工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.1.</span> <span class="toc-text">Jenkins 介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E5%AE%89%E8%A3%85"><span class="toc-number">5.2.</span> <span class="toc-text">Jenkins 安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E5%85%A5%E9%97%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">5.3.</span> <span class="toc-text">Jenkins 入门配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E4%BB%BB%E5%8A%A1"><span class="toc-number">5.3.1.</span> <span class="toc-text">构建任务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%BA%90%E7%A0%81%E6%8B%89%E5%8F%96%E5%9C%B0%E5%9D%80"><span class="toc-number">5.3.2.</span> <span class="toc-text">配置源码拉取地址</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Maven-%E6%9E%84%E5%BB%BA%E4%BB%A3%E7%A0%81"><span class="toc-number">5.3.3.</span> <span class="toc-text">配置 Maven 构建代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Publish-%E5%8F%91%E5%B8%83-%E8%BF%9C%E7%A8%8B%E6%93%8D%E4%BD%9C"><span class="toc-number">5.3.4.</span> <span class="toc-text">配置 Publish 发布&amp;远程操作</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CI%E3%80%81CD-%E5%85%A5%E9%97%A8%E6%93%8D%E4%BD%9C"><span class="toc-number">6.</span> <span class="toc-text">CI、CD 入门操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90"><span class="toc-number">6.1.</span> <span class="toc-text">持续集成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%81%E7%BB%AD%E4%BA%A4%E4%BB%98%E3%80%81%E9%83%A8%E7%BD%B2"><span class="toc-number">6.2.</span> <span class="toc-text">持续交付、部署</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90-Sonar-Qube"><span class="toc-number">7.</span> <span class="toc-text">集成 Sonar Qube</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Sonar-Qube-%E4%BB%8B%E7%BB%8D"><span class="toc-number">7.1.</span> <span class="toc-text">Sonar Qube 介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Sonar-Qube-%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">7.2.</span> <span class="toc-text">Sonar Qube 环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Sonar-Qube-%E5%AE%89%E8%A3%85"><span class="toc-number">7.2.1.</span> <span class="toc-text">Sonar Qube 安装</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%B8%AD%E6%96%87%E6%8F%92%E4%BB%B6"><span class="toc-number">7.2.2.</span> <span class="toc-text">安装中文插件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Sonar-Qube-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">7.3.</span> <span class="toc-text">Sonar Qube 基本使用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Maven-%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E6%A3%80%E6%B5%8B"><span class="toc-number">7.3.1.</span> <span class="toc-text">Maven 实现代码检测</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Sonar-scanner-%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E6%A3%80%E6%B5%8B"><span class="toc-number">7.3.2.</span> <span class="toc-text">Sonar-scanner 实现代码检测</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E9%9B%86%E6%88%90-Sonar-Qube"><span class="toc-number">7.4.</span> <span class="toc-text">Jenkins 集成 Sonar Qube</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Jenkins-%E5%AE%89%E8%A3%85%E6%8F%92%E4%BB%B6"><span class="toc-number">7.4.1.</span> <span class="toc-text">Jenkins 安装插件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Jenkins-%E9%85%8D%E7%BD%AE-Sonar-Qube"><span class="toc-number">7.4.2.</span> <span class="toc-text">Jenkins 配置 Sonar Qube</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE-Sonar-scanner"><span class="toc-number">7.4.3.</span> <span class="toc-text">配置 Sonar-scanner</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E4%BB%BB%E5%8A%A1-1"><span class="toc-number">7.4.4.</span> <span class="toc-text">构建任务</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90-Harbor"><span class="toc-number">8.</span> <span class="toc-text">集成 Harbor</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Harbor-%E4%BB%8B%E7%BB%8D"><span class="toc-number">8.1.</span> <span class="toc-text">Harbor 介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Harbor-%E5%AE%89%E8%A3%85"><span class="toc-number">8.2.</span> <span class="toc-text">Harbor 安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Harbor-%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">8.3.</span> <span class="toc-text">Harbor 使用方式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E6%9E%84%E5%BB%BA%E9%A1%B9%E7%9B%AE"><span class="toc-number">8.3.1.</span> <span class="toc-text">添加用户构建项目</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E9%95%9C%E5%83%8F%E5%88%B0-Harbor"><span class="toc-number">8.3.2.</span> <span class="toc-text">发布镜像到 Harbor</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%8E-Harbor-%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F-ls"><span class="toc-number">8.3.3.</span> <span class="toc-text">从 Harbor 拉取镜像 ls</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Jenkins-%E5%AE%B9%E5%99%A8%E4%BD%BF%E7%94%A8%E5%AE%BF%E4%B8%BB%E6%9C%BA-Docker"><span class="toc-number">8.3.4.</span> <span class="toc-text">Jenkins 容器使用宿主机 Docker</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%9E%84%E5%BB%BA%E6%93%8D%E4%BD%9C"><span class="toc-number">8.3.5.</span> <span class="toc-text">添加构建操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E9%83%A8%E7%BD%B2%E8%84%9A%E6%9C%AC"><span class="toc-number">8.3.6.</span> <span class="toc-text">编写部署脚本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%9E%84%E5%BB%BA%E5%90%8E%E6%93%8D%E4%BD%9C"><span class="toc-number">8.3.7.</span> <span class="toc-text">配置构建后操作</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Jenkins-%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="toc-number">9.</span> <span class="toc-text">Jenkins 流水线</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E6%B5%81%E6%B0%B4%E7%BA%BF%E4%BB%BB%E5%8A%A1%E4%BB%8B%E7%BB%8D"><span class="toc-number">9.1.</span> <span class="toc-text">Jenkins 流水线任务介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E6%B5%81%E6%B0%B4%E7%BA%BF%E4%BB%BB%E5%8A%A1"><span class="toc-number">9.2.</span> <span class="toc-text">Jenkins 流水线任务</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA-Jenkins-%E6%B5%81%E6%B0%B4%E7%BA%BF%E4%BB%BB%E5%8A%A1"><span class="toc-number">9.2.1.</span> <span class="toc-text">构建 Jenkins 流水线任务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Groovy-%E8%84%9A%E6%9C%AC"><span class="toc-number">9.2.2.</span> <span class="toc-text">Groovy 脚本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Jenkinsfile-%E5%AE%9E%E7%8E%B0"><span class="toc-number">9.2.3.</span> <span class="toc-text">Jenkinsfile 实现</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E6%B5%81%E6%B0%B4%E7%BA%BF%E4%BB%BB%E5%8A%A1%E5%AE%9E%E7%8E%B0"><span class="toc-number">9.3.</span> <span class="toc-text">Jenkins 流水线任务实现</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E5%8C%96%E6%9E%84%E5%BB%BA"><span class="toc-number">9.3.1.</span> <span class="toc-text">参数化构建</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8B%89%E5%8F%96-Git-%E4%BB%A3%E7%A0%81"><span class="toc-number">9.3.2.</span> <span class="toc-text">拉取 Git 代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E4%BB%A3%E7%A0%81"><span class="toc-number">9.3.3.</span> <span class="toc-text">构建代码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E6%A3%80%E6%B5%8B"><span class="toc-number">9.3.4.</span> <span class="toc-text">代码质量检测</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%B6%E4%BD%9C%E8%87%AA%E5%AE%9A%E4%B9%89%E9%95%9C%E5%83%8F%E5%B9%B6%E5%8F%91%E5%B8%83"><span class="toc-number">9.3.5.</span> <span class="toc-text">制作自定义镜像并发布</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E6%B5%81%E6%B0%B4%E7%BA%BF%E6%95%B4%E5%90%88%E9%92%89%E9%92%89"><span class="toc-number">9.4.</span> <span class="toc-text">Jenkins 流水线整合钉钉</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kubernetes-%E4%BB%8B%E7%BB%8D"><span class="toc-number">9.5.</span> <span class="toc-text">Kubernetes 介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kubernetes-%E6%9E%B6%E6%9E%84"><span class="toc-number">9.6.</span> <span class="toc-text">Kubernetes 架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kubernetes-%E5%AE%89%E8%A3%85"><span class="toc-number">9.7.</span> <span class="toc-text">Kubernetes 安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Kubernetes-%E6%93%8D%E4%BD%9C"><span class="toc-number">9.8.</span> <span class="toc-text">Kubernetes 操作</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Namespace"><span class="toc-number">9.8.1.</span> <span class="toc-text">Namespace</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Pod"><span class="toc-number">9.8.2.</span> <span class="toc-text">Pod</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Deployment"><span class="toc-number">9.8.3.</span> <span class="toc-text">Deployment</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Service"><span class="toc-number">9.8.4.</span> <span class="toc-text">Service</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Ingress"><span class="toc-number">9.8.5.</span> <span class="toc-text">Ingress</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jenkins-%E9%9B%86%E6%88%90-Kubernetes"><span class="toc-number">9.9.</span> <span class="toc-text">Jenkins 集成 Kubernetes</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E9%83%A8%E7%BD%B2%E7%9A%84-yml-%E6%96%87%E4%BB%B6"><span class="toc-number">9.9.1.</span> <span class="toc-text">准备部署的 yml 文件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Harbor-%E7%A7%81%E6%9C%8D%E9%85%8D%E7%BD%AE"><span class="toc-number">9.9.2.</span> <span class="toc-text">Harbor 私服配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%BD%BF%E7%94%A8%E6%95%88%E6%9E%9C"><span class="toc-number">9.9.3.</span> <span class="toc-text">测试使用效果</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Jenkins-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-number">9.9.4.</span> <span class="toc-text">Jenkins 远程调用</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E-GitLab-%E7%9A%84-WebHooks"><span class="toc-number">9.10.</span> <span class="toc-text">基于 GitLab 的 WebHooks</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#WebHooks-%E9%80%9A%E7%9F%A5"><span class="toc-number">9.10.1.</span> <span class="toc-text">WebHooks 通知</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">9.10.2.</span> <span class="toc-text">修改配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0"><span class="toc-number">9.10.3.</span> <span class="toc-text">滚动更新</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E7%82%B9"><span class="toc-number">10.</span> <span class="toc-text">注意点</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/ac57a49d.html" title="开启新篇章，扬帆起航！"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/coverImage/1-2k/01/1K-2K%20(202).jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="开启新篇章，扬帆起航！"></a><div class="content"><a class="title" href="/posts/ac57a49d.html" title="开启新篇章，扬帆起航！">开启新篇章，扬帆起航！</a><time datetime="2024-07-18T14:24:44.000Z" title="发表于 2024-07-18 14:24:44">2024-07-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/Infinity.html" title="DevOps"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/coverImage/1-2k/01/1K-2K%20(219).jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="DevOps"></a><div class="content"><a class="title" href="/posts/Infinity.html" title="DevOps">DevOps</a><time datetime="2023-09-16T13:23:44.000Z" title="发表于 2023-09-16 13:23:44">2023-09-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/95384548.html" title="字节面试题——小于n的最大数"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/coverImage/3k/01/3K%20(103).jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="字节面试题——小于n的最大数"></a><div class="content"><a class="title" href="/posts/95384548.html" title="字节面试题——小于n的最大数">字节面试题——小于n的最大数</a><time datetime="2023-08-30T15:55:44.000Z" title="发表于 2023-08-30 15:55:44">2023-08-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/a466fb88.html" title="Unity面试题——热更新与Lua"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/coverImage/3k/01/3K%20(115).jpg" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Unity面试题——热更新与Lua"></a><div class="content"><a class="title" href="/posts/a466fb88.html" title="Unity面试题——热更新与Lua">Unity面试题——热更新与Lua</a><time datetime="2023-08-27T21:49:44.000Z" title="发表于 2023-08-27 21:49:44">2023-08-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/32af4145.html" title="Unity面试题——网络相关"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/coverImage/3k/01/3K%20(12).png" onerror='this.onerror=null,this.src="/img/404.jpg"' alt="Unity面试题——网络相关"></a><div class="content"><a class="title" href="/posts/32af4145.html" title="Unity面试题——网络相关">Unity面试题——网络相关</a><time datetime="2023-08-25T01:48:44.000Z" title="发表于 2023-08-25 01:48:44">2023-08-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="mailto:1187390456@qq.com" title="email"><i class="anzhiyufont anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://weibo.com/u/5997178083" title="微博"><i class="anzhiyufont anzhiyufont anzhiyu-icon-weibo"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://www.facebook.com/profile.php?id=100092208016287&amp;sk=about" title="facebook"><i class="anzhiyufont anzhiyufont anzhiyu-icon-facebook1"></i></a><img class="footer_mini_logo" title="返回顶部" onclick="anzhiyu.scrollToDest(0,500)" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/avatar/avatar.jpg" size="50px"><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/itxcm" title="Github"><i class="anzhiyufont anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://space.bilibili.com/652113902" title="Bilibili"><i class="anzhiyufont anzhiyufont anzhiyu-icon-bilibili"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://v.douyin.com/icMxs3a/" title="抖音"><i class="anzhiyufont anzhiyufont anzhiyu-icon-tiktok"></i></a></div><div id="anzhiyu-footer"><div class="footer-group"><div class="footer-title">服务</div><div class="footer-links"><a class="footer-item" title="51la统计" target="_blank" rel="noopener" href="https://v6.51.la/">51la统计</a><a class="footer-item" title="十年之约" target="_blank" rel="noopener" href="https://www.foreverblog.cn/">十年之约</a><a class="footer-item" title="开往" target="_blank" rel="noopener" href="https://github.com/travellings-link/travellings">开往</a></div></div><div class="footer-group"><div class="footer-title">主题</div><div class="footer-links"><a class="footer-item" title="文档" href="/docs/">文档</a><a class="footer-item" title="源码" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu">源码</a><a class="footer-item" title="更新日志" href="/update/">更新日志</a></div></div><div class="footer-group"><div class="footer-title">导航</div><div class="footer-links"><a class="footer-item" title="即刻短文" href="/essay/">即刻短文</a><a class="footer-item" title="留言板" href="/comments/">留言板</a></div></div><div class="footer-group"><div class="footer-title-group"><div class="footer-title">友链</div><a class="random-friends-btn" id="footer-random-friends-btn" href="javascript:addFriendLinksInFooter();" title="换一批友情链接"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right"></i></a></div><div class="footer-links" id="friend-links-in-footer"></div></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title="博客框架为Hexo_v5.4.0"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v5.4.0"></a><a class="github-badge" target="_blank" href="https://blog.anheyu.com/" style="margin-inline:5px" data-title="本站使用AnZhiYu主题" title="本站使用AnZhiYu主题"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.9/img/Theme-AnZhiYu-2E67D3.svg" alt="本站使用AnZhiYu主题"></a><a class="github-badge" target="_blank" href="https://www.dogecloud.com/" style="margin-inline:5px" data-title="本站使用多吉云为静态资源提供CDN加速" title="本站使用多吉云为静态资源提供CDN加速"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/CDN-多吉云-3693F3.svg" alt="本站使用多吉云为静态资源提供CDN加速"></a><a class="github-badge" target="_blank" href="https://beian.miit.gov.cn/#/Integrated/index" style="margin-inline:5px" data-title="本站已在鄂进行备案" title="本站已在鄂进行备案"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/beian.svg" alt="本站已在鄂进行备案"></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="本站项目由Github托管"></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/Copyright-BY-NC-SA.svg" alt="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2023 - 2024 By <a class="footer-bar-link" href="/" title="故梦" target="_blank">故梦</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a><a class="footer-bar-link" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/" title="鄂ICP备-2023002522号">鄂ICP备-2023002522号</a></div></div></div></footer></div></div></div><div id="sidebar"><div id="sidebar-menus"><div class="avatar-img is-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.itxcm.cn/avatar/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">11</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">5</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span>文章</span></a><ul class="menus_item_child" style="left:-31px"><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size:.9em"></i> <span>分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size:.9em"></i> <span>标签</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span>友链</span></a><ul class="menus_item_child" style="left:-31px"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size:.9em"></i> <span>友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size:.9em"></i> <span>留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span>我的</span></a><ul class="menus_item_child" style="left:-79px"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=8896993428&amp;server=tencent"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size:.9em"></i> <span>音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size:.9em"></i> <span>追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size:.9em"></i> <span>相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><span>关于</span></a><ul class="menus_item_child" style="left:-127px"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size:.9em"></i> <span>关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size:.9em"></i> <span>闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size:.9em"></i> <span>我的装备</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size:.9em"></i> <span>随便逛逛</span></a></li></ul></div></div></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="chat_btn" type="button" title="聊天"><i class="anzhiyufont anzhiyu-icon-comment-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><a id="switch_commentBarrage" href="javascript:anzhiyu.switchCommentBarrage();" title="开关弹幕"><i class="anzhiyufont anzhiyu-icon-danmu"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i> <span>数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size:1rem"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8896993428&quot;, &quot;_blank&quot;);" style="display:none"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div id="he-plugin-simple"></div><script>var WIDGET={CONFIG:{modules:"0124",background:"2",tmpColor:"FFFFFF",tmpSize:"16",cityColor:"FFFFFF",citySize:"16",aqiColor:"E8D87B",aqiSize:"16",weatherIconSize:"24",alertIconSize:"18",padding:"10px 10px 10px 10px",shadow:"0",language:"auto",borderRadius:"20",fixed:"true",vertical:"top",horizontal:"left",left:"20",top:"7.1",key:"df245676fb434a0691ead1c63341cd94"}}</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.14/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.3.1/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.cbd.int/pangu@5.0.14/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script>var meting_api="https://meting.qjqq.cn/?server=:server&type=:type&id=:id&auth=:auth&r=:r"</script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.itxcm.cn',
      region: '',
      onCommentLoaded: function () {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.itxcm.cn',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init();
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.cbd.int/twikoo@1.6.17/dist/twikoo.all.min.js').then(runFn)
  }
  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo.itxcm.cn',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.innerHTML= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.17/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick}</span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom.innerHTML= result
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail="visitor@itxcm.com"</script><script>//动态标题
let leaveTitle = 'w(ﾟДﾟ)w 不要走！再看看嘛！';
let backTitle = '♪(^∇^*)欢迎肥来！';
let OriginTitile = document.title
let titleTime
document.addEventListener('visibilitychange', function () {
  if (document.hidden) {
    //离开当前页面时标签显示内容
    document.title = leaveTitle
    clearTimeout(titleTime)
  } else {
    //返回当前页面时标签显示内容
    document.title = backTitle + OriginTitile
    //两秒后变回正常标题
    titleTime = setTimeout(function () {
      document.title = OriginTitile
    }, 2000)
  }
})</script><script data-pjax="true">if (document.querySelector(".comment-barrage")){
  var commentBarrageConfig = {
    maxBarrage: 1,
    barrageTime: 2000,
    twikooUrl: "https://twikoo.itxcm.cn",
    accessToken: "ea6a5df14b084964b96cda7a24e254ec",
    mailMd5: "",
    pageUrl: window.location.pathname,
    barrageTimer: [],
    barrageList: [],
    barrageIndex: 0,
    dom: document.querySelector(".comment-barrage"),
  };
  var commentInterval = null;
  var hoverOnCommentBarrage = false;
  
  document.querySelector(".comment-barrage").addEventListener("mouseenter", function() {
    hoverOnCommentBarrage = true;
  });
  document.querySelector(".comment-barrage").addEventListener("mouseleave", function() {
    hoverOnCommentBarrage = false;
  });

  function initCommentBarrage() {
    if (!commentBarrageConfig.dom) return;

    var data = JSON.stringify({
      event: "COMMENT_GET",
      "commentBarrageConfig.accessToken": commentBarrageConfig.accessToken,
      url: commentBarrageConfig.pageUrl,
    });
    var xhr = new XMLHttpRequest();
    xhr.withCredentials = true;
    xhr.addEventListener("readystatechange", function () {
      if (this.readyState === 4 && this.responseText) {
        commentBarrageConfig.barrageList = commentLinkFilter(JSON.parse(this.responseText).data);
        commentBarrageConfig.dom.innerHTML = "";
      }
    });
    xhr.open("POST", commentBarrageConfig.twikooUrl);
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.send(data);

    clearInterval(commentInterval);
    commentInterval = null;

    commentInterval = setInterval(() => {
      if (commentBarrageConfig.barrageList.length && !hoverOnCommentBarrage) {
        popCommentBarrage(commentBarrageConfig.barrageList[commentBarrageConfig.barrageIndex]);
        commentBarrageConfig.barrageIndex += 1;
        commentBarrageConfig.barrageIndex %= commentBarrageConfig.barrageList.length;
      }
      if (
        commentBarrageConfig.barrageTimer.length >
          (commentBarrageConfig.barrageList.length > commentBarrageConfig.maxBarrage
            ? commentBarrageConfig.maxBarrage
            : commentBarrageConfig.barrageList.length) &&
        !hoverOnCommentBarrage
      ) {
        removeCommentBarrage(commentBarrageConfig.barrageTimer.shift());
      }
    }, commentBarrageConfig.barrageTime);
  }

  function commentLinkFilter(data) {
    data.sort((a, b) => {
      return a.created - b.created;
    });
    let newData = [];
    data.forEach(item => {
      newData.push(...getCommentReplies(item));
    });
    return newData;
  }

  function getCommentReplies(item) {
    if (item.replies) {
      let replies = [item];
      item.replies.forEach(item => {
        replies.push(...getCommentReplies(item));
      });
      return replies;
    } else {
      return [];
    }
  }

  function popCommentBarrage(data) {
    let barrage = document.createElement("div");
    barrage.className = "comment-barrage-item";
    barrage.innerHTML = `
        <div class="barrageHead">
          <a class="barrageTitle ${
            data.mailMd5 === commentBarrageConfig.mailMd5 ? "barrageBloggerTitle" : ""
          }" href="javascript:anzhiyu.scrollTo('#post-comment')"">
            ${data.mailMd5 === commentBarrageConfig.mailMd5 ? "博主" : "热评"}
          </a>
          <div class="barrageNick">${data.nick}</div>
          <img class="nolazyload barrageAvatar" src="https://cravatar.cn/avatar/${data.mailMd5}"/>
          <a class="comment-barrage-close" href="javascript:anzhiyu.switchCommentBarrage()"><i class="anzhiyufont anzhiyu-icon-xmark"></i></a>
        </div>
        <a class="barrageContent" href="#${data.id}">
          <object>${data.comment}</object>
        </a>
      `;
    commentBarrageConfig.barrageTimer.push(barrage);
    commentBarrageConfig.dom.append(barrage);
  }

  function removeCommentBarrage(barrage) {
    barrage.className = "comment-barrage-item out";

    setTimeout(() => {
      if (commentBarrageConfig.dom && commentBarrageConfig.dom.contains(barrage)) {
        commentBarrageConfig.dom.removeChild(barrage);
      }
      }, 1000);
    }

    // 自动隐藏
    const commentEntryCallback = (entries) => {
      const commentBarrage = document.querySelector(".comment-barrage");
      const postComment = document.getElementById("post-comment");

      entries.forEach(entry => {
        if (postComment && commentBarrage && document.body.clientWidth > 768) {
          commentBarrage.style.bottom = entry.isIntersecting ? `-${commentBarrageConfig.maxBarrage * 200}px` : "0";
        }
      });
    };
    // 创建IntersectionObserver实例
    const observer = new IntersectionObserver(commentEntryCallback, {
      root: null,
      rootMargin: "0px",
      threshold: 0
    });
    // 监视目标元素
    const postCommentTarget = document.getElementById("post-comment");
    if (postCommentTarget) {
      observer.observe(postCommentTarget);
    }

    initCommentBarrage();

    if (localStorage.getItem("commentBarrageSwitch") !== "false") {
      document.querySelector(".comment-barrage").style.display = "flex";
      document.querySelector(".menu-commentBarrage-text").textContent = "关闭热评";
    } else {
      document.querySelector(".comment-barrage").style.display = "none";
      document.querySelector(".menu-commentBarrage-text").textContent = "显示热评";
    }

    document.addEventListener("pjax:send", function () {
      clearInterval(commentInterval);
    });

  }</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script>// 初始化函数
let rm = {};

//禁止图片与超链接拖拽
let aElements = document.getElementsByTagName("a");
for (let i = 0; i < aElements.length; i++) {
  aElements[i].setAttribute("draggable", "false");
  let imgElements = aElements[i].getElementsByTagName("img");
  for (let j = 0; j < imgElements.length; j++) {
    imgElements[j].setAttribute("draggable", "false");
  }
}

// 显示菜单
rm.showRightMenu = function (isTrue, x = 0, y = 0) {
  console.info(x, y)
  let rightMenu = document.getElementById("rightMenu");
  rightMenu.style.top = x + "px";
  rightMenu.style.left = y + "px";
  if (isTrue) {
    rightMenu.style.display = "block";
    stopMaskScroll();
  } else {
    rightMenu.style.display = "none";
  }
};

// 隐藏菜单
rm.hideRightMenu = function () {
  rm.showRightMenu(false);
  let rightMenuMask = document.querySelector("#rightmenu-mask");
  rightMenuMask.style.display = "none";
};

// 尺寸
let rmWidth = document.getElementById("rightMenu").offsetWidth;
let rmHeight = document.getElementById("rightMenu").offsetHeight;

// 重新定义尺寸
rm.reloadrmSize = function () {
  rightMenu.style.visibility = "hidden";
  rightMenu.style.display = "block";
  // 获取宽度和高度
  rmWidth = document.getElementById("rightMenu").offsetWidth;
  rmHeight = document.getElementById("rightMenu").offsetHeight;
  rightMenu.style.visibility = "visible";
};

// 获取点击的href
let domhref = "";
let domImgSrc = "";
let globalEvent = null;

var oncontextmenuFunction = function (event) {
  if (document.body.clientWidth > 768) {
    let pageX = event.clientX + 10; //加10是为了防止显示时鼠标遮在菜单上
    let pageY = event.clientY;

    //其他额外菜单
    const $rightMenuOther = document.querySelector(".rightMenuOther");
    const $rightMenuPlugin = document.querySelector(".rightMenuPlugin");
    const $rightMenuCopyText = document.querySelector("#menu-copytext");
    const $rightMenuPasteText = document.querySelector("#menu-pastetext");
    const $rightMenuCommentText = document.querySelector("#menu-commenttext");
    const $rightMenuNewWindow = document.querySelector("#menu-newwindow");
    const $rightMenuNewWindowImg = document.querySelector("#menu-newwindowimg");
    const $rightMenuCopyLink = document.querySelector("#menu-copylink");
    const $rightMenuCopyImg = document.querySelector("#menu-copyimg");
    const $rightMenuDownloadImg = document.querySelector("#menu-downloadimg");
    const $rightMenuSearch = document.querySelector("#menu-search");
    const $rightMenuSearchBaidu = document.querySelector("#menu-searchBaidu");
    const $rightMenuMusicToggle = document.querySelector("#menu-music-toggle");
    const $rightMenuMusicBack = document.querySelector("#menu-music-back");
    const $rightMenuMusicForward = document.querySelector("#menu-music-forward");
    const $rightMenuMusicPlaylist = document.querySelector("#menu-music-playlist");
    const $rightMenuMusicCopyMusicName = document.querySelector("#menu-music-copyMusicName");

    let href = event.target.href;
    let imgsrc = event.target.currentSrc;

    // 判断模式 扩展模式为有事件
    let pluginMode = false;
    $rightMenuOther.style.display = "block";
    globalEvent = event;

    // 检查是否需要复制 是否有选中文本
    if (selectTextNow && window.getSelection()) {
      pluginMode = true;
      $rightMenuCopyText.style.display = "block";
      $rightMenuCommentText.style.display = "block";
      $rightMenuSearch.style.display = "block";
      $rightMenuSearchBaidu.style.display = "block";
    } else {
      $rightMenuCopyText.style.display = "none";
      $rightMenuCommentText.style.display = "none";
      $rightMenuSearchBaidu.style.display = "none";
      $rightMenuSearch.style.display = "none";
    }

    //检查是否右键点击了链接a标签
    if (href) {
      pluginMode = true;
      $rightMenuNewWindow.style.display = "block";
      $rightMenuCopyLink.style.display = "block";
      domhref = href;
    } else {
      $rightMenuNewWindow.style.display = "none";
      $rightMenuCopyLink.style.display = "none";
    }

    //检查是否需要复制图片
    if (imgsrc) {
      pluginMode = true;
      $rightMenuCopyImg.style.display = "block";
      $rightMenuDownloadImg.style.display = "block";
      $rightMenuNewWindowImg.style.display = "block";
      document.getElementById("rightMenu").style.width="12rem"
      domImgSrc = imgsrc;
    } else {
      $rightMenuCopyImg.style.display = "none";
      $rightMenuDownloadImg.style.display = "none";
      $rightMenuNewWindowImg.style.display = "none";
    }

    // 判断是否为输入框
    if (event.target.tagName.toLowerCase() === "input" || event.target.tagName.toLowerCase() === "textarea") {
      pluginMode = true;
      $rightMenuPasteText.style.display = "block";
    } else {
      $rightMenuPasteText.style.display = "none";
    }
    const navMusicEl = document.querySelector("#nav-music");
    //判断是否是音乐
    if (navMusicEl && navMusicEl.contains(event.target)) {
      pluginMode = true;
      $rightMenuMusicToggle.style.display = "block";
      $rightMenuMusicBack.style.display = "block";
      $rightMenuMusicForward.style.display = "block";
      $rightMenuMusicPlaylist.style.display = "block";
      $rightMenuMusicCopyMusicName.style.display = "block";
    } else {
      $rightMenuMusicToggle.style.display = "none";
      $rightMenuMusicBack.style.display = "none";
      $rightMenuMusicForward.style.display = "none";
      $rightMenuMusicPlaylist.style.display = "none";
      $rightMenuMusicCopyMusicName.style.display = "none";
    }

    // 如果不是扩展模式则隐藏扩展模块
    if (pluginMode) {
      $rightMenuOther.style.display = "none";
      $rightMenuPlugin.style.display = "block";
    } else {
      $rightMenuPlugin.style.display = "none";
    }

    rm.reloadrmSize();

    // 鼠标默认显示在鼠标右下方，当鼠标靠右或靠下时，将菜单显示在鼠标左方\上方
    if (pageX + rmWidth > window.innerWidth) {
      pageX -= rmWidth + 10;
    }
    if (pageY + rmHeight > window.innerHeight) {
      pageY -= pageY + rmHeight - window.innerHeight;
    }

    rm.showRightMenu(true, pageY, pageX);
    document.getElementById("rightmenu-mask").style.display = "flex";
    return false;
  }
};

// 监听右键初始化
window.oncontextmenu = oncontextmenuFunction

// 下载图片状态
rm.downloadimging = false;

// 复制图片到剪贴板
rm.writeClipImg = function (imgsrc) {
  console.log("按下复制");
  rm.hideRightMenu();
  anzhiyu.snackbarShow("正在下载中，请稍后", false, 10000);
  if (rm.downloadimging == false) {
    rm.downloadimging = true;
    setTimeout(function () {
      copyImage(imgsrc);
      anzhiyu.snackbarShow("复制成功！图片已添加盲水印，请遵守版权协议");
      rm.downloadimging = false;
    }, "10000");
  }
};

function imageToBlob(imageURL) {
  const img = new Image();
  const c = document.createElement("canvas");
  const ctx = c.getContext("2d");
  img.crossOrigin = "";
  img.src = imageURL;
  return new Promise(resolve => {
    img.onload = function () {
      c.width = this.naturalWidth;
      c.height = this.naturalHeight;
      ctx.drawImage(this, 0, 0);
      c.toBlob(
        blob => {
          // here the image is a blob
          resolve(blob);
        },
        "image/png",
        0.75
      );
    };
  });
}

async function copyImage(imageURL) {
  const blob = await imageToBlob(imageURL);
  const item = new ClipboardItem({ "image/png": blob });
  navigator.clipboard.write([item]);
}

rm.copyUrl = function (id) {
  const input = document.createElement("input"); // Create a new <input> element
  input.id = "copyVal"; // Set the id of the new element to "copyVal"
  document.body.appendChild(input); // Append the new element to the end of the <body> element
  
  const text = id;
  input.value = text;
  input.select();
  input.setSelectionRange(0, input.value.length);
  document.execCommand("copy");
  
  input.remove(); // Remove the <input> element from the DOM
};

function stopMaskScroll() {
  if (document.getElementById("rightmenu-mask")) {
    let xscroll = document.getElementById("rightmenu-mask");
    xscroll.addEventListener(
      "mousewheel",
      function (e) {
        //阻止浏览器默认方法
        rm.hideRightMenu();
        // e.preventDefault();
      },
      { passive: true }
    );
  }
  if (document.getElementById("rightMenu")) {
    let xscroll = document.getElementById("rightMenu");
    xscroll.addEventListener(
      "mousewheel",
      function (e) {
        //阻止浏览器默认方法
        rm.hideRightMenu();
        // e.preventDefault();
      },
      { passive: true }
    );
  }
}

rm.rightmenuCopyText = function (txt) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(txt);
  }
  rm.hideRightMenu();
};

rm.copyPageUrl = function (url) {
  if (!url) {
    url = window.location.href;
  }
  rm.copyUrl(url);
  anzhiyu.snackbarShow("复制链接地址成功", false, 2000);
  rm.hideRightMenu();
};

rm.sharePage = function () {
  var content = window.location.href;
  rm.copyUrl(url);
  anzhiyu.snackbarShow("复制链接地址成功", false, 2000);
  rm.hideRightMenu();
};

// 复制当前选中文本
var selectTextNow = "";
document.onmouseup = document.ondblclick = selceText;

function selceText() {
  var txt;
  if (document.selection) {
    txt = document.selection.createRange().text;
  } else {
    txt = window.getSelection().toString();
  }
  selectTextNow = txt !== "" ? txt : "";
}

// 读取剪切板
rm.readClipboard = function () {
  if (navigator.clipboard) {
    navigator.clipboard.readText().then(clipText => rm.insertAtCaret(globalEvent.target, clipText));
  }
};

// 粘贴文本到焦点
rm.insertAtCaret = function (elemt, value) {
  const startPos = elemt.selectionStart,
    endPos = elemt.selectionEnd;
  if (document.selection) {
    elemt.focus();
    var sel = document.selection.createRange();
    sel.text = value;
    elemt.focus();
  } else {
    if (startPos || startPos == "0") {
      var scrollTop = elemt.scrollTop;
      elemt.value = elemt.value.substring(0, startPos) + value + elemt.value.substring(endPos, elemt.value.length);
      elemt.focus();
      elemt.selectionStart = startPos + value.length;
      elemt.selectionEnd = startPos + value.length;
      elemt.scrollTop = scrollTop;
    } else {
      elemt.value += value;
      elemt.focus();
    }
  }
};

//粘贴文本
rm.pasteText = function () {
  const result = rm.readClipboard() || "";
  rm.hideRightMenu();
};

//引用到评论
rm.rightMenuCommentText = function (txt) {
  rm.hideRightMenu();
  const postCommentDom = document.getElementById("post-comment");
  var domTop = postCommentDom.offsetTop;
  window.scrollTo(0, domTop - 80);
  if (txt == "undefined" || txt == "null") txt = "好棒！";
  function setText() {
    setTimeout(() => {
      var input = document.getElementsByClassName("el-textarea__inner")[0];
      if (!input) setText();
      let evt = document.createEvent("HTMLEvents");
      evt.initEvent("input", true, true);
      let inputValue = replaceAll(txt, "\n", "\n> ");
      input.value = "> " + inputValue + "\n\n";
      input.dispatchEvent(evt);
      input.focus();
      input.setSelectionRange(-1, -1);
      if (document.getElementById("comment-tips")) {
        document.getElementById("comment-tips").classList.add("show");
      }
    }, 100);
  }
  setText();
};

//替换所有内容
function replaceAll(string, search, replace) {
  return string.split(search).join(replace);
}

// 百度搜索
rm.searchBaidu = function () {
  anzhiyu.snackbarShow("即将跳转到百度搜索", false, 2000);
  setTimeout(function () {
    window.open("https://www.baidu.com/s?wd=" + selectTextNow);
  }, "2000");
  rm.hideRightMenu();
};

//分享链接
rm.copyLink = function () {
  rm.rightmenuCopyText(domhref);
  anzhiyu.snackbarShow("已复制链接地址");
};

function addRightMenuClickEvent() {
  // 添加点击事件
  document.getElementById("menu-backward").addEventListener("click", function () {
  window.history.back();
    rm.hideRightMenu();
  });

  document.getElementById("menu-forward").addEventListener("click", function () {
    window.history.forward();
    rm.hideRightMenu();
  });

  document.getElementById("menu-refresh").addEventListener("click", function () {
    window.location.reload();
  });

  document.getElementById("menu-top").addEventListener("click", function () {
    anzhiyu.scrollToDest(0, 500);
    rm.hideRightMenu();
  });

  const menuLinks = document.querySelectorAll(".menu-link");
  menuLinks.forEach(function (link) {
    link.addEventListener("click", rm.hideRightMenu);
  });

  document.getElementById("menu-darkmode").addEventListener("click", anzhiyu.switchDarkMode);

  document.getElementById("menu-home") && document.getElementById("menu-home").addEventListener("click", function () {
    window.location.href = window.location.origin;
  });

  document.getElementById("menu-randomPost").addEventListener("click", function () {
    toRandomPost();
  });

  document.getElementById("menu-commentBarrage").addEventListener("click", anzhiyu.switchCommentBarrage);

  document.getElementById("rightmenu-mask").addEventListener("click", rm.hideRightMenu);

  document.getElementById("rightmenu-mask").addEventListener("contextmenu", function (event) {
    rm.hideRightMenu();
    event.preventDefault(); // Prevent the default context menu from appearing
  });

  document.getElementById("menu-copy").addEventListener("click", rm.copyPageUrl);

  document.getElementById("menu-pastetext").addEventListener("click", rm.pasteText);

  document.getElementById("menu-copytext").addEventListener("click", function () {
    rm.rightmenuCopyText(selectTextNow);
    anzhiyu.snackbarShow("复制成功，复制和转载请标注本文地址");
  });

  document.getElementById("menu-commenttext").addEventListener("click", function () {
    rm.rightMenuCommentText(selectTextNow);
  });

  document.getElementById("menu-newwindow").addEventListener("click", function () {
    window.open(domhref, "_blank");
    rm.hideRightMenu();
  });

  document.getElementById("menu-copylink").addEventListener("click", rm.copyLink);

  document.getElementById("menu-downloadimg").addEventListener("click", function () {
    anzhiyu.downloadImage(domImgSrc, "anzhiyu");
  });

  document.getElementById("menu-newwindowimg").addEventListener("click", function () {
    window.open(domImgSrc, "_blank");
    rm.hideRightMenu();
  });

  document.getElementById("menu-copyimg").addEventListener("click", function () {
    rm.writeClipImg(domImgSrc);
  });

  document.getElementById("menu-searchBaidu").addEventListener("click", rm.searchBaidu);

  //音乐
  document.getElementById("menu-music-toggle").addEventListener("click", anzhiyu.musicToggle);

  document.getElementById("menu-music-back").addEventListener("click", anzhiyu.musicSkipBack);

  document.getElementById("menu-music-forward").addEventListener("click", anzhiyu.musicSkipForward);

  document.getElementById("menu-music-copyMusicName").addEventListener("click", function () {
    rm.rightmenuCopyText(anzhiyu.musicGetName());
    anzhiyu.snackbarShow("复制歌曲名称成功", false, 3000);
  });

}

addRightMenuClickEvent();</script><script data-pjax>var themeColorMeta = document.querySelector('meta[name="theme-color"]');
var pageHeaderEl = document.getElementById("page-header");
var navMusicEl = document.getElementById("nav-music");
var consoleEl = document.getElementById("console");
// 已随机的歌曲
var selectRandomSong = [];
// 音乐默认声音大小
var musicVolume = 0.8;
// 是否切换了周杰伦音乐列表
var changeMusicListFlag = false;
// 当前默认播放列表
var defaultPlayMusicList = [];

document.getElementById("page-name").innerText = document.title.split(" | 故梦")[0];
anzhiyu.initIndexEssay();
anzhiyu.changeTimeInEssay();
anzhiyu.removeBodyPaceClass();
anzhiyu.qrcodeCreate();
anzhiyu.changeTimeInAlbumDetail();
anzhiyu.reflashEssayWaterFall();
anzhiyu.sayhi();
anzhiyu.stopImgRightDrag();
anzhiyu.addNavBackgroundInit();
anzhiyu.setValueToBodyType();
anzhiyu.catalogActive();
anzhiyu.tagsPageActive();
anzhiyu.categoriesBarActive();
anzhiyu.topCategoriesBarScroll();
anzhiyu.switchRightClickMenuHotReview();
anzhiyu.getCustomPlayList();
anzhiyu.addEventListenerConsoleMusicList(false);
setTimeout(() => {if (typeof addFriendLinksInFooter === "function") {addFriendLinksInFooter();}}, 200)</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script>window.$crisp = [];
window.CRISP_WEBSITE_ID = "6184fae4-c3d3-4e67-91f8-748ac212beaf";
(function () {
  d = document;
  s = d.createElement("script");
  s.src = "https://client.crisp.chat/l.js";
  s.async = 1;
  d.getElementsByTagName("head")[0].appendChild(s);
})();
$crisp.push(["safe", true])

if (true) {
  $crisp.push(["do", "chat:hide"])
  $crisp.push(["on", "chat:closed", function() {
    $crisp.push(["do", "chat:hide"])
  }])
  var chatBtnFn = () => {
    var chatBtn = document.getElementById("chat_btn")
    chatBtn.addEventListener("click", function(){
      $crisp.push(["do", "chat:show"])
      $crisp.push(["do", "chat:open"])

    });
  }
  chatBtnFn()
} else {
  if (true) {
    function chatBtnHide () {
      $crisp.push(["do", "chat:hide"])
    }
    function chatBtnShow () {
      $crisp.push(["do", "chat:show"])
    }
  }
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div></body></html>